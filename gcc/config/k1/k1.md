(define_attr "length" ""
         (const_int 4))

;; Only support Coolidge, but keep flexibility as long as it does not
;; cost too much

(define_attr "arch" "coolidge" (const (symbol_ref "k1_arch_schedule")))

(define_attr "only_64b" "yes,no" (const_string "no"))

;; (define_attr "enabled" ""
;;   (cond [(eq_attr "only_64b" "no") (const_int 1)
;;          (and (eq_attr "only_64b" "yes")
;;               (ne (symbol_ref "TARGET_64") (const_int 0)))
;;          (const_int 1)]
;;         (const_int 0)))
;; 
	
(define_c_enum "unspec"
  [     UNSPEC_BFX
        UNSPEC_BFX_PS
        UNSPEC_BARRIER
        UNSPEC_SCALL
        UNSPEC_DPURGE
        UNSPEC_DPURGEL
        UNSPEC_DINVALL
        UNSPEC_LDC
        UNSPEC_ALDC
        UNSPEC_GET
        UNSPEC_SET
        UNSPEC_SET_PS
        UNSPEC_SETCARRY
        UNSPEC_STSU
        UNSPEC_IINVALL
        UNSPEC_DFLUSH
        UNSPEC_SBMM8
        UNSPEC_SBMM8L
        UNSPEC_SBMMT8
        UNSPEC_BWLUHP
        UNSPEC_BWLUWP
        UNSPEC_TLS
        UNSPEC_LDD
        UNSPEC_SDD
        UNSPEC_DINVAL
        UNSPEC_IINVAL
        UNSPEC_DFLUSHL
        UNSPEC_DTOUCHL
        UNSPEC_DZEROL
        UNSPEC_LDU
        UNSPEC_ITOUCHL
        UNSPEC_WAITANY
        UNSPEC_WAITALL
        UNSPEC_WANTANY
        UNSPEC_RAISE
        UNSPEC_NOTIFY
        UNSPEC_CLEAR
        UNSPEC_STSUD
        UNSPEC_RXOR
        UNSPEC_CDS
        UNSPEC_FSDIV
        UNSPEC_FSISR
        UNSPEC_FSDIVD
        UNSPEC_FSISRD
        UNSPEC_FSDIVWP
        UNSPEC_FSISRWP
        UNSPEC_LBQS
        UNSPEC_LBQSU
        UNSPEC_LBQZ
        UNSPEC_LBQZU
        UNSPEC_LBSU
        UNSPEC_LBZU
        UNSPEC_LHSU
        UNSPEC_LHZU
        UNSPEC_ADDHP
        UNSPEC_ABDHP
        UNSPEC_WPURGE
        UNSPEC_FCMA
        UNSPEC_FDMS
        UNSPEC_SBFHP
        UNSPEC_SLLHPS
        UNSPEC_SRAHPS
        UNSPEC_LANDHP
        UNSPEC_SYNC
        UNSPEC_HFXT
        UNSPEC_HFXT_PS
        UNSPEC_HFXB
        UNSPEC_HFXB_PS
        UNSPEC_FDMAWD
        UNSPEC_FDMA
        UNSPEC_FDMSWD
        UNSPEC_FCMAWD
        UNSPEC_FCMSWD
        UNSPEC_FCMS
        UNSPEC_LWZU
        UNSPEC_SYNCGROUP
        UNSPEC_BWLU
        UNSPEC_LOOPDO
        UNSPEC_LOOPDO_END
        UNSPEC_ACWS
        UNSPEC_CWS
        UNSPEC_AFDA
        UNSPEC_AFDAU
        UNSPEC_LOAD
        UNSPEC_FPRN
        UNSPEC_FCDIV
        UNSPEC_FSINV
        UNSPEC_FSINVN
        UNSPEC_FCDIVD
        UNSPEC_FSINVD
        UNSPEC_FSINVND
        UNSPEC_FCDIVWP
        UNSPEC_FSINVWP
        UNSPEC_FSINVNWP
        UNSPEC_INVALDTLB
        UNSPEC_INVALITLB
        UNSPEC_PROBETLB
        UNSPEC_READTLB
        UNSPEC_WRITETLB
        UNSPEC_CLEAR1
        UNSPEC_NOTIFY1
        UNSPEC_RAISE1
        UNSPEC_WAITCLR1
        UNSPEC_ABD
        UNSPEC_FENCE
        UNSPEC_FLOAT
        UNSPEC_FLOATU
        UNSPEC_FIXED
        UNSPEC_FIXEDU
        UNSPEC_PIC
        UNSPEC_GOT
        UNSPEC_GOTOFF
;;        UNSPEC_FUNCDESC_GOT
;;        UNSPEC_FUNCDESC_GOTOFF
        UNSPEC_PCREL
        UNSPEC_GPREL
        UNSPEC_GETCARRY
        UNSPEC_ADDCD
        UNSPEC_GPREL10
        UNSPEC_FDPIC_RELOAD
        UNSPEC_SAT
	UNSPEC_ABDHQ
	UNSPEC_FWIDENB
	UNSPEC_FWIDENBWP
	UNSPEC_FWIDENT
	UNSPEC_FWIDENTWP
	UNSPEC_FNARROWH
	UNSPEC_LHPZ
	UNSPEC_LHPZU
	UNSPEC_LHPZN
	UNSPEC_LHPZUN

   ]
)

(define_constants [
         (CS_REGNO 72)
])

;; Iterators
(include "iterators.md")

;; Instruction classification types
(include "types.md")

;; Scheduling classes
;;(include "andey.md")
;;(include "bostan.md")
(include "coolidge.md")

;; Constraints
(include "constraints.md")

;; Predicates
(include "predicates.md")


;; lsu_load,lsu_load_x,lsu_store,lsu_store_x
;; (define_attr "enabled" ""
;;   (cond [
;;          (and (eq_attr "type" "lsu_load")
;;               (eq (symbol_ref "K1_FORCE_UNCACHED_LSU") (const_int 1)))
;; 	 (const_int 0)
;; 
;;          (and (eq_attr "type" "lsu_load_x")
;;               (eq (symbol_ref "K1_FORCE_UNCACHED_LSU") (const_int 1)))
;; 	 (const_int 0)
;; 
;;          (and (eq_attr "type" "lsu_store")
;;               (eq (symbol_ref "K1_FORCE_UNCACHED_LSU") (const_int 1)))
;; 	 (const_int 0)
;; 
;;          (and (eq_attr "type" "lsu_store_x")
;;               (eq (symbol_ref "K1_FORCE_UNCACHED_LSU") (const_int 1)))
;; 	 (const_int 0)
;;         ]
;;         (const_int 1)))


;; -------------------------------------------------------------------
;; Moves
;; -------------------------------------------------------------------


;; Only used when K1_FORCE_UNCACHED_LSU is used

;; general insn for materializing symbol in paired register
;; Will also capture more complex move : @gotoff('sym' + offset)

;;  (define_insn "*movdi_real_immediate"
;;     [(set (match_operand:DI 0 "register_operand"   "=r,  r,   r")
;;           (match_operand:DI 1 "const_int_operand" "I16, I43, i"))]
;;   "1"
;;  {
;;   switch(which_alternative){
;;   case 0:
;;   case 1:
;;        return "maked %0 = %1";
;;   case 2:
;;        return "maked %d0 = %d1";
;;   default : gcc_unreachable ();
;;   }
;;  }
;;  [(set_attr "type" "alud_tiny,alud_tiny_x,alud_z")
;;   (set_attr "length" "4,8,16")])
;; 
;;  (define_insn "*movdi_real_k1b"
;;     [(set (match_operand:DI 0 "nonimmediate_operand" "=r, r, r, a, m")
;;           (match_operand:DI 1 "general_operand"      " r, a, m, r, r"))]
;;     "   1
;;      && !(immediate_operand(operands[1], DImode) && memory_operand(operands[0], DImode))
;;      && !(memory_operand(operands[0], DImode) && memory_operand(operands[1], DImode))
;;      && !((memory_operand(operands[0], DImode) || memory_operand(operands[1], DImode)) && K1_FORCE_UNCACHED_LSU)"
;;  {
;;   switch(which_alternative){
;;   case 0:
;;        return "copyd %0 = %1";
;;   case 1:
;;   case 2:
;;        return "ld%m1 %0 = %1";
;;   case 3:
;;   case 4:
;;        return "sd%m0 %0 = %1";
;;   default : gcc_unreachable ();
;;   }
;;  }
;;  [(set_attr "type" "alud_lite, lsu_load, lsu_load_x, lsu_store, lsu_store_x")
;;   (set_attr "length" "4,4,8,4,8")])
 

(define_expand "mov<mode>"
  [(set (match_operand:ALLIF 0 "nonimmediate_operand" "")
	(match_operand:ALLIF 1 "general_operand" ""))]
  ""
  "
    if (GET_CODE (operands[0]) == MEM)
      operands[1] = force_reg (<MODE>mode, operands[1]);

 /*   if (<MODE>mode == Pmode && CONSTANT_P (operands[1]))
      {
	k1_expand_mov_immediate (operands[0], operands[1]);
	DONE;
      }
*/
/*
 * FIXME AUTO: reenable k1_expand_mov
 *	if (k1_expand_mov (operands)) {
 *	   DONE;
 *	}
 */

  "
)

(define_insn "*mov<mode>_reg_k1c"
   [(set (match_operand:ALLI 0 "nonimmediate_operand"  "=r, r  , r,   r, r,   RXX, r, r, a, m, r, r, a, m")
         (match_operand:ALLI 1 "general_operand"   " r, I16, I43, i, RXX, r,   a, m, r, r, a, m, r, r"))]
   "register_operand(operands[0], <MODE>mode) || register_operand(operands[1], <MODE>mode)"
{
    switch (which_alternative) {
    	   case 0: return "copyd %0 = %1";
           case 1:
    	   case 2:
    	   case 3: return "make %0 = %1";
	   case 4: return "get %0 = %1";
	   case 5: return "set %0 = %1";

	   case 6:
    	   case 7: return "l<lsusize><lsusext>%m1 %0 = %1";
	   case 8:
    	   case 9: return "s<lsusize>%m0 %0 = %1";

	   case 10:
    	   case 11: return "l<lsusize><lsusext>u%m1 %0 = %1";
	   case 12:
    	   case 13: return "s<lsusize>u%m0 %0 = %1";

	   default: gcc_unreachable ();
    }
}
;; FIXME AUTO: reservations for coolidge are not OK
[(set_attr "type" "tiny,tiny, tiny_x,tiny_x,bcu_get,bcu,lsu_load,lsu_load_x,lsu_store,lsu_store_x,lsu_load_uncached,lsu_load_uncached_x,lsu_store_uncached,lsu_store_uncached_x")
 (set_attr "length" "4,4,8,16,4,4,4,8,4,8,4,8,4,8")]
)


;; (define_insn "*mov<mode>_memcached_k1c"
;;    [(set (match_operand:ALLIF 0 "nonimmediate_operand" "=r, r, a, m")
;;          (match_operand:ALLIF 1 "nonimmediate_operand" " a, m, r, r"))]
;;    "!K1_FORCE_UNCACHED_LSU
;;    && (register_operand(operands[0], <MODE>mode) || register_operand(operands[1], <MODE>mode))"
;; {
;;     switch (which_alternative) {
;; 	   case 0:
;;     	   case 1: return "l<lsusize><lsusext>%m1 %0 = %1";
;; 	   case 2:
;;     	   case 3: return "s<lsusize>%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; ;; FIXME AUTO: reservations for coolidge are not OK
;; [(set_attr "type" "lsu_load,lsu_load_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_insn "*mov<mode>_uncached_k1c"
;;    [(set (match_operand:ALLIF 0 "nonimmediate_operand" "=r, r, a, m")
;;          (match_operand:ALLIF 1 "nonimmediate_operand" " a, m, r, r"))]
;;    "K1_FORCE_UNCACHED_LSU
;;    && (register_operand(operands[0], <MODE>mode) || register_operand(operands[1], <MODE>mode))"
;; {
;;     switch (which_alternative) {
;; 	   case 0:
;;     	   case 1: return "l<lsusize><lsusext>u%m1 %0 = %1";
;; 	   case 2:
;;     	   case 3: return "s<lsusize>u%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; ;; FIXME AUTO: reservations for coolidge are not OK
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; Float

(define_insn "*mov<mode>_reg_k1c"
   [(set (match_operand:ALLF 0 "nonimmediate_operand"  "=r, r  , r,   r, r, r, a, m, r, r, a, m")
         (match_operand:ALLF 1 "general_operand" " r, H16, H43, F, a, m, r, r, a, m, r, r"))]
   ""
{
    switch (which_alternative) {
    	   case 0: return "copyd %0 = %1";
           case 1:
    	   case 2:
    	   case 3: return "make %0 = %1";

	   case 4:
    	   case 5: return "l<lsusize><lsusext>%m1 %0 = %1";
	   case 6:
    	   case 7: return "s<lsusize>%m0 %0 = %1";

	   case 8:
    	   case 9: return "l<lsusize><lsusext>u%m1 %0 = %1";
	   case 10:
    	   case 11: return "s<lsusize>u%m0 %0 = %1";

	   default: gcc_unreachable ();
    }
}
;; FIXME AUTO: reservations for coolidge are not OK
[(set_attr "type" "tiny,tiny,tiny_x,tiny_x,lsu_load,lsu_load_x,lsu_store,lsu_store_x,lsu_load_uncached,lsu_load_uncached_x,lsu_store_uncached,lsu_store_uncached_x")
 (set_attr "length" "4,4,8,16,4,8,4,8,4,8,4,8")]
)


(define_insn "jump"
  [(set (pc) (label_ref (match_operand 0)))]
  ""
  "goto %0"
[(set_attr "type" "bcu")]
)

(define_expand "indirect_jump"
  [(set (pc) (match_operand 0 "address_operand"))])

(define_insn "*indirect_jump_<mode>"
  [(set (pc) (match_operand:P 0 "address_operand" "r"))]
  ""
  "igoto %0"
[(set_attr "type" "bcu")]
)

(define_expand "tablejump"
  [(set (pc)
	(match_operand:SI 0 "register_operand"))
   (use (label_ref (match_operand 1 "")))]
  "!flag_pic || can_create_pseudo_p ()"
{
        if (flag_pic) {
               rtx (*gen_add) (rtx target, rtx op1, rtx op2) = TARGET_64 ? gen_adddi3 : gen_addsi3;

	       /*
	        * loaded index is relative to label
		*/
	       rtx tmp_reg = gen_reg_rtx(Pmode);
	       rtx label_reg = gen_reg_rtx(Pmode);
	       emit_move_insn(label_reg, gen_rtx_LABEL_REF(Pmode, operands[1]));

	       emit_insn(gen_add(tmp_reg, label_reg, operands[0]));

	       operands[0] = tmp_reg;
        }

	if (TARGET_64) {
		emit_jump_insn (gen_tablejump_real_di (operands[0], operands[1]));
	} else {
		emit_jump_insn (gen_tablejump_real_si (operands[0], operands[1]));
	}

        DONE;
})

(define_insn "tablejump_real_<mode>"
  [(parallel [(set (pc)
                   (match_operand:P 0 "register_operand" "r"))
              (use (label_ref (match_operand 1 "")))]
  )]
  "<MODE>mode != DImode || TARGET_64" 
  "igoto %0"
[(set_attr "type" "bcu")]
)

(define_insn "nop"
  [(const_int 0)]
  ""
  "nop"
[(set_attr "type" "all")]
)

(define_expand "allocate_stack"
[(use (match_operand 0 "" ""))
 (use (match_operand 1 "" ""))]
 "can_create_pseudo_p () && flag_stack_check == FULL_BUILTIN_STACK_CHECK"
{
        k1_expand_stack_check_allocate_stack (operands[0], operands[1]);
        DONE;
})

(define_expand "addsi3"
  [(set (match_operand:SI 0 "register_operand" "")
	(plus:SI (match_operand:SI 1 "register_operand" "")
		 (match_operand:SI 2 "nonmemory_operand" "")))]
  ""
{
/*
 *	if (!small_operand (operands[2], SImode))
 *	   if (! (reload_completed || reload_in_progress))
 *	      operands[2] = force_reg (SImode, operands[2]);
 */
}
)

;; FIXME AUTO: no more immediate for 32b add
(define_insn "*addsi3_hack_64b"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(plus:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "immediate_operand" "i")))]
  ""
  "addd %0 = %1, %2"
[(set_attr "type" "tiny")]
)

(define_insn "*add_x"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(plus:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand 2 "immediate_operand" "i")))]
  "current_pass->tv_id != TV_CPROP"
  "add %0 = %1, %2"
[(set_attr "type" "tiny_x")
 (set_attr "length" "8")]
)

(define_insn "addc"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(plus:SI (plus:SI (match_operand:SI 1 "register_operand" "r")
		          (match_operand:SI 2 "register_operand" "r"))
                 (unspec:SI [(reg:SI CS_REGNO)] UNSPEC_GETCARRY)))
   (set (reg:SI CS_REGNO) (unspec:SI [(reg:SI CS_REGNO)
                                      (match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "addc %0 = %1, %2"
[(set_attr "type" "alu_full_odd")
 (set_attr "length" "4")]
)

(define_insn "addci"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(plus:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "register_operand" "r")))
   (set (reg:SI CS_REGNO) (unspec:SI [(match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "addci %0 = %1, %2"
[(set_attr "type" "alu_full_odd")
 (set_attr "length" "4")]
)

(define_insn "addcd"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(plus:DI (plus:DI (match_operand:DI 1 "register_operand" "r")
		          (match_operand:DI 2 "nonmemory_operand" "r"))
                 (unspec:DI [(reg:SI CS_REGNO)] UNSPEC_GETCARRY)))
   (set (reg:SI CS_REGNO) (unspec:SI [(reg:SI CS_REGNO)
                                      (match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "addcd %0 = %1, %2"
[(set_attr "type" "alud_full_odd_x")
 (set_attr "length" "8")]
)

(define_insn "*split_addcd"
  [(set (match_operand:SI 0 "register_operand" "=r")
        (unspec:SI [(match_operand:SI 2 "register_operand" "r")
                    (match_operand:SI 3 "register_operand" "r")
                    (match_operand:SI 4 "register_operand" "r")
                    (match_operand:SI 5 "register_operand" "r")
                    (unspec:SI [(reg:SI CS_REGNO)] UNSPEC_GETCARRY)] UNSPEC_ADDCD))
   (set (match_operand:SI 1 "register_operand" "=r")
        (unspec:SI [(match_dup 2)
                    (match_dup 3)
                    (match_dup 4)
                    (match_dup 5)
                    (unspec:SI [(reg:SI CS_REGNO)] UNSPEC_GETCARRY)] UNSPEC_ADDCD))
   (set (reg:SI CS_REGNO) (unspec:SI [(reg:SI CS_REGNO)
                                      (match_dup 2)
                                      (match_dup 3)
                                      (match_dup 4)
                                      (match_dup 5)] UNSPEC_SETCARRY))
  ]
  ""
  "addcd %0:%1 = %2:%3, %4:%5"
[(set_attr "type" "alud_full_odd_x")
 (set_attr "length" "8")]
)

(define_insn "addcid"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(plus:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "nonmemory_operand" "r")))
   (set (reg:SI CS_REGNO) (unspec:SI [(match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "addcid %0 = %1, %2"
[(set_attr "type" "alud_full_odd_x")
 (set_attr "length" "8")])


;; FIXME AUTO: correctly enable/disable symbol constraint wrt TARGET_64
(define_insn "adddi3"
  [(set (match_operand:DI 0 "register_operand" "=r,r,r")
	(plus:DI (match_operand:DI 1 "register_operand" "r,r,r")
		 (match_operand:DI 2 "nonmemory_operand" "r,I10,D37")))]
""
"addd %0 = %1, %2"
[(set_attr "type" "alud_lite,alud_lite,alud_lite_x")
 (set_attr "length" "4,4,8")])

;; prevent the use of symbol in addd when in 64bits mode where
;; a relocation would not fit.
;; Materialise symbol in a reg before addd
(define_split
  [(set (match_operand:DI 0 "register_operand" )
	(plus:DI (match_operand:DI 1 "register_operand")
		 (match_operand:DI 2 "k1_symbol_operand")))]
"TARGET_64 && !reload_completed"
[(set (match_dup 3)
      (match_dup 2))
 (set (match_dup 0)
      (plus:DI (match_dup 3) (match_dup 1)))]
"operands[3] = gen_reg_rtx(DImode);"
)

(define_insn "sub<mode>3_x2"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	         (ashift:I (match_operand:I 2 "register_operand" "r")
                           (const_int 1))))]
  ""
  "sbfx2<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "sub<mode>3_mult_x2"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	         (mult:I (match_operand:I 2 "register_operand" "r")
		         (const_int 2))))]
  ""
  "sbfx2<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "sub<mode>3_x4"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	          (ashift:I (match_operand:I 2 "register_operand" "r")
		             (const_int 2))))]
  ""
  "sbfx4<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "sub<mode>3_mult_x4"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	          (mult:I (match_operand:I 2 "register_operand" "r")
		           (const_int 4))))]
  ""
  "sbfx4<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "sub<mode>3_x8"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	          (ashift:I (match_operand:I 2 "register_operand" "r")
		             (const_int 3))))]
  ""
  "sbfx8<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "sub<mode>3_mult_x8"
  [(set (match_operand:I 0 "register_operand" "=r")
	(minus:I (match_operand:I 1 "register_operand" "r")
	          (mult:I (match_operand:I 2 "register_operand" "r")
		           (const_int 8))))]
  ""
  "sbfx8<I:suffix> %0 = %2, %1"
[(set_attr "type" "<I:sbfx_resrv>")
 (set_attr "length" "4")])

(define_insn "subsi3"
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
	(minus:SI (match_operand:SI 1 "nonmemory_operand" "r,I10,i")
	          (match_operand:SI 2 "register_operand" "r,r,r")))]
  ""
  "sbf %0 = %2, %1"
[(set_attr "type" "tiny,tiny,tiny_x")
 (set_attr "length" "4,4,8")])
  
(define_insn "subdi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(minus:DI (match_operand:DI 1 "register_operand" "r")
 		  (match_operand:DI 2 "register_operand" "r")))]
  ""
  "sbf %0 = %2, %1"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "mulsi3"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r,r")
	(mult:SI (match_operand:SI 1 "register_operand" "r,r,r,r")
		 (match_operand:SI 2 "nonmemory_operand" "r,I10,I32,s")))]
  ""
  "mulwd %0 = %1, %2"
[(set_attr "type" "mau,mau,mau_x,mau_x")
 (set_attr "length" "4,4,8,8")]
)

(define_expand "mulsidi3"
  [(set (match_operand:DI 0 "register_operand" )
	(mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand"))
		 (match_operand:SI 2 "nonmemory_operand" )))]
""
{
 if(!CONST_INT_P(operands[2])) {
        operands[2] = gen_rtx_SIGN_EXTEND(DImode, operands[2]);
}})

(define_insn "*mulsidi3_reg"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r"))
		 (sign_extend:DI (match_operand:SI 2 "register_operand" "r"))))]
  ""
  "mulwd %0 = %1, %2"
[(set_attr "type" "mau")
 (set_attr "length" "4")])

(define_insn "*mulsidi3_imm"
  [(set (match_operand:DI 0 "register_operand" "=r,r,r")
	(mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r,r,r"))
		 (match_operand:SI 2 "immediate_operand" "I10,I32,s")))]
  ""
  "mulwd %0 = %1, %2"
[(set_attr "type" "mau,mau_x,mau_x")
 (set_attr "length" "4,8,8")])

(define_expand "umulsidi3"
  [(set (match_operand:DI 0 "register_operand" )
	(mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" ))
		 (match_operand:SI 2 "unsigned_mul_reg_or_immediate" )))]
  ""
  {
   if(!CONST_INT_P(operands[2])) {
        operands[2] = gen_rtx_ZERO_EXTEND(DImode, operands[2]);
   }
  })

(define_insn "*umulsidi3_reg"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r"))
		 (zero_extend:DI (match_operand:SI 2 "register_operand" "r"))))]
  ""
  "muluuwd %0 = %1, %2"
[(set_attr "type" "mau")
 (set_attr "length" "4")])

(define_insn "*umulsidi3_imm"
  [(set (match_operand:DI 0 "register_operand" "=r,r,r")
	(mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r,r,r"))
		 (match_operand 2 "immediate_unsigned_32bits_operand" "J10,U32,s")))]
  ""
  "@
muluuwd %0 = %1, %j2
muluuwd %0 = %1, %2
muluuwd %0 = %1, %2"
[(set_attr "type" "mau,mau_x,mau_x")
 (set_attr "length" "4,8,8")])

;; NOT SURE WHY WE HAVE THIS
;; (define_insn "*umulsidi3_imm"
;;   [(set (match_operand:DI 0 "register_operand" "=r,r")
;; 	(mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r,r"))
;; 		 (match_operand 2 "positive_immediate_operand" "J10,U32")))]
;;   ""
;;   "@
;;   muluuwd %0 = %1, %j2
;;   muluuwd %0 = %1, %u2"
;; [(set_attr "type" "mau,mau_x")
;;  (set_attr "length" "4,8")])

(define_expand "usmulsidi3"
  [(set (match_operand:DI 0 "register_operand")
	(mult:DI (match_operand:SI 1 "nonmemory_operand")
		 (sign_extend:DI (match_operand:SI 2 "register_operand"))))]
  ""
  {
   if(!CONST_INT_P(operands[1])) {
        operands[1] = gen_rtx_ZERO_EXTEND(DImode, operands[1]);
   }
  })

(define_insn "*usmulsidi3_imm"
  [(set (match_operand:DI 0 "register_operand" "=r,r,r")
	(mult:DI 
                 (sign_extend:DI (match_operand:SI 2 "register_operand" "r,r,r"))
		 (match_operand:SI 1 "unsigned_mul_immediate" "J10,U32,s")))]
""
"@
mulsuwd %0 = %2, %j1
mulsuwd %0 = %2, %1
mulsuwd %0 = %2, %1"
[(set_attr "type" "mau,mau_x,mau_x")
 (set_attr "length" "4,8,8")])

(define_insn "*usmulsidi3_reg"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r"))
		 (sign_extend:DI (match_operand:SI 2 "register_operand" "r"))))]
  ""
  "mulsuwd %0 = %2, %1"
[(set_attr "type" "mau")
 (set_attr "length" "4")]
)

;; FIXME AUTO: disabling multiply to get MSB
;; (define_expand "umulsi3_highpart"
;;   [(set (match_operand:SI 0 "register_operand" )
;;         (truncate:SI
;;            (lshiftrt:DI
;;                 (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand"))
;;                          (match_operand:SI 2 "register_operand" ))
;;                 (const_int 32))))]
;; ""
;; {
;;  if(!CONST_INT_P(operands[2])) {
;;       operands[2] = gen_rtx_ZERO_EXTEND(DImode, operands[2]);
;;  }
;; })
;; 
;; (define_insn "*umulsi3_highpart_reg"
;;   [(set (match_operand:SI 0 "register_operand" "=r")
;;           (truncate:SI
;;            (lshiftrt:DI
;;             (mult:DI (zero_extend:DI
;;                       (match_operand:SI 1 "register_operand" "r"))
;;                      (zero_extend:DI
;;                       (match_operand:SI 2 "register_operand" "r")))
;;             (const_int 32))))]
;;   ""
;;   "muluuwdm %0 = %1, %2"
;; [(set_attr "type" "mau")
;;  (set_attr "length" "4")]
;; )
;; 
;; (define_insn "*umulsi3_highpart_imm"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;;           (truncate:SI
;;            (lshiftrt:DI
;;             (mult:DI (zero_extend:DI
;;                       (match_operand:SI 1 "register_operand" "r,r,r"))
;;                       (match_operand:SI 2 "register_operand" "I10,I32,s"))
;;             (const_int 32))))]
;;   ""
;;   "muluuwdm %0 = %1, %2"
;; [(set_attr "type" "mau,mau_x,mau_x")
;;  (set_attr "length" "4,8,8")]
;; )
;; 
;; (define_expand "umuldi3_highpart"
;;   [(set (match_operand:DI 0 "register_operand" "")
;;           (truncate:DI
;;            (lshiftrt:TI
;;             (mult:TI (zero_extend:TI
;;                       (match_operand:DI 1 "register_operand" ""))
;;                      (zero_extend:TI
;;                       (match_operand:DI 2 "register_operand" "")))
;;             (const_int 64))))]
;;   ""
;; {
;; /*
;;  mult_u64_u64_u64msb:
;;  muluuwd $r4r5 = $r0, $r3 
;;  ;;
;;  maduuciwd $r4r5 = $r1, $r2
;;  ;;
;;  muluuwdm $r0 = $r0, $r2
;;  make $r7 = 0
;;  ;;
;;  addc $r7 = $r7, $r7
;;  muluuwd $r2r3 = $r1, $r3
;;  ;;
;;  addci $r1 = $r0, $r4
;;  ;;
;;  addcd $r0:$r1 = $r2:$r3, $r5:$r7
;;  ret
;;  ;; */
;; 
;;         rtx tmp1 = gen_reg_rtx (DImode);
;;         rtx zero = gen_reg_rtx (SImode);
;;         rtx tmp2 = gen_reg_rtx (SImode);
;;         rtx tmp3 = gen_reg_rtx (DImode);
;;         rtx tmp4 = gen_reg_rtx (SImode);
;;         rtx tmp5 = gen_reg_rtx (SImode);
;;         rtx tmp6 = gen_reg_rtx (DImode);
;; 
;;         emit_move_insn(zero, const0_rtx);
;;         emit_insn (gen_umulsidi3 (tmp1, gen_lowpart(SImode, operands[1]), gen_highpart(SImode, operands[2])));
;;         emit_insn (gen_maduuciwd (tmp1, gen_highpart(SImode, operands[1]), gen_lowpart(SImode, operands[2])));
;;         emit_insn (gen_umulsi3_highpart (tmp5, gen_lowpart(SImode, operands[1]), gen_lowpart (SImode, operands[2])));
;;         emit_insn (gen_addc (tmp2, zero, zero));
;;         emit_insn (gen_umulsidi3 (tmp6, gen_highpart(SImode, operands[1]), gen_highpart(SImode, operands[2])));
;;         emit_insn (gen_addci (tmp4, tmp5, gen_lowpart(SImode, tmp1)));
;; 
;;         emit_insn (gen_rtx_CLOBBER (DImode, tmp3));
;;         emit_move_insn (gen_lowpart (SImode, tmp3), gen_highpart (SImode, tmp1));
;;         emit_move_insn (gen_highpart (SImode, tmp3), tmp2);
;;         
;;         emit_insn (gen_addcd (operands[0], tmp6, tmp3));
;;         DONE;
;; })
;; 
;; (define_expand "smulsi3_highpart"
;;   [(set (match_operand:SI 0 "register_operand" "")
;;           (truncate:SI
;;            (lshiftrt:DI
;;             (mult:DI (sign_extend:DI
;;                       (match_operand:SI 1 "register_operand" ""))
;;                       (match_operand 2 "nonmemory_operand" ""))
;;             (const_int 32))))]
;;   ""
;;   {
;;      if (!CONST_INT_P(operands[2])){
;;         operands[2] = gen_rtx_SIGN_EXTEND(DImode, operands[2]);
;;      }
;;   }
;; )
;; 
;; (define_insn "*smulsi3_highpart_reg"
;;   [(set (match_operand:SI 0 "register_operand" "=r")
;;           (truncate:SI
;;            (lshiftrt:DI
;;             (mult:DI (sign_extend:DI
;;                       (match_operand:SI 1 "register_operand" "r"))
;;                      (sign_extend:DI
;;                       (match_operand:SI 2 "register_operand" "r")))
;;             (const_int 32))))]
;;   ""
;;   "mulwdm %0 = %1, %2"
;; [(set_attr "type" "mau")
;;  (set_attr "length" "4")]
;; )
;; 
;; (define_insn "*smulsi3_highpart_immediate"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;;           (truncate:SI
;;            (lshiftrt:DI
;;             (mult:DI (sign_extend:DI
;;                       (match_operand:SI 1 "register_operand" "r,r,r"))
;;                       (match_operand    2 "immediate_operand" "I10,I32,s"))
;;             (const_int 32))))]
;;   ""
;;   "mulwdm %0 = %1, %2"
;; [(set_attr "type" "mau,mau_x,mau_x")
;;  (set_attr "length" "4,8,8")]
;; )

(define_expand "smuldi3_highpart"
  [(set (match_operand:DI 0 "register_operand" "")
          (truncate:DI
           (lshiftrt:TI
            (mult:TI (sign_extend:TI
                      (match_operand:DI 1 "register_operand" ""))
                     (sign_extend:TI
                      (match_operand:DI 2 "register_operand" "")))
            (const_int 64))))]
  ""
{
/*
mult_s64_s64_s128:
  mulsuwd $r4r5 = $r3, $r0
  extfs $r7 = $r3, 31, 31
  make $r34 = 0
  ;;
  madsuciwd $r4r5 = $r1, $r2
  comp.ge $r33 = $r3, 0
  extfs $r32 = $r1, 31, 31
  ;;
  copy $r6 = $r1
  muluuwd $r0r1 = $r0, $r2
  or $r8 = $r32, r33
  ;;
  addc $r34 = $r34, $r34
  mulwd $r2r3 = $r6, $r3
  ;;
  addci $r1 = $r1, $r4
  cmove.nez $r7 = $r34? $r8
  ;;
  addcd $r2:$r3 = $r2:$r3, $r5:$r7
  ret
  ;; */

        rtx tmp1 = gen_reg_rtx (DImode);
        rtx zero = gen_reg_rtx (SImode);
        rtx tmp2 = gen_reg_rtx (SImode);
        rtx tmp3 = gen_reg_rtx (DImode);
        rtx tmp4 = gen_reg_rtx (SImode);
        rtx tmp5 = gen_reg_rtx (SImode);
        rtx tmp6 = gen_reg_rtx (DImode);
        rtx tmp7 = gen_reg_rtx (SImode);
        rtx tmp8 = gen_reg_rtx (SImode);
        rtx tmp9 = gen_reg_rtx (DImode);
        rtx test = gen_rtx_GE (VOIDmode, gen_highpart(SImode, operands[2]), const0_rtx);

        emit_move_insn(zero, const0_rtx);
        emit_insn (gen_extv (tmp2, gen_highpart (SImode, operands[2]), GEN_INT(1), GEN_INT(31)));
        emit_insn (gen_extv (tmp5, gen_highpart (SImode, operands[1]), GEN_INT(1), GEN_INT(31)));
        emit_insn (gen_cstoresi4 (tmp4, test, gen_highpart(SImode, operands[2]), const0_rtx));
        emit_insn (gen_iorsi3 (tmp7, tmp4, tmp5));

        emit_insn (gen_usmulsidi3 (tmp1, gen_lowpart(SImode, operands[1]), gen_highpart(SImode, operands[2])));
        emit_insn (gen_madsuciwd (tmp1, gen_highpart (SImode, operands[1]), gen_lowpart(SImode, operands[2])));
        emit_insn (gen_umulsidi3 (tmp3, gen_lowpart (SImode, operands[1]), gen_lowpart (SImode, operands[2])));
        emit_insn (gen_mulsidi3 (tmp6, gen_highpart (SImode, operands[1]), gen_highpart (SImode, operands[2])));

        emit_insn (gen_addc (tmp8, zero, zero));
        emit_insn (gen_addci (zero, gen_highpart (SImode, tmp3), gen_lowpart (SImode, tmp1)));
        test = gen_rtx_NE (VOIDmode, tmp8, const0_rtx);
        emit_insn (gen_cmovesi (tmp2, test, tmp8, tmp7, tmp2));

        emit_insn (gen_rtx_CLOBBER (DImode, tmp9));
        emit_move_insn (gen_lowpart (SImode, tmp9), gen_highpart (SImode, tmp1));
        emit_move_insn (gen_highpart (SImode, tmp9), tmp2);
        
        emit_insn (gen_addcd (operands[0], tmp6, tmp9));
        DONE;
})


(define_expand "maddsidi4"
   [(set (match_operand:DI 0 "register_operand" "")
         (plus:DI (mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" ""))
                           (match_operand 2 "nonmemory_operand" ""))
                  (match_operand:DI 3 "register_operand" "")))]
  ""
  {
      if(!CONST_INT_P(operands[2])) {
          operands[2] = gen_rtx_SIGN_EXTEND(DImode, operands[2]);
      }
  }
)

(define_insn "*maddsidi4_reg"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (plus:DI (mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r"))
                          (sign_extend:DI (match_operand:SI 2 "register_operand" "r")))
                 (match_operand:DI 3 "register_operand" "r")))]
  ""
  "madwd %0 = %3, %1, %2"
[(set_attr "type" "mau_lsu")
 (set_attr "length" "4")]
)


(define_insn "*maddsidi4_immediate"
  [(set (match_operand:DI 0 "register_operand" "=r,=r")
        (plus:DI (mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r,r"))
                          (match_operand:SI 2 "immediate_operand" "I10,I32"))
                 (match_operand:DI 3 "register_operand" "0,0")))]
  ""
  "madwd %0 = %1, %2"
[(set_attr "type" "mau_acc,mau_acc_x")
 (set_attr "length" "4,8")]
)


(define_expand "umaddsidi4"
  [(set (match_operand:DI 0 "register_operand" "")
        (plus:DI (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" ""))
                          (match_operand 2 "nonmemory_operand" ""))
                 (match_operand:DI 3 "register_operand" "")))]
""
{
   if(!CONST_INT_P(operands[2])) {
          operands[2] = gen_rtx_ZERO_EXTEND(DImode, operands[2]);
   }
})

(define_insn "*umaddsidi4_reg"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (plus:DI (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r"))
                          (zero_extend:DI (match_operand:SI 2 "register_operand" "r")))
                 (match_operand:DI 3 "register_operand" "r")))]
  ""
  "maduuwd %0 = %3, %1, %2"
[(set_attr "type" "mau_acc")
 (set_attr "length" "4")]
)

(define_insn "*umaddsidi4_immediate"
  [(set (match_operand:DI 0 "register_operand" "=r,r")
        (plus:DI (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r,r"))
                          (match_operand 2 "immediate_operand" "I10,i"))
                 (match_operand:DI 3 "register_operand" "0,0")))]
  ""
  "maduuwd %0 = %1, %2"
[(set_attr "type" "mau_acc,mau_acc_x")
 (set_attr "length" "4,8")]
)

(define_insn "msubsidi4"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (minus:DI (match_operand:DI 3 "register_operand" "0")
                  (mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r"))
                           (sign_extend:DI (match_operand:SI 2 "register_operand" "r")))))]
""
"msbwd %0 = %1, %2"
[(set_attr "type" "mau_acc")
 (set_attr "length" "4")]
)

(define_insn "umsubsidi4"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (minus:DI (match_operand:DI 3 "register_operand" "0")
                  (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r"))
                           (zero_extend:DI (match_operand:SI 2 "register_operand" "r")))))]
""
"msbuuwd %0 = %1, %2"
[(set_attr "type" "mau_acc")
 (set_attr "length" "4")]
)

(define_insn "maduuciwd"
  [(set (match_operand:DI 0 "register_operand" "+r")
        (plus:DI (match_dup 0)
                 (mult:DI (zero_extend:DI (match_operand:SI 1 "register_operand" "r"))
                          (zero_extend:DI (match_operand:SI 2 "register_operand" "r")))))
   (set (reg:SI CS_REGNO) (unspec:SI [(match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "maduuciwd %0 = %1, %2"
[(set_attr "type" "mau_acc_odd")]
)


(define_insn "madsuciwd"
  [(set (match_operand:DI 0 "register_operand" "+r")
        (plus:DI (match_dup 0)
                 (mult:DI (sign_extend:DI (match_operand:SI 1 "register_operand" "r"))
                          (zero_extend:DI (match_operand:SI 2 "register_operand" "r")))))
   (set (reg:SI CS_REGNO) (unspec:SI [(match_dup 1)
                                      (match_dup 2)] UNSPEC_SETCARRY))
  ]
  ""
  "madsuciwd %0 = %1, %2"
[(set_attr "type" "mau_acc_odd")]
)

(define_insn "uminsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(umin:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "register_operand" "r")))]
  ""
  "minuw %0 = %1, %2"
[(set_attr "type" "tiny")
 (set_attr "length" "4")]
)

(define_insn "umindi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(umin:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "register_operand" "r")))]
""
"minud %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")])

(define_insn "umaxsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(umax:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "register_operand" "r")))]
  ""
  "maxuw %0 = %1, %2"
[(set_attr "type" "tiny")
 (set_attr "length" "4")]
)

(define_insn "umaxdi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(umax:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "register_operand" "r")))]
  ""
  "maxud %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_expand "movsicc"
[(set (match_operand:SI 0 "register_operand" )
        (if_then_else:SI (match_operand 1 "comparison_operator" )
                         (match_operand:SI 2 "register_operand" )
                         (match_operand:SI 3 "nonmemory_operand" )))]
  ""
{
       rtx max, cmp, target = operands[0];
       if (GET_MODE (XEXP(operands[1], 0)) != SImode
           || (GET_MODE (XEXP(operands[1], 1)) != SImode
               && GET_MODE (XEXP(operands[1], 1)) != VOIDmode))
           FAIL;

       if (XEXP(operands[1], 1) == const0_rtx) {
          if (operands[3] == operands[0]){
	      ;
	  } else if (operands[2] == operands[0]) {
              enum rtx_code cond;
              rtx tmp;

              switch (GET_CODE (operands[1])) {
                     case NE: cond = EQ; break;
                     case EQ: cond = NE; break;
                     case GE: cond = LT; break;
                     case LT: cond = GE; break;
                     case GT: cond = LE; break;
                     case LE: cond = GT; break;
                     default: gcc_unreachable ();
              }

              PUT_CODE (operands[1], cond);
              tmp = operands[2]; operands[2] = operands[3]; operands[3] = tmp;              
          } else {
              if (reg_mentioned_p (operands[0], operands[1]))
                 target = gen_reg_rtx (SImode);
              emit_move_insn (target, operands[3]);
          }
         
         emit_insn(gen_cmovesi (target, operands[1], XEXP(operands[1], 0), operands[2], target));
         if (target != operands[0])
              emit_move_insn (operands[0], target);
            
         DONE;
       }

       if (GET_RTX_CLASS (GET_CODE (operands[1])) == RTX_COMM_COMPARE)
          FAIL;

       operands[2] = force_reg(SImode, operands[2]);
       operands[3] = force_reg(SImode, operands[3]);
        
       cmp = copy_rtx (operands[1]);
       XEXP (cmp, 0) = force_reg (SImode, XEXP (operands[1], 0));
       
       max = gen_reg_rtx (SImode);

       /*
        * FIXME AUTO: disabling the usage of MAX*S insn as it is not in coolidge
	*/
#if 0
       if (GET_CODE (cmp) == LE
           || GET_CODE (cmp) == LEU
           || GET_CODE (cmp) == GE
           || GET_CODE (cmp) == GEU) {

           if (CONST_INT_P (XEXP (cmp, 1))) {
               if (GET_CODE (cmp) == LE
                   || GET_CODE (cmp) == LEU)
                   XEXP (cmp, 1) = GEN_INT(INTVAL(XEXP (cmp, 1)) + 1);
               else
                   XEXP (cmp, 1) = GEN_INT(INTVAL(XEXP (cmp, 1)) - 1);
           } else {
              rtx tmp;
              enum rtx_code cond;
              
              switch (GET_CODE (operands[1])) {
                     case GE: cond = GT; break;
                     case LE: cond = LT; break;
                     case GEU: cond = GTU; break;
                     case LEU: cond = LTU; break;
                     default: gcc_unreachable ();
              }

              PUT_CODE (operands[1], cond);
              tmp = XEXP (cmp, 1); XEXP (cmp, 1) = XEXP (cmp, 0); XEXP (cmp, 0) = tmp;  
              tmp = operands[2]; operands[2] = operands[3]; operands[3] = tmp;   
           }
       }

       if (GET_CODE (cmp) == LE
           || GET_CODE (cmp) == LT)
           emit_insn (gen_maxs (max, XEXP (cmp, 0), XEXP (cmp, 1),
                                operands[0],
                                operands[3], operands[2]));
       else if (GET_CODE (cmp) == LEU
               || GET_CODE (cmp) == LTU)
           emit_insn (gen_maxus (max, XEXP (cmp, 0), XEXP (cmp, 1),
                                operands[0],
                                operands[3], operands[2]));
       else if (GET_CODE (cmp) == GT
               || GET_CODE (cmp) == GE)
           emit_insn (gen_mins (max, XEXP (cmp, 0), XEXP (cmp, 1),
                                operands[0],
                                operands[3], operands[2]));
       else if (GET_CODE (cmp) == GTU
               || GET_CODE (cmp) == GEU)
           emit_insn (gen_minus (max, XEXP (cmp, 0), XEXP (cmp, 1),
                                 operands[0],
                                 operands[3], operands[2]));
 #endif /* END OF DISABLING MAX*S USAGE */
       DONE;
})


;; Disable the immediate operand, there is a bug in the description
;; that needs to be fixed
;; (define_insn "maxs"
;; [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
;;       (smax:SI (match_operand:SI 1 "register_operand" "r,r,r")
;;                (match_operand:SI 2 "nonmemory_operand" "r,I10,i")))
;;  (set (match_operand:SI 3 "register_operand" "=r,=r,=r")
;;       (if_then_else:SI (gt (match_dup 2)
;;                            (match_dup 1))
;;              (match_operand:SI 5 "register_operand" "r,r,r")
;;              (match_operand:SI 4 "register_operand" "r,r,r"))) 
;; ]
;;   ""
;;   "maxs %0 = %1, %2? %3 = %4, %5"
;; [(set_attr "type" "alud,alud,alud_y")
;;  (set_attr "length" "8,8,12")]
;; )

;; FIXME AUTO: disabled maxs insn as it's not in coolidge ATM. Maybe it won't make it again...
;; (define_insn "maxs"
;; [(set (match_operand:SI 0 "register_operand" "=r,=r")
;;       (smax:SI (match_operand:SI 1 "register_operand" "r,r")
;;                (match_operand:SI 2 "nonmemory_operand" "r,I10")))
;;  (set (match_operand:SI 3 "register_operand" "=r,r")
;;       (if_then_else:SI (gt (match_dup 1)
;;                            (match_dup 2))
;;              (match_operand:SI 4 "register_operand" "r,r")
;;              (match_operand:SI 5 "register_operand" "r,r")))
;; ]
;;   ""
;;   "maxs %0 = %1, %2? %3 = %4, %5"
;; [(set_attr "type" "alud_x,alud_x")
;;  (set_attr "length" "8,8")]
;; )


;; Disable the immediate operand, there is a bug in the description
;; that needs to be fixed
;; (define_insn "maxus"
;; [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
;;       (umax:SI (match_operand:SI 1 "register_operand" "r,r,r")
;;                (match_operand:SI 2 "nonmemory_operand" "r,I10,i")))
;;  (set (match_operand:SI 3 "register_operand" "=r,=r,=r")
;;       (if_then_else:SI (gtu (match_dup 2)
;;                             (match_dup 1))
;;              (match_operand:SI 5 "register_operand" "r,r,r")
;;              (match_operand:SI 4 "register_operand" "r,r,r"))) 
;; ]
;;   ""
;;   "maxus %0 = %1, %2, %3 = %4, %5"
;; [(set_attr "type" "alud,alud,alud_y")
;;  (set_attr "length" "8,8,12")]
;; )

(define_insn "maxus"
[(set (match_operand:SI 0 "register_operand" "=r,r")
      (umax:SI (match_operand:SI 1 "register_operand" "r,r")
               (match_operand:SI 2 "nonmemory_operand" "r,I10")))
 (set (match_operand:SI 3 "register_operand" "=r,r")
      (if_then_else:SI (gtu (match_dup 1)
                            (match_dup 2))
             (match_operand:SI 4 "register_operand" "r,r")
             (match_operand:SI 5 "register_operand" "r,r"))) 
]
  ""
  "maxus %0 = %1, %2, %3 = %4, %5"
[(set_attr "type" "alud_x,alud_x")
 (set_attr "length" "8,8")]
)


;; Disable the immediate operand, there is a bug in the description
;; that needs to be fixed
;; (define_insn "mins"
;; [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
;;       (smin:SI (match_operand:SI 1 "register_operand" "r,r,r")
;;                (match_operand:SI 2 "nonmemory_operand" "r,I10,i")))
;;  (set (match_operand:SI 3 "register_operand" "=r,=r,=r")
;;       (if_then_else:SI (lt (match_dup 2)
;;                            (match_dup 1))
;;              (match_operand:SI 5 "register_operand" "r,r,r")
;;              (match_operand:SI 4 "register_operand" "r,r,r"))) 
;; ]
;;   ""
;;   "mins %0 = %1, %2, %3 = %4, %5"
;; [(set_attr "type" "alud,alud,alud_y")
;;  (set_attr "length" "8,8,12")]
;; )

(define_insn "mins"
[(set (match_operand:SI 0 "register_operand" "=r,r")
      (smin:SI (match_operand:SI 1 "register_operand" "r,r")
               (match_operand:SI 2 "nonmemory_operand" "r,I10")))
 (set (match_operand:SI 3 "register_operand" "=r,r")
      (if_then_else:SI (lt (match_dup 1)
                           (match_dup 2))
             (match_operand:SI 4 "register_operand" "r,r")
             (match_operand:SI 5 "register_operand" "r,r"))) 
]
  ""
  "mins %0 = %1, %2, %3 = %4, %5"
[(set_attr "type" "alud_x,alud_x")
 (set_attr "length" "8,8")]
)

;; Disable the immediate operand, there is a bug in the description
;; that needs to be fixed
;; (define_insn "minus"
;; [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
;;       (umin:SI (match_operand:SI 1 "register_operand" "r,r,r")
;;                (match_operand:SI 2 "nonmemory_operand" "r,I10,i")))
;;  (set (match_operand:SI 3 "register_operand" "=r,=r,=r")
;;       (if_then_else:SI (ltu (match_dup 2)
;;                             (match_dup 1))
;;              (match_operand:SI 5 "register_operand" "r,r,r")
;;              (match_operand:SI 4 "register_operand" "r,r,r"))) 
;; ]
;;   ""
;;   "minus %0 = %1, %2, %3 = %4, %5"
;; [(set_attr "type" "alud,alud,alud_y")
;;  (set_attr "length" "8,8,12")]
;; )

(define_insn "minus"
[(set (match_operand:SI 0 "register_operand" "=r,r")
      (umin:SI (match_operand:SI 1 "register_operand" "r,r")
               (match_operand:SI 2 "nonmemory_operand" "r,I10")))
 (set (match_operand:SI 3 "register_operand" "=r,r")
      (if_then_else:SI (ltu (match_dup 1)
                            (match_dup 2))
             (match_operand:SI 4 "register_operand" "r,r")
             (match_operand:SI 5 "register_operand" "r,r")))
]
  ""
  "minus %0 = %1, %2, %3 = %4, %5"
[(set_attr "type" "alud_x,alud_x")
 (set_attr "length" "8,8")]
)

(define_insn "sminsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(smin:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "register_operand" "r")))]
  ""
  "minw %0 = %1, %2"
[(set_attr "type" "tiny")
 (set_attr "length" "4")]
)

(define_insn "smindi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(smin:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "register_operand" "r")))]
  ""
  "mind %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "smaxsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(smax:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand:SI 2 "register_operand" "r")))]
  ""
  "maxw %0 = %1, %2"
[(set_attr "type" "tiny")
 (set_attr "length" "4")]
)

(define_insn "smaxdi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(smax:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "register_operand" "r")))]
  ""
  "maxd %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*zxh_and"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(and:SI (match_operand:SI 1 "register_operand" "r")
                (const_int 65535) ))]
  ""
  "zxh %0 = %1"
[(set_attr "type" "extfz")] ;; extfz does not reserve same resource on all archs
)

(define_insn "andsi3"
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r,=r")
	(and:SI (match_operand:SI 1 "register_operand" "r,r,r,r")
		 (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i")))]
  ""
  "andd %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_split 
 [(set (match_operand:DI 0 "register_operand" "")
       (ior:DI (and:DI (match_operand:DI 1 "register_operand" "")
                       (const_int -4294967296))
               (zero_extend:DI (subreg:SI (match_dup 1) 0))))]
 ""
 [(set (match_dup 0) (match_dup 1))]
 {}
)

(define_split 
 [(set (match_operand:DI 0 "register_operand" "")
       (xor:DI (and:DI (match_operand:DI 1 "register_operand" "")
                       (const_int -4294967296))
               (zero_extend:DI (subreg:SI (match_dup 1) 0))))]
 ""
 [(set (match_dup 0) (match_dup 1))]
 {}
)

;; (define_insn_and_split "*DI_shift_low"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (ashift:DI (match_operand:DI 1 "register_operand" "")
;;                   (const_int 32)))]
;;  ""
;;  "DI_shift_low not split !"
;;  ""
;;  [(set (match_dup 3) (match_dup 4))
;;   (set (match_dup 5) (match_dup 6))]
;;  {
;;         if (!reload_completed
;;             && !reg_mentioned_p (operands[0], operands[1]))
;;                 emit_clobber (operands[0]);
;;                 
;;         /* The order of the subparts setter matter for correctness if operands[0] == operands[1] */
;;         operands[5] = gen_lowpart (SImode, operands[0]);
;;         operands[6] = const0_rtx;
;;         operands[3] = gen_highpart (SImode, operands[0]);
;;         operands[4] = gen_lowpart (SImode, operands[1]);
;; }
;; )

;; (define_insn_and_split "*DI_shift_high"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (lshiftrt:DI (match_operand:DI 1 "register_operand" "")
;;                     (const_int 32)))]
;;  ""
;;  "DI_shift_high not split !"
;;  ""
;;  [(set (match_dup 3) (match_dup 4))
;;   (set (match_dup 5) (match_dup 6))]
;;  {
;;         if (!reload_completed
;;             && !reg_mentioned_p (operands[0], operands[1]))
;;                 emit_clobber (operands[0]);
;; 
;;         /* The order of the subparts setter matter for correctness if operands[0] == operands[1] */
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = const0_rtx;
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[4] = gen_highpart (SImode, operands[1]);
;; }
;; )

;; (define_insn_and_split "*swap_words"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (ior:DI (and:DI (match_operand:DI 1 "register_operand" "")
;;                        (const_int -4294967296))
;;                (lshiftrt:DI (match_operand:DI 2 "register_operand" "")
;;                             (const_int 32))))]
;;  ""
;;  "swap_words not split !"
;;  ""
;;  [(set (match_dup 3) (match_dup 4))
;;   (set (match_dup 5) (match_dup 6))]
;;  {
;;         if (!reload_completed
;;             && (!reg_mentioned_p (operands[0], operands[1])
;;                 && !reg_mentioned_p (operands[0], operands[2])))
;;                 emit_clobber (operands[0]);
;; 
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[4] = gen_highpart (SImode, operands[2]);
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = gen_highpart (SImode, operands[1]);
;; }
;; )
;; 
;; (define_insn_and_split "*swap_words2"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (xor:DI (and:DI (match_operand:DI 1 "register_operand" "")
;;                        (const_int -4294967296))
;;                (lshiftrt:DI (match_operand:DI 2 "register_operand" "")
;;                             (const_int 32))))]
;;  ""
;;  "swap_words2 not split !"
;;  ""
;;  [(set (match_dup 3) (match_dup 4))
;;   (set (match_dup 5) (match_dup 6))]
;;  {
;;         if (!reload_completed
;;             && (!reg_mentioned_p (operands[0], operands[1])
;;                 && !reg_mentioned_p (operands[0], operands[2])))
;;                 emit_clobber (operands[0]);
;; 
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[4] = gen_highpart (SImode, operands[2]);
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = gen_highpart (SImode, operands[1]);
;; }
;; )

;; (define_insn_and_split  "*DI_or_and_shift"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (ior:DI (ashift:DI (match_operand:DI 1 "register_operand" "")
;;                           (const_int 32))
;;                (match_operand:DI 2 "register_operand" "")))]
;;  ""
;;  "DI_or_and_shift not split !"
;;  ""
;;  [(set (match_dup 5) (ior:SI (match_dup 6) (match_dup 7)))
;;   (set (match_dup 3) (match_dup 4))
;;  ]
;;  {
;;         if (!reload_completed   
;;             && (!reg_mentioned_p (operands[0], operands[1])
;;                 && !reg_mentioned_p (operands[0], operands[2])))
;;                 emit_clobber (operands[0]);
;; 
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[4] = gen_lowpart (SImode, operands[2]);
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = gen_lowpart (SImode, operands[1]);
;;         operands[7] = gen_highpart (SImode, operands[2]);
;;  }
;; )

;; (define_insn_and_split  "*DI_xor_and_shift"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (xor:DI (ashift:DI (match_operand:DI 1 "register_operand" "")
;;                           (const_int 32))
;;                (match_operand:DI 2 "register_operand" "")))]
;;  ""
;;  "DI_xor_and_shift not split !"
;;  ""
;;  [(set (match_dup 5) (xor:SI (match_dup 6) (match_dup 7)))
;;   (set (match_dup 3) (match_dup 4))
;;  ]
;;  {
;;         if (!reload_completed   
;;             && (!reg_mentioned_p (operands[0], operands[1])
;;                 && !reg_mentioned_p (operands[0], operands[2])))
;;                 emit_clobber (operands[0]);
;; 
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[4] = gen_lowpart (SImode, operands[2]);
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = gen_lowpart (SImode, operands[1]);
;;         operands[7] = gen_highpart (SImode, operands[2]);
;;  }
;; )

;; (define_insn_and_split  "*DI_and_and_shift"
;;  [(set (match_operand:DI 0 "register_operand" "")
;;        (and:DI (ashift:DI (match_operand:DI 1 "register_operand" "")
;;                           (const_int 32))
;;                (match_operand:DI 2 "register_operand" "")))]
;;  ""
;;  "DI_xor_and_shift not split !"
;;  ""
;;  [(set (match_dup 5) (and:SI (match_dup 6) (match_dup 7)))
;;   (set (match_dup 3) (const_int 0))
;;  ]
;;  {
;;         if (!reload_completed   
;;             && (!reg_mentioned_p (operands[0], operands[1])
;;                 && !reg_mentioned_p (operands[0], operands[2])))
;;                 emit_clobber (operands[0]);
;; 
;;         operands[3] = gen_lowpart (SImode, operands[0]);
;;         operands[5] = gen_highpart (SImode, operands[0]);
;;         operands[6] = gen_lowpart (SImode, operands[1]);
;;         operands[7] = gen_highpart (SImode, operands[2]);
;;  }
;; )

(define_insn "anddi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(and:DI (match_operand:DI 1 "register_operand" "r")
	        (match_operand:DI 2 "register_operand" "r")))]
""
"andd %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")])

(define_insn "*andn"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r,r")
        (and:SI (not:SI (match_operand:SI 1 "register_operand" "r,r,r,r"))
                (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i")))]
  ""
  "andn %0 = %1, %b2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "nand"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r,r")
        (ior:SI (not:SI (match_operand:SI 1 "register_operand" "r,r,r,r"))
                (not:SI (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i"))))]
  ""
  "nand %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "*andnd"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (and:DI (not:DI (match_operand:DI 1 "register_operand" "r"))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "andnd %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")]
)

(define_insn "*nandd"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (ior:DI (not:DI (match_operand:DI 1 "register_operand" "r"))
                (not:DI (match_operand:DI 2 "register_operand" "r"))))]
  ""
  "nandd %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")]
)

(define_insn "iorsi3"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r,r")
	(ior:SI (match_operand:SI 1 "register_operand" "r,r,r,r")
		 (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i")))]
  ""
  "ord %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "iordi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(ior:DI (match_operand:DI 1 "register_operand" "r")
		 (match_operand:DI 2 "register_operand" "r")))]
""
"ord %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")])

(define_insn "*orn"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r,r")
        (ior:SI (not:SI (match_operand:SI 1 "register_operand" "r,r,r,r"))
                (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i")))]
  ""
  "orn %0 = %1, %b2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "*nor"
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r,=r")
	(not:SI (ior:SI (match_operand:SI 1 "register_operand" "r,r,r,r")
		        (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i"))))]
  ""
  "nord %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "*ornd"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (ior:DI (not:DI (match_operand:DI 1 "register_operand" "r"))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "ornd %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")]
)

(define_insn "*nord"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (and:DI (not:DI (match_operand:DI 1 "register_operand" "r"))
                (not:DI (match_operand:DI 2 "register_operand" "r"))))]
  ""
  "nord %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")]
)

(define_expand "xorsi3"
  [(set (match_operand:SI 0 "register_operand" "")
	(xor:SI (match_operand:SI 1 "register_operand" "")
		(match_operand:SI 2 "nonmemory_operand" "")))]
  ""
{
	if (!small_operand (operands[2], SImode))
	   if (! (reload_completed || reload_in_progress))
	      operands[2] = force_reg (SImode, operands[2]);
}
)

(define_insn "*xor"
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
        (xor:SI (match_operand:SI 1 "register_operand" "r,r,r")
                (match_operand:SI 2 "small_operand" "r,I10,Ilh")))]
  ""
  "xord %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh")]
)

(define_insn "*xor_x"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(xor:SI (match_operand:SI 1 "register_operand" "r")
		 (match_operand 2 "immediate_operand" "i")))]
  "current_pass->tv_id != TV_CPROP"
  "xord %0 = %1, %2"
[(set_attr "type" "tiny_x")
 (set_attr "length" "8")]
)

(define_insn "xordi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(xor:DI (match_operand:DI 1 "register_operand" "r")
	        (match_operand:DI 2 "register_operand" "r")))]
  ""
  "xord %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")])

(define_insn "nxor"
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r,=r")
        (not:SI (xor:SI (match_operand:SI 1 "register_operand" "r,r,r,r")
                (match_operand:SI 2 "nonmemory_operand" "r,I10,Ilh,i"))))]
  ""
  "nxord %0 = %1, %2"
[(set_attr "type" "tiny,tiny,and_Ilh,tiny_x")
 (set_attr "length" "4,4,4,8")]
)

(define_insn "nxord"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (not:DI (xor:DI (match_operand:DI 1 "register_operand" "r")
                (match_operand:DI 2 "register_operand" "r"))))]
  ""
  "nxord %0 = %1, %2"
[(set_attr "type" "alud_tiny")
 (set_attr "length" "4")])

(define_insn "ashlsi3"
  [(set (match_operand:SI            0 "register_operand" "=r,r")
	(ashift:SI (match_operand:SI 1 "register_operand" "r,r")
		   (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "sllw %0 = %1,%2"
[(set_attr "type" "shift32,shift32")]
)

(define_insn "ashrsi3"
  [(set (match_operand:SI            0 "register_operand" "=r,r")
	(ashiftrt:SI (match_operand:SI 1 "register_operand" "r,r")
		     (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "sraw %0 = %1,%2"
[(set_attr "type" "shift32,shift32")]
)

(define_insn "lshrsi3"
  [(set (match_operand:SI            0 "register_operand" "=r,r")
	(lshiftrt:SI (match_operand:SI 1 "register_operand" "r,r")
		     (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "srlw %0 = %1,%2"
[(set_attr "type" "shift32,shift32")]
)

;; PLACEHOLDER for shift insn for Bostan

(define_insn "ashldi3"
  [(set (match_operand:DI            0 "register_operand" "=r,r")
	(ashift:DI (match_operand:DI 1 "register_operand" "r,r")
		   (match_operand:SI 2 "shiftd_operand" "r,U06")))]
  ""
  "slld %0 = %1,%2"
[(set_attr "type" "alud_lite,alud_lite")
 (set_attr "length" "4")]
)

(define_insn "ashrdi3"
  [(set (match_operand:DI            0 "register_operand" "=r,r")
	(ashiftrt:DI (match_operand:DI 1 "register_operand" "r,r")
		     (match_operand:SI 2 "shiftd_operand" "r,U06")))]
  ""
  "srad %0 = %1,%2"
[(set_attr "type" "alud_lite,alud_lite")
 (set_attr "length" "4")]
)

(define_insn "lshrdi3"
  [(set (match_operand:DI            0 "register_operand" "=r,r")
	(lshiftrt:DI (match_operand:DI 1 "register_operand" "r,r")
		     (match_operand:SI 2 "shiftd_operand" "r,U06")))]
  ""
  "srld %0 = %1,%2"
[(set_attr "type" "alud_lite,alud_lite")
 (set_attr "length" "4")]
)

(define_insn "rol"
  [(set (match_operand:SI 0 "register_operand" "=r,r")
	(rotate:SI (match_operand:SI 1 "register_operand" "r,r")
		   (match_operand:SI 2 "rotate_operand" "r,U05")))]
  ""
  "rolw %0 = %1, %2"
[(set_attr "type" "shift32,shift32")
 (set_attr "length" "4,4")]
)

(define_insn "ror"
  [(set (match_operand:SI 0 "register_operand" "=r,r")
	(rotatert:SI (match_operand:SI 1 "register_operand" "r,r")
	  	     (match_operand:SI 2 "rotate_operand" "r,U05")))]
  ""
  "ror %0 = %1, %2"
[(set_attr "type" "shift32,shift32")
 (set_attr "length" "4")]
)

(define_expand "rotrsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(rotatert:SI (match_operand:SI 1 "register_operand" "r")
	  	     (match_operand:SI 2 "rotate_operand" "rU05")))]
  ""
{
	if (!rotate_operand (operands[2], SImode))
	   FAIL;
}
)

(define_expand "rotlsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(rotate:SI (match_operand:SI 1 "register_operand" "r")
	           (match_operand:SI 2 "rotate_operand" "rU05")))]
  ""
{
	if (!rotate_operand (operands[2], SImode))
	   FAIL;
}
)

(define_insn "abssi2"
  [(set (match_operand:SI            0 "register_operand" "=r")
	(abs:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "absw %0 = %1"
[(set_attr "type" "abs")]
)

;; FIXME AUTO: disable absd as it has disapeared from coolidge ISA
;; (define_insn "absdi2"
;;   [(set (match_operand:DI            0 "register_operand" "=r")
;; 	(abs:DI (match_operand:DI 1 "register_operand" "r")))]
;;   ""
;;   "absd %0 = %1"
;; [(set_attr "type" "alud_lite")
;;  (set_attr "length" "4")])

(define_insn "clzsi2"
  [(set (match_operand:SI            0 "register_operand" "=r")
	(clz:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "clzw %0 = %1"
[(set_attr "type" "clz")]
)

(define_insn "clzdi2"
  [(set (match_operand:DI         0 "register_operand" "=r")
	(clz:DI (match_operand:DI 1 "register_operand" "r")))]
  ""
  "clzd %0 = %1"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "ctzdi2"
  [(set (match_operand:DI         0 "register_operand" "=r")
	(ctz:DI (match_operand:DI 1 "register_operand" "r")))]
  ""
  "ctzd %0 = %1"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "ctzsi2"
  [(set (match_operand:SI         0 "register_operand" "=r")
	(ctz:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "ctzw %0 = %1"
[(set_attr "type" "ctz")]
)

(define_insn "popcountsi2"
  [(set (match_operand:SI            0 "register_operand" "=r")
	(popcount:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "cbsw %0 = %1"
[(set_attr "type" "cbs")])

;; FIXME when updating GCC, popcountdi2 could rely on this insn
;; As of 4.9, this is not possible.
;; (define_insn "cbsdl"
;;   [(set (match_operand:SI  0 "register_operand" "=r")
;; 	(subreg:SI (popcount:DI (match_operand:DI 1 "register_operand" "r")) 0)) ]
;;   ""
;;   "cbsdl %0 = %1"
;; [(set_attr "type" "alud_lite")
;;  (set_attr "length" "4")])

(define_insn "popcountdi2"
  [(set (match_operand:DI            0 "register_operand" "=r")
	(popcount:DI (match_operand:DI 1 "register_operand" "r")))]
  ""
  "cbsd %0 = %1"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")])

;; (define_expand "popcountdi2"
;;   [(match_operand:DI 0 "register_operand" "r")
;;    (match_operand:DI 1 "register_operand" "r")]
;;   ""
;;   {
;;   rtx reg = gen_reg_rtx (SImode);
;;   emit_insn (gen_cbsdl (reg, operands[1]));
;;   emit_insn (gen_extend_insn (operands[0], reg, DImode, SImode, 1));
;;   
;;   DONE;
;;  })

(define_insn "one_cmplsi2"
  [(set (match_operand:SI            0 "register_operand" "=r")
	(not:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "not %0 = %1"
[(set_attr "type" "tiny")]
)

;; FIXME AUTO: disabling notd, there is no insn on coolidge yet
;; (define_insn_and_split "one_cmpldi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(not:DI (match_operand:DI 1 "register_operand" "r")))]
;;   ""
;;   "notd %d0 = %d1"
;; 
;; ;; FIXME : the split was done post-reload and thus need not to clobber anything ?!
;; 
;; "!reload_completed"
;;  [(set (match_dup 3)
;;        (not:SI (match_dup 4)))
;;   (set (match_dup 5)
;;        (not:SI (match_dup 6)))]
;; {
;;         /* Reload completed, no need to clobber the output.   */
;; 	   operands[3] = gen_lowpart (SImode, operands[0]);
;;        	   operands[4] = gen_lowpart (SImode, operands[1]);
;; 	   operands[5] = gen_highpart (SImode, operands[0]);
;; 	   operands[6] = gen_highpart (SImode, operands[1]);
;; }
;; [(set_attr "type" "alud_x")
;;  (set_attr "length" "8")]
;; )

(define_insn "negsi2"
  [(set (match_operand:SI            0 "register_operand" "=r")
	(neg:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
  "negw %0 = %1"
[(set_attr "type" "tiny")]
)

(define_insn "negdi2"
  [(set (match_operand:DI            0 "register_operand" "=r")
	(neg:DI (match_operand:DI 1 "register_operand" "r")))]
  ""
  "negd %0 = %1"
[(set_attr "type" "alud_x")
 (set_attr "length" "8")]
)

(define_insn "extv"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(sign_extract:SI (match_operand:SI 1 "register_operand" "r")
                         (match_operand:SI 2 "fivebits_unsigned_operand" "i")
                         (match_operand:SI 3 "fivebits_unsigned_operand" "i")))]
  ""
  "extfs %0 = %1, %3+%2-1, %3"
[(set_attr "type" "extfs")]
)

(define_insn "extzv"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(zero_extract:SI (match_operand:SI 1 "register_operand" "r")
                         (match_operand:SI 2 "fivebits_unsigned_operand" "i")
                         (match_operand:SI 3 "fivebits_unsigned_operand" "i")))]
  ""
  "extfz %0 = %1, %3+%2-1, %3"
[(set_attr "type" "extfz")]
)

(define_expand "insv"
  [(set (zero_extract:SI (match_operand:SI 0 "register_operand" "+r")
                         (match_operand:SI 1 "fivebits_unsigned_operand" "i")
                         (match_operand:SI 2 "fivebits_unsigned_operand" "i"))
        (match_operand:SI 3 "register_operand" "r"))]
  ""
  {}
)

(define_insn "*insv"
  [(set (zero_extract:SI (match_operand:SI 0 "register_operand" "+r")
                         (match_operand:SI 2 "fivebits_unsigned_operand" "i")
                         (match_operand:SI 3 "fivebits_unsigned_operand" "i"))
        (match_operand:SI 1 "register_operand" "r"))]
  ""
  "insf %0 = %1, %3+%2-1, %3"
[(set_attr "type" "insf")]
)

(define_insn "*addx2"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (mult:SI (match_operand:SI 1 "register_operand" "r")
                         (const_int 2))
                (match_operand:SI 2 "register_operand" "r")
                ))]
  ""
  "addx2 %0 = %1, %2"
[(set_attr "type" "alu")]
)

(define_insn "*addx2_2"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (ashift:SI (match_operand:SI 1 "register_operand" "r")
                           (const_int 1))
                (match_operand:SI 2 "register_operand" "r")
                ))]
  ""
  "addx2 %0 = %1, %2"
[(set_attr "type" "tiny")]
)

(define_insn "*addx4"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (mult:SI (match_operand:SI 1 "register_operand" "r")
                          (const_int 4))
                (match_operand:SI 2 "register_operand" "r")))]
  ""
  "addx4 %0 = %1, %2"
[(set_attr "type" "tiny")]
)

(define_insn "*addx4_2"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (ashift:SI (match_operand:SI 1 "register_operand" "r")
                           (const_int 2))
                (match_operand:SI 2 "register_operand" "r")))]
  ""
  "addx4 %0 = %1, %2"
[(set_attr "type" "tiny")]
)

(define_insn "*addx8"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (mult:SI (match_operand:SI 1 "register_operand" "r")
                         (const_int 8))
                (match_operand:SI 2 "register_operand" "r")))]
  ""
  "addx8 %0 = %1, %2"
[(set_attr "type" "tiny")]
)

(define_insn "*addx8_2"
  [(set (match_operand:SI 0 "register_operand" "=r")
       (plus:SI (ashift:SI (match_operand:SI 1 "register_operand" "r")
                           (const_int 3))
                (match_operand:SI 2 "register_operand" "r")))]
  ""
  "addx8 %0 = %1, %2"
[(set_attr "type" "tiny")]
)
		
(define_insn "*addx2d"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (plus:DI (mult:DI (match_operand:DI 1 "register_operand" "r")
                         (const_int 2))
                (match_operand:DI 2 "register_operand" "r")
                ))]
  ""
  "addx2d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*addx2d_2"
  [(set (match_operand:DI 0 "register_operand" "=r")
       (plus:DI (ashift:DI (match_operand:DI 1 "register_operand" "r")
                           (const_int 1))
                (match_operand:DI 2 "register_operand" "r")
                ))]
  ""
  "addx2d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*addx4d"
  [(set (match_operand:DI 0 "register_operand" "=r")
       (plus:DI (mult:DI (match_operand:DI 1 "register_operand" "r")
                         (const_int 4))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "addx4d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*addx4d_2"
  [(set (match_operand:DI 0 "register_operand" "=r")
       (plus:DI (ashift:DI (match_operand:DI 1 "register_operand" "r")
                           (const_int 2))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "addx4d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*addx8d"
  [(set (match_operand:DI 0 "register_operand" "=r")
       (plus:DI (mult:DI (match_operand:DI 1 "register_operand" "r")
                         (const_int 8))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "addx8d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "*addx8d_2"
  [(set (match_operand:DI 0 "register_operand" "=r")
       (plus:DI (ashift:DI (match_operand:DI 1 "register_operand" "r")
                           (const_int 3))
                (match_operand:DI 2 "register_operand" "r")))]
  ""
  "addx8d %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

(define_insn "set<ALLP:suffix>_volatile"
   [(set (match_operand:ALLP 0 "system_register_operand" "=RXX")
         (unspec_volatile:ALLP [(match_operand:ALLP 1 "register_operand" "r")] UNSPEC_SET))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "set<ALLP:suffix> %0 = %1"
[(set_attr "type" "bcu")]
)

(define_insn "set<ALLP:suffix>_ps_volatile"
   [(set (match_operand:ALLP 0 "system_register_operand" "=RXX")
         (unspec:ALLP [(match_operand:ALLP 1 "register_operand" "r")] UNSPEC_SET))
    (unspec_volatile [(const_int 0)] UNSPEC_SET_PS)
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "set<ALLP:suffix> %0 = %1"
[(set_attr "type" "all")]
)

(define_insn "get<ALLP:suffix>_volatile"
   [(set (match_operand:ALLP 0 "register_operand" "=r") 
         (unspec_volatile:ALLP [(match_operand:ALLP 1 "system_register_operand" "RXX")] UNSPEC_GET))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "get<ALLP:suffix> %0 = %1"
[(set_attr "type" "bcu_get")]
)

(define_insn "set_gotp_<mode>"
   [(set (match_operand:P 0 "register_operand" "=r")
         (unspec_volatile:P [(match_operand:P 1 "system_register<P:SRFSIZEp>_operand" "<P:SRFSIZE>")] UNSPEC_PIC))
    (set (match_operand:P 2 "register_operand" "=r")
         (unspec_volatile:P [(match_operand:P 3 "" "")] UNSPEC_PIC))]
   ""
   "get<P:suffix> %0 = %1\n\tmake<P:suffix> %2 = %3"
[(set_attr "type" "all")]
)

(define_insn "set_pcdisp_<mode>"
   [(set (match_operand:P 0 "register_operand" "=r")
         (pc))
    (set (match_operand:P 1 "register_operand" "=r")
         (unspec_volatile:P [(pc)] UNSPEC_PIC))]
                     
   ""
   "get<P:suffix> %0 = $pc\n\tmake<P:suffix> %1 = ."
[(set_attr "type" "all")]
)

;; (define_insn "getd"
;;    [(set (match_operand:DI 0 "register_operand" "=r") 
;;          (match_operand:DI 1 "system_register64_operand" "R64"))]
;;    ""
;;    "getd %0 = %1"
;; [(set_attr "type" "bcu_get")]
;; )

(define_insn "get<ALLP:suffix>"
   [(set (match_operand:ALLP 0 "register_operand" "=r") 
         (match_operand:ALLP 1 "system_register_operand" "RXX"))]
   ""
   "get<ALLP:suffix> %0 = %1"
[(set_attr "type" "bcu_get")]
)

(define_insn "get<ALLP:suffix>_r"
   [(set (match_operand:ALLP 0 "register_operand" "=r") 
         (unspec_volatile:ALLP [(match_operand:ALLP 1 "register_operand" "r")] UNSPEC_GET))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "get<ALLP:suffix> %0 = %1"
[(set_attr "type" "bcu_get")]
)

(define_insn "*set"
   [(set (match_operand:SI 0 "system_register32_operand" "=R32")
         (match_operand:SI 1 "register_operand" "r"))]
   ""
   "set %0 = %1"
[(set_attr "type" "bcu")]
)

(define_insn "*setd"
   [(set (match_operand:DI 0 "system_register64_operand" "=R64")
         (match_operand:DI 1 "register_operand" "r"))]
   ""
   "setd %0 = %1"
[(set_attr "type" "bcu")]
)

(define_insn "hfxb_<mode>"
   [(set (match_operand:ALLP 0 "system_register<ALLP:SRFSIZEp>_operand" "=<ALLP:SRFSIZE>")
         (unspec_volatile:<MODE> [(match_operand:SI 1 "register_operand" "r")]
  	  UNSPEC_HFXB))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "hfxb %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "hfxb_ps_<mode>"
   [(set (match_operand:ALLP 0 "system_register<ALLP:SRFSIZEp>_operand" "=<ALLP:SRFSIZE>")
         (unspec_volatile:<MODE> [(match_operand:SI 1 "register_operand" "r")]
  	  UNSPEC_HFXB_PS))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "hfxb %0, %1"
[(set_attr "type" "all")]
)

(define_insn "hfxt_<mode>"
   [(set (match_operand:ALLP 0 "system_register<ALLP:SRFSIZEp>_operand" "=<ALLP:SRFSIZE>")
         (unspec_volatile:<MODE> [(match_operand:SI 1 "register_operand" "r")]
  	  UNSPEC_HFXT))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "hfxt %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "hfxt_ps_<mode>"
   [(set (match_operand:ALLP 0 "system_register<ALLP:SRFSIZEp>_operand" "=<ALLP:SRFSIZE>")
         (unspec_volatile:<MODE> [(match_operand:SI 1 "register_operand" "r")]
  	  UNSPEC_HFXT_PS))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "hfxt %0, %1"
[(set_attr "type" "all")]
)

(define_insn "syncgroup"
   [(unspec_volatile [(match_operand:SI 0 "register_operand" "r")]
     UNSPEC_SYNCGROUP)
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
   ""
   "syncgroup %0"
[(set_attr "type" "all")]
)

(define_insn "barrier"
   [(unspec_volatile [(const_int 0)] UNSPEC_BARRIER)
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "barrier"
[(set_attr "type" "all")]
)

(define_insn "ctrapsi4"
      [(trap_if (match_operator 0 "comparison_operator"
                [(match_operand 1 "register_operand")
                 (match_operand 2 "immediate_operand")])
                (match_operand 3 "const_int_operand" "i"))]
  ""
  "cb.%0z %1, _stack_overflow_detected"
[(set_attr "type" "bcu")]
)

(define_insn "scall_<mode>"
   [(set (reg:SI 0)
         (call 
	    (mem:SI (unspec:SI [(match_operand 0 "immediate_operand" "i")] UNSPEC_SCALL))
	    (const_int 0)))
    
    (use (reg:SI 0))
    (use (reg:SI 1))
    (use (reg:SI 2))
    (use (reg:SI 3))
    (use (reg:SI 4))
    (use (reg:SI 5))
    (use (reg:SI 6))
    (use (reg:SI 7))
    (clobber (match_operand:P 1 "system_register<P:SRFSIZEp>_operand" "=<P:SRFSIZE>")) /* LINK_REG */
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 2 "" "") 
         (unspec:SI [(match_dup 2)] UNSPEC_SYNC))]
   ""
   "scall %0"
[(set_attr "type" "all")]
)

(define_insn "mos_dinval_scall"
   [(unspec_volatile:SI [(const_int 1026)] UNSPEC_SCALL)
    (clobber (reg:SI 0))
    (clobber (reg:SI 1))
    (clobber (reg:SI 2))
    (clobber (reg:SI 3))
    (clobber (reg:SI 4))
    (clobber (reg:SI 5))
    (clobber (reg:SI 6))
    (clobber (reg:SI 7))
    (clobber (reg:SI 8))
    (clobber (reg:SI 9))
    (clobber (reg:SI 11))
    (clobber (reg:SI 32))
    (clobber (reg:SI 33))
    (clobber (reg:SI 34))
    (clobber (reg:SI 35))
    (clobber (mem:BLK (scratch)))]
    ""
   "scall 1056"
 [(set_attr "type" "all")
  ]
 )

(define_insn "mos_dflush_scall"
   [(unspec_volatile:SI [(const_int 1027)] UNSPEC_SCALL)
    (clobber (reg:SI 0))
    (clobber (reg:SI 1))
    (clobber (reg:SI 2))
    (clobber (reg:SI 3))
    (clobber (reg:SI 4))
    (clobber (reg:SI 5))
    (clobber (reg:SI 6))
    (clobber (reg:SI 7))
    (clobber (reg:SI 8))
    (clobber (reg:SI 9))
    (clobber (reg:SI 11))
    (clobber (reg:SI 32))
    (clobber (reg:SI 33))
    (clobber (reg:SI 34))
    (clobber (reg:SI 35))
    (clobber (mem:BLK (scratch)))]
    ""
   "scall 1065"
 [(set_attr "type" "all")
  ]
)

(define_insn "fence"
   [(unspec_volatile [(const_int 0)] UNSPEC_FENCE)
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "fence"
[(set_attr "type" "lsu")]
)

(define_insn "dinval"
   [(unspec [(const_int 0)] UNSPEC_DINVAL)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "dinval"
[(set_attr "type" "lsu")]
)

(define_insn "iinval"
   [(unspec_volatile [(const_int 0)] UNSPEC_IINVAL)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "iinval "
[(set_attr "type" "lsu")]
)

(define_insn "dinvall"
   [(unspec [(match_operand:SI 0 "memory_operand" "a,m")] UNSPEC_DINVALL)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 1 "" "")
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
   ""
   "dinvall%m0 %0"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu,lsu_x")]
)

(define_insn "iinvall"
   [(unspec_volatile [(match_operand:SI 0 "memory_operand" "a,m")] UNSPEC_IINVALL)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
   ""
   "iinvall%m0 %0"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu,lsu_x")]
)

(define_insn "itouchl"
   [(unspec_volatile [(match_operand:SI 0 "memory_operand" "a,m")] UNSPEC_ITOUCHL)
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
   ""
   "itouchl%m0 %0"
[(set_attr "length" "4,8")
(set_attr "type" "lsu,lsu_x")]
)

(define_insn "dtouchl_<mode>"
  [(prefetch (match_operand:P 0 "address_operand" "A,p")
             (match_operand:SI 1 "" "")
             (match_operand:SI 2 "" ""))]
   ""
   "dtouchl%m0 %a0"
[(set_attr "length" "4,8")
(set_attr "type" "lsu,lsu_x")]
)

(define_expand "prefetch"
  [(prefetch (match_operand    0 "address_operand" "p")
             (match_operand:SI 1 "" "")
             (match_operand:SI 2 "" ""))]
   ""
{
        rtx (*gen_dtouchl) (rtx target, rtx op1, rtx op2) = TARGET_64 ? gen_dtouchl_di : gen_dtouchl_si;
	rtx addr = force_reg (Pmode, operands[0]);
	emit_insn (gen_dtouchl(addr, operands[1], operands[2]));
	DONE;
})

(define_insn "dzerol"
   [(unspec [(match_operand:SI 0 "memory_operand" "a,m")] UNSPEC_DZEROL)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
   ""
   "dzerol%m0 %0"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu,lsu_x")]
)

(define_insn "wpurge"
   [(unspec_volatile [(const_int 0)] UNSPEC_WPURGE)
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "wpurge"
[(set_attr "type" "lsu")]
)

(define_insn "invaldtlb"
   [(unspec_volatile [(const_int 0)] UNSPEC_INVALDTLB)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "invaldtlb "
[(set_attr "type" "bcu")]
)

(define_insn "invalitlb"
   [(unspec_volatile [(const_int 0)] UNSPEC_INVALITLB)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "invalitlb "
[(set_attr "type" "bcu")]
)

(define_insn "probetlb"
   [(unspec_volatile [(const_int 0)] UNSPEC_PROBETLB)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec_volatile [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "probetlb "
[(set_attr "type" "bcu")]
)

(define_insn "readtlb"
   [(unspec_volatile [(const_int 0)] UNSPEC_READTLB)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "readtlb "
[(set_attr "type" "bcu")]
)

(define_insn "writetlb"
   [(unspec_volatile [(const_int 0)] UNSPEC_WRITETLB)
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 0 "" "") 
         (unspec:SI [(match_dup 0)] UNSPEC_SYNC))]
   ""
   "writetlb "
[(set_attr "type" "all")]
)

(define_insn "ldc"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec_volatile:DI [(match_operand:DI 1 "memory_operand" "a,m")] 
          UNSPEC_LDC))]
   ""
   "aldcu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic_uncached,lsu_atomic_uncached_x")]
)

(define_insn "aldc"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec_volatile:DI [(match_operand:DI 1 "memory_operand" "a,m")] 
          UNSPEC_ALDC))]
   ""
   "aldc%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic,lsu_atomic_x")]
)

(define_insn "lbqz"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:SI 1 "memory_operand" "a,m")] 
          UNSPEC_LBQZ))]
   ""
   "lbqz%m1 %0 = %1"
[(set_attr "length" "4,8")
(set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "lbqzu"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:SI 1 "memory_operand" "a,m")] 
          UNSPEC_LBQZU))]
   ""
   "lbqzu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_insn "lbqs"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:SI 1 "memory_operand" "a,m")] 
          UNSPEC_LBQS))]
   ""
   "lbqs%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "lbqsu_"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:SI 1 "memory_operand" "a,m")] 
          UNSPEC_LBQSU))]
   ""
   "lbqsu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lbqsu"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:SI 1 "memory_operand" "a,m")] UNSPEC_LBQSU))
   ]
   ""
{
        rtx insn = gen_lbqsu_ (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})

(define_expand "acws"
  [(parallel
    [(set (match_operand:DI 0 "register_operand" "=r,=r")
          (unspec:DI [(match_operand:SI 1 "memory_operand" "+a,+m")] UNSPEC_ACWS))
     (set (match_dup 1)
          (unspec:SI
           [(match_dup 1)
            (match_operand:DI 2 "register_operand" "0,0")]
           UNSPEC_ACWS))])]
   ""
   {}
)

(define_insn "*acws"
    [(set (match_operand:DI 1 "register_operand" "+r,+r")
          (unspec:DI [(match_operand:SI 0 "memory_operand" "+a,+m")] UNSPEC_ACWS))
     (set (match_dup 0)
          (unspec:SI
           [(match_dup 0)
            (match_dup 1)]
           UNSPEC_ACWS))]
   ""
   "acws%m0 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic,lsu_atomic_x")]
)

(define_insn "afda"
[(set (match_operand:DI 0 "register_operand" "=r,r")
      (unspec_volatile:DI
	  [(match_operand:DI 1 "memory_operand" "+a,+m")
	   (match_operand:SI 3 "const_int_operand")]		;; model
       UNSPEC_AFDA))
   (set (match_dup 1)
	(plus:DI (match_dup 1)
                 (subreg:SI (match_operand:DI 2 "nonmemory_operand" "0,0") 0)))
]
   ""
   "afda%m0 %1 = %0"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic,lsu_atomic_x")]
)

(define_insn "afdau"
[(set (match_operand:DI 0 "register_operand" "=r,r")
      (unspec_volatile:DI
	  [(match_operand:DI 1 "memory_operand" "+a,+m")
	   (match_operand:SI 3 "const_int_operand")]		;; model
       UNSPEC_AFDAU))
 (set (match_dup 1)
      (plus:DI (match_dup 1)
               (subreg:SI (match_operand:DI 2 "nonmemory_operand" "0,0") 0)))
]
   ""
   "afdau%m0 %1 = %0"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic_uncached,lsu_atomic_uncached_x")]
)

(define_expand "cws"
  [(parallel
    [(set (match_operand:DI 0 "register_operand" "=r,=r")
          (unspec:DI [(match_operand:SI 1 "memory_operand" "+a,+m")] UNSPEC_CWS))
     (set (match_dup 1)
          (unspec:SI
           [(match_dup 1)
            (match_operand:DI 2 "register_operand" "0,0")]
           UNSPEC_CWS))])]
   ""
   {}
)

(define_insn "*cws"
    [(set (match_operand:DI 1 "register_operand" "+r,+r")
          (unspec:DI [(match_operand:SI 0 "memory_operand" "+a,+m")] UNSPEC_CWS))
     (set (match_dup 0)
          (unspec:SI
           [(match_dup 0)
            (match_dup 1)]
           UNSPEC_CWS))]
   ""
   "acwsu%m0 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_atomic,lsu_atomic_x")]
)

(define_expand "memory_barrier"
  [(clobber (mem:BLK (scratch)))]
  ""
  {
  	emit_insn (gen_dinval (k1_sync_reg_rtx));
	emit_insn (gen_wpurge (k1_sync_reg_rtx));
	emit_insn (gen_fence (k1_sync_reg_rtx));
  }
)

(define_expand "sync_compare_and_swapsi"
  [(use (match_operand:SI 0 "register_operand" ""))   ; Result = old memory if successful
   (use (match_operand:SI 1 "memory_operand" ""))     ; Memory location
   (use (match_operand:SI 2 "register_operand" ""))   ; Old value to compare against
   (use (match_operand:SI 3 "register_operand" ""))]  ; New value to store if successful
  ""
  {
	rtx reg = gen_reg_rtx (DImode);
	emit_insn (gen_rtx_CLOBBER (DImode, reg));
	emit_move_insn (gen_lowpart (SImode, reg), operands[3]);
	emit_move_insn (gen_highpart (SImode, reg), operands[2]);
	emit_insn (gen_memory_barrier ()),
	emit_insn (gen_cws (reg, operands[1], reg));
	emit_move_insn (operands[0], gen_lowpart (SImode, reg));
	
	DONE;
  }
)

; `sync_old_addmode', `sync_old_submode'
; `sync_old_iormode', `sync_old_andmode'
; `sync_old_xormode', `sync_old_nandmode'
(define_code_iterator sync_it [plus ior xor minus and mult])
(define_code_attr sync_op [(plus "add") (ior "ior") (xor "xor") (minus "sub") (and "and") (mult "nand")])
(define_code_attr sync_op_code [(plus "PLUS") (ior "IOR") (xor "XOR") (minus "MINUS") (and "AND") (mult "NOT")])

(define_expand "sync_old_<sync_op>si"
  [(set (match_operand:SI 0 "register_operand" "")                 ; Result = old memory if successful
  	(sync_it:SI (match_operand:SI 1 "memory_operand" "")       ; Memory location
		    (match_operand:SI 2 "nonmemory_operand" "")))] ; Value
  ""
  {
	k1_expand_old_sync_instruction (<sync_op_code>, operands[0], operands[1], operands[2]);
	DONE;
  }
)

(define_expand "sync_new_<sync_op>si"
  [(set (match_operand:SI 0 "register_operand" "")                 ; Result = old memory if successful
  	(sync_it:SI (match_operand:SI 1 "memory_operand" "")       ; Memory location
		    (match_operand:SI 2 "nonmemory_operand" "")))] ; Value
  ""
  {
	k1_expand_new_sync_instruction (<sync_op_code>, operands[0], operands[1], operands[2]);
	DONE;
  }
)

(define_expand "sync_<sync_op>si"
  [(set (match_operand:SI 0 "memory_operand" "")                 ; Memory
  	(sync_it:SI (match_dup 0)      
		    (match_operand:SI 1 "nonmemory_operand" "")))] ; Value
  ""
  {
	k1_expand_sync_instruction (<sync_op_code>, operands[0], operands[1]);
	DONE;
  }
)

(define_expand "sync_lock_test_and_setsi"
  [(use (match_operand:SI 0 "register_operand" ""))   ; Result = old memory if successful
   (use (match_operand:SI 1 "memory_operand" ""))     ; Memory location
   (use (match_operand:SI 2 "register_operand" ""))]  ; New value to store if successful
  ""
  {
	k1_expand_old_sync_instruction (SET, operands[0], operands[1], operands[2]);
	DONE;
  }
)


;; FIXME AUTO: disable as no more uncached store.
;; (define_expand "sync_lock_releasesi"
;;   [(use (match_operand:SI 0 "memory_operand" ""))    ; Result = old memory if successful
;;    (use (match_operand:SI 1 "register_operand" ""))] ; New value to store if successful
;;   ""
;;   {
;; 	emit_insn (gen_memory_barrier ());
;; 	emit_insn (gen_swu (operands[0], force_reg (SImode, operands[1])));
;; 	DONE;
;;   }
;; )



(define_insn "ldu_"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:DI 1 "memory_operand" "a,m")] UNSPEC_LDU))
   ]
   ""
   "ldu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "ldu"
   [(set (match_operand:DI 0 "register_operand" "=r,=r")
         (unspec:DI [(match_operand:DI 1 "memory_operand" "a,m")] UNSPEC_LDU))
   ]
   ""
{
        rtx insn = gen_ldu_ (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})


(define_insn "lwzu_"
   [(set (match_operand:SI 0 "register_operand" "=r,=r")
         (unspec:SI [(match_operand:SI 1 "memory_operand" "a,m")] UNSPEC_LWZU))
   ]
   ""
   "lwzu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lwzu"
   [(set (match_operand:SI 0 "register_operand" )
         (unspec:SI [(match_operand:SI 1 "memory_operand" )] UNSPEC_LWZU))
   ]
   ""
{
        rtx insn = gen_lwzu_ (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})

;; (define_insn "movqi_real"
;;    [(set (match_operand:QI 0 "nonimmediate_operand" "=r,r,r,r,a,m")
;;          (match_operand:QI 1 "general_operand"      "I08,r,a,m,r,r"))]
;;    "(!(memory_operand(operands[0], QImode) && immediate_operand(operands[1], QImode))) /* MEM = IMM */
;;      && !(memory_operand(operands[0], QImode) && memory_operand(operands[1], QImode)) /* MEM = MEM */
;;      && !((memory_operand(operands[0], QImode) || memory_operand(operands[1], QImode)) && K1_FORCE_UNCACHED_LSU)
;; "
;; 
;;    "@
;;    make %0 = %1
;;    copy %0 = %1
;;    lbs%m1  %0 = %1
;;    lbs%m1  %0 = %1
;;    sb%m0   %0 = %1
;;    sb%m0   %0 = %1"
;; [(set_attr "type" "tiny,tiny,lsu_load,lsu_load_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,4,4,8,4,8")]
;; )

;; (define_insn "movqi_real_uncached"
;;    [(set (match_operand:QI 0 "nonimmediate_operand" "=r,r,a,m")
;;          (match_operand:QI 1 "nonimmediate_operand" " a,m,r,r"))]
;;    "!(register_operand(operands[0], QImode) && register_operand(operands[1], QImode))
;;     && !(memory_operand(operands[0], QImode) && memory_operand(operands[1], QImode)) /* MEM = MEM */
;;     && K1_FORCE_UNCACHED_LSU"
;;    "@
;;    lbsu%m1  %0 = %1
;;    lbsu%m1  %0 = %1
;;    sbu%m0   %0 = %1
;;    sbu%m0   %0 = %1"
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_expand "movqi"
;;    [(set (match_operand:QI 0 "nonimmediate_operand" "")
;;          (match_operand:QI 1 "general_operand" ""))]
;;    ""
;; {
;;         if (MEM_P (operands[0])) {
;;            operands[1] = force_reg (QImode, operands[1]);
;;         }
;; })

;; (define_insn "*movhi_real"
;;    [(set (match_operand:HI 0 "nonimmediate_operand" "=r,  r, r, r, r, a, m")
;;          (match_operand 1 "general_operand"         "I16, i ,r, a, m, r, r"))]
;;    "(!immediate_operand(operands[1], HImode) || !memory_operand(operands[0], HImode))
;;     && !(memory_operand(operands[0], HImode) && memory_operand(operands[1], HImode)) /* MEM = MEM */
;;     && !((memory_operand(operands[0], HImode) || memory_operand(operands[1], HImode)) && K1_FORCE_UNCACHED_LSU)"
;; {
;;     switch (which_alternative) {
;;     	   case 0:
;;     	   case 1: return "make %0 = %1";
;; 	   case 2: return "copy %0 = %1";
;; 	   case 3:
;; 	   case 4: return "lhs%m1 %0 = %1";
;;            case 5:
;;            case 6: return "sh%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "tiny,tiny_x,tiny,lsu_load,lsu_load_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,4,8,4,8")]
;; )

;; (define_insn "*movhi_real_uncached"
;;    [(set (match_operand:HI 0 "nonimmediate_operand" "=r, r, a, m")
;;          (match_operand 1    "nonimmediate_operand" " a, m, r, r"))]
;;    "!(memory_operand(operands[0], HImode) && memory_operand(operands[1], HImode))
;;     && !(register_operand(operands[0], HImode) && register_operand(operands[1], HImode))
;;     && K1_FORCE_UNCACHED_LSU"
;; 
;; {
;;     switch (which_alternative) {
;;     	   case 0:
;;     	   case 1: return "lhsu%m1 %0 = %1";
;; 	   case 2:
;; 	   case 3: return "shu%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_expand "movhi"
;;    [(set (match_operand:HI 0 "nonimmediate_operand" )
;;          (match_operand:HI 1 "general_operand" ))]
;;    ""
;; {
;; 	if (k1_expand_mov (operands)) {
;; 	   DONE;
;; 	}
;; 
;;         // if (MEM_P (operands[0])) {
;;         //    operands[1] = force_reg (HImode, operands[1]);
;;         // }
;; }
;; )

(define_insn "*lhs"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (sign_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
   "!K1_FORCE_UNCACHED_LSU"
{
   return "lhs%m1 %0 = %1";
}
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "*lhs_uncached"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (sign_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
   "K1_FORCE_UNCACHED_LSU"
{
   return "lhsu%m1 %0 = %1";
}
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_insn "lhsu_k1b"
   [(set (match_operand:HI 0 "register_operand" "=r,r")
         (unspec:HI [(match_operand:HI 1 "memory_operand" "a,m")] UNSPEC_LHSU))]
   ""
   "lhsu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lhsu"
   [(set (match_operand:HI 0 "register_operand" "=r,r")
         (unspec:HI [(match_operand:HI 1 "memory_operand" "a,m")] UNSPEC_LHSU))]
   ""
{
        rtx insn = gen_lhsu_k1b (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})


(define_insn "*lhz"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (zero_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
   "!K1_FORCE_UNCACHED_LSU"
{
   return "lhz%m1 %0 = %1";
}
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "*lhz_uncached"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (zero_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
   "K1_FORCE_UNCACHED_LSU"
{
   return "lhzu%m1 %0 = %1";
}
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_insn "lhzu_k1b"
   [(set (match_operand:HI 0 "register_operand" "=r,r")
         (unspec:HI [(match_operand:HI 1 "memory_operand" "a,m")] UNSPEC_LHZU))]
   ""
   "lhzu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lhzu"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (unspec:HI [(match_operand:HI 1 "memory_operand" "a,m")] UNSPEC_LHZU))]
   ""
{
        rtx insn = gen_lhzu_k1b (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})

(define_insn "*lbs"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (sign_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
   "!K1_FORCE_UNCACHED_LSU"
   "lbs%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "*lbs_uncached"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (sign_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
   "K1_FORCE_UNCACHED_LSU"
   "lbsu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_insn "lbsu_k1b"
   [(set (match_operand:QI 0 "register_operand" "=r,r")
         (unspec:QI [(match_operand:QI 1 "memory_operand" "a,m")] UNSPEC_LBSU))]
   ""
   "lbsu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lbsu"
   [(set (match_operand:QI 0 "register_operand" "=r,r")
         (unspec:QI [(match_operand:QI 1 "memory_operand" "a,m")] UNSPEC_LBSU))]
   ""
{
        rtx insn = gen_lbsu_k1b (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})

(define_insn "*lbz"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (zero_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
   "!K1_FORCE_UNCACHED_LSU"
   "lbz%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load,lsu_load_x")]
)

(define_insn "*lbz_uncached"
   [(set (match_operand:SI 0 "register_operand" "=r,r")
         (zero_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
   "K1_FORCE_UNCACHED_LSU"
   "lbzu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_insn "lbzu_k1b"
   [(set (match_operand:QI 0 "register_operand" "=r,=r")
         (unspec:QI [(match_operand:QI 1 "memory_operand" "a,m")] UNSPEC_LBZU))]
   ""
   "lbzu%m1 %0 = %1"
[(set_attr "length" "4,8")
 (set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
)

(define_expand "lbzu"
   [(set (match_operand:QI 0 "register_operand" "=r,=r")
         (unspec:QI [(match_operand:QI 1 "memory_operand" "a,m")] UNSPEC_LBZU))]
   ""
{
        rtx insn = gen_lbzu_k1b (operands[0], operands[1]);
        MEM_VOLATILE_P(operands[1]) = 1;
        emit_insn (insn);
        DONE;
})

;; (define_insn "*real_movsi"
;;    [(set (match_operand:SI 0 "nonimmediate_operand" "=r, r, r, a, m, r  , r")
;;          (match_operand:SI 1 "movsi_operand"         "r, a, m, r, r, I16, i"))]
;;    "   !(immediate_operand(operands[1], SImode) && memory_operand(operands[0], SImode))
;;     && !(memory_operand(operands[0], SImode) && memory_operand(operands[1], SImode))
;;     && !((memory_operand(operands[0], SImode) || memory_operand(operands[1], SImode)) && K1_FORCE_UNCACHED_LSU)"
;; {
;;     switch (which_alternative) {
;;     	   case 0: return "copy %0 = %1";
;; 	   case 1:
;;     	   case 2: return "lws%m1 %0 = %1";
;; 	   case 3:
;;     	   case 4: return "sw%m0 %0 = %1";
;;            case 5:
;;     	   case 6: return "make %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "tiny,lsu_load,lsu_load_x,lsu_store,lsu_store_x,tiny,tiny_x")
;;  (set_attr "length" "4,4,8,4,8,4,8")]
;; )

;; Only used when K1_FORCE_UNCACHED_LSU is used
;; (define_insn "*movsi_uncached"
;;    [(set (match_operand:SI 0 "nonimmediate_operand" "=r, r, a, m")
;;          (match_operand:SI 1 "nonimmediate_operand" " a, m, r, r"))]
;;    "   !(memory_operand(operands[0], SImode) && memory_operand(operands[1], SImode))
;;     && !(register_operand(operands[0], SImode) && register_operand(operands[1], SImode))
;;     && K1_FORCE_UNCACHED_LSU"
;; {
;;     switch (which_alternative) {
;;     	   case 0:
;; 	   case 1: return "lwsu%m1 %0 = %1";
;;     	   case 2:
;; 	   case 3: return "swu%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_expand "movsi"
;;    [(set (match_operand:SI 0 "nonimmediate_operand" "")
;;          (match_operand:SI 1 "general_operand" ""))]
;;    ""
;; {
;; 	if (k1_expand_mov (operands)) {
;; 	   DONE;
;; 	}
;; })

/* We define an explicit movsf pattern rather than relying on the movsi, 
   because movsi will generate (subreg:SF (reg:SI)) kind of patterns that 
   make our work when looking for mems to pack more difficult. */
;; (define_insn "movsf_real"
;;    [(set (match_operand:SF 0 "nonimmediate_operand" "=r,r,r,a,m,r,r")
;;          (match_operand 1 "general_operand" "r,a,m,r,r,H16,F"))]
;;    "(!immediate_operand(operands[1], SFmode) || !memory_operand(operands[0], SFmode))
;;     && !((memory_operand(operands[0], SFmode) || memory_operand(operands[1], SFmode)) && K1_FORCE_UNCACHED_LSU)"
;; {
;;     switch (which_alternative) {
;;     	   case 0: return "copy %0 = %1";
;; 	   case 1:
;;     	   case 2: return "lw%m1 %0 = %1";
;; 	   case 3:
;;     	   case 4: return "sw%m0 %0 = %1";
;; 	   case 5:
;; 	   case 6: return "make %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "tiny,lsu_load,lsu_load_x,lsu_store,lsu_store_x,tiny,tiny_x")
;;  (set_attr "length" "4,4,8,4,8,4,8")]
;; )

;; (define_insn "*movsf_uncached"
;;    [(set (match_operand:SF 0 "nonimmediate_operand" "=r,r,a,m")
;;          (match_operand 1    "nonimmediate_operand" " a,m,r,r"))]
;;  "   !(memory_operand(operands[0], SFmode) && memory_operand(operands[1], SFmode))
;;   && !(register_operand(operands[0], SFmode) && register_operand(operands[1], SFmode))
;;   && K1_FORCE_UNCACHED_LSU"
;; {
;;     switch (which_alternative) {
;;     	   case 0:
;; 	   case 1: return "lwu%m1 %0 = %1";
;;     	   case 2:
;; 	   case 3: return "swu%m0 %0 = %1";
;; 	   default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_expand "movsf"
;;    [(set (match_operand:SF 0 "nonimmediate_operand" )
;;          (match_operand:SF 1 "general_operand" ))]
;;    ""
;; {
;;         if (MEM_P (operands[0])) {
;;            operands[1] = force_reg (SFmode, operands[1]);
;;         }
;; })

/* Define the packed load patterns that we might generate.  */

(define_insn "*double_loadhi"
   [(set (subreg:HI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)])))
    (set (subreg:HI (match_dup 0) 4)
         (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)])))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "lhps%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadhi_uncached"
   [(set (subreg:HI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)])))
    (set (subreg:HI (match_dup 0) 4)
         (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)])))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "lhpsu%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadhis"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (sign_extend:SI (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)]))))
    (set (subreg:SI (match_dup 0) 4)
         (sign_extend:SI (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)]))))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "lhps%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadhis_uncached"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (sign_extend:SI (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)]))))
    (set (subreg:SI (match_dup 0) 4)
         (sign_extend:SI (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)]))))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "lhpsu%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)


(define_insn "*double_loadhiz"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (zero_extend:SI (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)]))))
    (set (subreg:SI (match_dup 0) 4)
         (zero_extend:SI (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)]))))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "lhpz%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "builtin_lhpz"
 [(set (match_operand:V2SI 0 "register_operand" "=r,r")
       (unspec:V2SI [(match_operand:V2HI 1 "memory_operand" "a,m")] UNSPEC_LHPZ))]
 ""
 "lhpz%m1 %0 = %1"
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "builtin_lhpzu"
 [(set (match_operand:V2SI 0 "register_operand" "=r,r")
       (unspec:V2SI [(match_operand:V2HI 1 "memory_operand" "a,m")] UNSPEC_LHPZU))]
 ""
 "lhpzu%m1 %0 = %1"
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)

(define_insn "builtin_lhpzn"
 [(set (match_operand:V2SI 0 "register_operand" "=r,r")
       (unspec:V2SI [(match_operand:V2HI 1 "memory_operand" "a,m")] UNSPEC_LHPZN))]
 ""
 "lhpzn%m1 %0 = %1"
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "builtin_lhpzun"
 [(set (match_operand:V2SI 0 "register_operand" "=r,r")
       (unspec:V2SI [(match_operand:V2HI 1 "memory_operand" "a,m")] UNSPEC_LHPZUN))]
 ""
 "lhpzun%m1 %0 = %1"
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)


(define_insn "*double_loadhiz_uncached"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (zero_extend:SI (vec_select:HI (match_operand:V2HI 1 "memory_operand" "a,m") (parallel [(const_int 0)]))))
    (set (subreg:SI (match_dup 0) 4)
         (zero_extend:SI (vec_select:HI (match_operand:V2HI 2 "memory_operand" "1,1") (parallel [(const_int 1)]))))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "lhpzu%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadsi<mode>"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:SI (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "ld%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadsi_uncached<mode>"
   [(set (subreg:SI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:SI (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "ldu%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)


(define_insn "*double_loadsf<mode>"
   [(set (subreg:SF (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:SF (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "ld%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadsf_uncached<mode>"
   [(set (subreg:SF (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:SF (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "ldu%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadv2hi<mode>"
   [(set (subreg:V2HI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:V2HI (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "packed_memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "ld%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load,lsu_load_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_loadv2hi_uncached<mode>"
   [(set (subreg:V2HI (match_operand:DI 0 "register_operand" "=r,=r") 0)
         (subreg:V2HI (match_operand:DI 1 "memory_operand" "a,m") 0))
    (set (subreg:SISIZE (match_dup 0) 4)
         (subreg:SISIZE (match_operand:DI 2 "packed_memory_operand" "1,1") 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "ld%m1 %0 = %1";
   }
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")
 (set_attr "length" "4,8")]
)


(define_expand "double_load"
   [(parallel [(set (match_operand 0 "register_operand" "=r,=r")
                    (match_operand 1 "" ""))
               (set (match_operand 2 "register_operand" "=r,=r")
	            (match_operand 3 "" ""))
	       (unspec [(const_int 0)] UNSPEC_LOAD)])]
   ""
   {}
)

(define_insn "*double_storesi<mode>"
   [(set (subreg:SI (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:SI (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "sd%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_storesi_uncached<mode>"
   [(set (subreg:SI (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:SI (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "sdu%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_storesf<mode>"
   [(set (subreg:SF (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:SF (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "packed_memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "sd%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_storesf_uncached<mode>"
   [(set (subreg:SF (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:SF (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "packed_memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "sdu%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_storev2hi<mode>"
   [(set (subreg:V2HI (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:V2HI (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "!K1_FORCE_UNCACHED_LSU"
   {
	return "sd%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_insn "*double_storev2hi_uncached<mode>"
   [(set (subreg:V2HI (match_operand:DI 0 "memory_operand" "=a,=m") 0)
         (subreg:V2HI (match_operand:DI 1 "register_operand" "r,r") 0))
    (set (subreg:SISIZE (match_operand:DI 2 "memory_operand" "=0,=0") 4)
         (subreg:SISIZE (match_dup 1) 4))
    (unspec [(const_int 0)] UNSPEC_LOAD)]
   "K1_FORCE_UNCACHED_LSU"
   {
	return "sdu%m0 %0 = %1";
   }
[(set_attr "type" "lsu_store,lsu_store_x")
 (set_attr "length" "4,8")]
)

(define_expand "double_store"
   [(parallel [(set (match_operand 0 "" "")
                    (match_operand 1 "register_operand" "r,r"))
               (set (match_operand 2 "" "")
	            (match_operand 3 "register_operand" "r,r"))
	       (unspec [(const_int 0)] UNSPEC_LOAD)])]
   ""
   {
   }
)

;; (define_expand "movdi"
;;    [(set (match_operand:DI 0 "nonimmediate_operand" )
;;          (match_operand:DI 1 "general_operand" ))]
;;    ""
;; {
;; 	if (k1_expand_mov (operands)) {
;; 	   DONE;
;; 	}
;; 
;; /*        if (MEM_P(operands[0]) && can_create_pseudo_p()) {
;;            rtx reg = gen_reg_rtx(DImode);
;;            emit_move_insn (reg, operands[1]);
;;            operands[1] = reg;
;;         }
;; 	*/
;; }
;; )

;; general insn for materializing symbol in paired register
;; Will also capture more complex move : @gotoff('sym' + offset)

;; FIXME AUTO: coolidge lacks materialization of 64bits symbol
;; (define_insn "*movdi_symbol_k1b"
;;    [(set (match_operand:DI 0 "register_operand" "=r")
;;          (match_operand:DI 1 "k1_symbol_operand" "S"))]
;; ""
;; "maked %0 = %1"
;; [(set_attr "type" "alud_tiny_x")
;;  (set_attr "length" "8")])

;; (define_insn "*movdi_real_immediate"
;;    [(set (match_operand:DI 0 "register_operand"   "=r,  r")
;;          (match_operand:DI 1 "const_int_43b_operand" "I16, I43"))]
;;  ""
;; "maked %0 = %1"
;; [(set_attr "type" "alud_tiny,alud_tiny_x")
;;  (set_attr "length" "4,8")])

;; (define_insn "*movdi_real_k1b"
;;    [(set (match_operand:DI 0 "nonimmediate_operand" "=r, r, r, a, m")
;;          (match_operand:DI 1 "general_operand"      " r, a, m, r, r"))]
;;     "  !(memory_operand(operands[0], DImode) && immediate_operand(operands[1], DImode))
;;     && !(memory_operand(operands[0], DImode) && memory_operand(operands[1], DImode))
;;     && !((memory_operand(operands[0], DImode) || memory_operand(operands[1], DImode)) && K1_FORCE_UNCACHED_LSU)"
;; {
;;  switch(which_alternative){
;;  case 0:
;;       return "copyd %0 = %1";
;;  case 1:
;;  case 2:
;;       return "ld%m1 %0 = %1";
;;  case 3:
;;  case 4:
;;       return "sd%m0 %0 = %1";
;;  default : gcc_unreachable ();
;;  }
;; }
;; [(set_attr "type" "alud_lite, lsu_load, lsu_load_x, lsu_store, lsu_store_x")
;;  (set_attr "length" "4,4,8,4,8")])

;; (define_insn "*movdi_uncached_k1b"
;;    [(set (match_operand:DI 0 "nonimmediate_operand" "=r, r, a, m")
;;          (match_operand:DI 1 "nonimmediate_operand" " a, m, r, r"))]
;;    "   !(memory_operand(operands[0], DImode) && memory_operand(operands[1], DImode))
;;     && !(register_operand(operands[0], DImode) && register_operand(operands[1], DImode))
;;     && K1_FORCE_UNCACHED_LSU"
;; {
;;  switch(which_alternative){
;;  case 0:
;;  case 1: return "ldu%m1 %0 = %1";
;;  case 2:
;;  case 3: return "sdu%m0 %0 = %1";
;;  default : gcc_unreachable ();
;;  }
;; }
;; [(set_attr "type" "lsu_load_uncached, lsu_load_uncached_x, lsu_store, lsu_store_x")
;;  (set_attr "length" "4,8,4,8")])

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "zero_extendqisi2"
;;   [(set (match_operand:SI 0 "register_operand" )
;; 	(zero_extend:SI (match_operand:QI 1 "nonimmediate_operand" )))])
;; 
;; (define_insn "*zero_extendqisi2_cached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;; 	(zero_extend:SI (match_operand:QI 1 "nonimmediate_operand" "r,a,m")))]
;;   "!(memory_operand(operands[1], QImode) && K1_FORCE_UNCACHED_LSU)"
;;   "@
;;   zxb %0 = %1
;;   lbz%m1 %0 = %1
;;   lbz%m1 %0 = %1"
;;   [(set_attr "type" "extfz,lsu_load,lsu_load_x")]
;; )
;; 
;; FIXME AUTO: disable zero extend until insn are back
;; (define_insn "*zero_extendqisi2_uncached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r")
;; 	(zero_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
;;   "K1_FORCE_UNCACHED_LSU"
;;   "@
;;   lbzu%m1 %0 = %1
;;   lbzu%m1 %0 = %1"
;;   [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
;; )

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "zero_extendhisi2"
;;   [(set (match_operand:SI 0 "register_operand" )
;;        (zero_extend:SI (match_operand:HI 1 "nonimmediate_operand")))])
;; 
;; (define_insn "*zero_extendhisi2_cached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;;        (zero_extend:SI (match_operand:HI 1 "nonimmediate_operand" "r,a,m")))]
;;  "!(memory_operand(operands[1], HImode) && K1_FORCE_UNCACHED_LSU)"
;;  "@
;;   zxh %0 = %1
;;   lhz%m1 %0 = %1
;;   lhz%m1 %0 = %1"
;;   [(set_attr "type" "extfz,lsu_load,lsu_load_x")])

;; FIXME AUTO: disable zero extend until insn are back
;; (define_insn "*zero_extendhisi2_uncached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r")
;; 	(zero_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
;;   "K1_FORCE_UNCACHED_LSU"
;;   "@
;;   lhzu%m1 %0 = %1
;;   lhzu%m1 %0 = %1"
;;   [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")]
;; )

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "extendqisi2"
;;   [(set (match_operand:SI 0 "register_operand" )
;; 	(sign_extend:SI (match_operand:QI 1 "nonimmediate_operand" )))])
;; 

;; FIXME AUTO: disable zero extend until insn are back
;; (define_insn "*extendqisi2_cached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;; 	(sign_extend:SI (match_operand:QI 1 "nonimmediate_operand" "r,a,m")))]
;;  "!(memory_operand(operands[1], QImode) && K1_FORCE_UNCACHED_LSU)"
;;   "@
;;   sxb %0 = %1
;;   lbs%m1 %0 = %1
;;   lbs%m1 %0 = %1"
;;   [(set_attr "type" "extfs,lsu_load,lsu_load_x")])

;; FIXME AUTO: disable zero extend until insn are back
;; (define_insn "*extendqisi2_uncached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r")
;; 	(sign_extend:SI (match_operand:QI 1 "memory_operand" "a,m")))]
;;   "K1_FORCE_UNCACHED_LSU"
;;   "@
;;   lbsu%m1 %0 = %1
;;   lbsu%m1 %0 = %1"
;;   [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")])

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "extendhisi2"
;;   [(set (match_operand:SI 0 "register_operand" )
;; 	(sign_extend:SI (match_operand:HI 1 "nonimmediate_operand" )))])
;; 
;; FIXME AUTO: disable zero extend until insn are back
;; (define_insn "*extendhisi2_cached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r")
;; 	(sign_extend:SI (match_operand:HI 1 "nonimmediate_operand" "r,a,m")))]
;;    "!(memory_operand(operands[1], HImode) && K1_FORCE_UNCACHED_LSU)"
;;   "@
;;   sxh %0 = %1
;;   lhs%m1 %0 = %1
;;   lhs%m1 %0 = %1"
;;   [(set_attr "type" "extfs,lsu_load,lsu_load_x")])

;; FIXME AUTO: disable extend until insn are back
;; (define_insn "*extendhisi2_uncached"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r")
;; 	(sign_extend:SI (match_operand:HI 1 "memory_operand" "a,m")))]
;;    "K1_FORCE_UNCACHED_LSU"
;;   "@
;;   lhs%m1 %0 = %1
;;   lhs%m1 %0 = %1"
;;   [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x")])

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "zero_extendqidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(zero_extend:DI (match_operand:QI 1 "nonimmediate_operand" "r")))]
;;   ""
;; {
;; rtx lowpart = gen_lowpart (SImode, operands[0]);
;; rtx highpart = gen_highpart (SImode, operands[0]);
;; 
;; if (!reg_mentioned_p (operands[0], operands[1]))
;;    emit_clobber (operands[0]);
;; emit_move_insn (highpart, GEN_INT (0));
;; emit_insn (gen_zero_extendqisi2 (lowpart, operands[1]));
;; DONE;
;; })

;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "zero_extendhidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(zero_extend:DI (match_operand:HI 1 "nonimmediate_operand" "r")))]
;;   ""
;; {
;; rtx lowpart = gen_lowpart (SImode, operands[0]);
;; rtx highpart = gen_highpart (SImode, operands[0]);
;; 
;; if (!reg_mentioned_p (operands[0], operands[1]))
;;    emit_clobber (operands[0]);
;; emit_move_insn (highpart, GEN_INT (0));
;; emit_insn (gen_zero_extendhisi2 (lowpart, operands[1]));
;; DONE;
;; })


;; FIXME AUTO: no more sxbd insn in coolidge
;; (define_insn "extendqidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(sign_extend:DI (match_operand:QI 1 "register_operand" "r")))]
;;   ""
;;   "sxbd %d0 = %1"
;;   [(set_attr "type" "alud_x")
;;    (set_attr "length" "8")]
;; )

;; FIXME AUTO: no more sxhd insn
;; (define_insn "extendhidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(sign_extend:DI (match_operand:HI 1 "register_operand" "r")))]
;;   ""
;;   "sxhd %d0 = %1"
;;   [(set_attr "type" "alud_x")
;;    (set_attr "length" "8")]
;; )

/* This instruction has the same size as make + copy, but is far less schedule-friendly. */
;; FIXME AUTO: disable zero extend until insn are back
;; (define_expand "zero_extendsidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(zero_extend:DI (match_operand:SI 1 "register_operand" "r")))]
;;   ""
;; {
;; rtx lowpart = gen_lowpart (SImode, operands[0]);
;; rtx highpart = gen_highpart (SImode, operands[0]);
;; 
;; if (!reg_mentioned_p (operands[0], operands[1]))
;;    emit_clobber (operands[0]);
;; emit_move_insn (highpart, GEN_INT (0));
;; emit_move_insn (lowpart, operands[1]);
;; DONE;
;; })


;; FIXME AUTO: no more sxwd insn
;; (define_insn "extendsidi2"
;;   [(set (match_operand:DI 0 "register_operand" "=r")
;; 	(sign_extend:DI (match_operand:SI 1 "register_operand" "r")))]
;;   ""
;;   "sxwd %d0 = %1"
;;   [(set_attr "type" "alud_x")
;;    (set_attr "length" "8")]
;; )

(define_insn "stsu"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_STSU))]
  ""
  "stsu %0 = %1, %2"
[(set_attr "type" "stsu")]
)

(define_insn "stsud"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "register_operand" "r")] UNSPEC_STSUD))]
  ""
  "stsud %0 = %1, %2"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

(define_expand "bswapdi2"
  [(set (match_operand:DI 0 "register_operand")
        (bswap:DI (match_operand:DI 1 "nonmemory_operand")))]
  ""
{
	/* multiply by transposed identity */
	rtx inv_mat = gen_rtx_CONST_INT(VOIDmode, 0x0102040810204080);
	emit_insn(gen_sbmm8(operands[0], operands[1], inv_mat));
	DONE;
})

(define_insn "*sbmm8_k1b"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "register_operand" "r")] UNSPEC_SBMM8))]
""
"sbmm8 %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")])


;; FIXME AUTO: disable as there is no valid coolidge insn
;; (define_insn "sbmm8l"
;;   [(set (match_operand:DI 0 "register_operand" "=r,r,r")
;; 	(unspec:DI [(match_operand:DI 1 "register_operand" "r,r,r")
;; 		    (match_operand:DI 2 "nonmemory_operand" "r,I32,i")] UNSPEC_SBMM8L))]
;; ""
;; "sbmm8l %d0 = %d1, %d2"
;; [(set_attr "type" "alud_x,alud_y,alud_z")
;;  (set_attr "length" "8,12,16")])

;; FIXME AUTO: disabled immediate variant insn
(define_insn "sbmm8"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "nonmemory_operand" "r")] UNSPEC_SBMM8))]
  "REG_P(operands[2]) || current_pass->tv_id != TV_CPROP"
  "sbmm8 %0 = %1, %2"
  [(set_attr "type" "alud_x") ;; ,alud_y,alud_z
   (set_attr "length" "8")] ;; ,12,16
)

(define_insn "sbmmt8"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "register_operand" "r")] UNSPEC_SBMMT8))]
""
"sbmmt8 %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")])

;; FIXME AUTO: disabled sbmm8 with OPXD syntax
;; (define_insn "*sbmm8"
;;   [(parallel [(set (match_operand:SI 0 "register_operand" "=r,=r")
;;   	     	   (subreg:SI (unspec:DI [(concat (match_operand:SI 2 "register_operand" "r,r")
;;   		   	      		  	  (match_operand:SI 3 "register_operand" "r,r"))
;; 					  (concat (match_operand:SI 4 "nonmemory_operand" "r,i")
;; 					  	  (match_operand:SI 5 "nonmemory_operand" "r,i"))] UNSPEC_SBMM8) 0))
;; 	       (set (match_operand:SI 1 "register_operand" "=r,=r")
;;   	     	   (subreg:SI (unspec:DI [(concat (match_dup 2)
;;   		   	      		  	  (match_dup 3))
;; 					  (concat (match_dup 4)
;; 					  	  (match_dup 5))] UNSPEC_SBMM8) 4))
;;    		])]
;;   ""
;;   "sbmm8 %0:%1 = %2:%3, %u4:%u5"
;;   [(set_attr "type" "alud_x,alud_z")
;;    (set_attr "length" "8,16")]
;; )

;; (define_insn "*sbmmt8"
;;   [(parallel [(set (match_operand:SI 0 "register_operand" "=r,=r")
;;   	     	   (subreg:SI (unspec:DI [(concat (match_operand:SI 2 "register_operand" "r,r")
;;   		   	      		  	  (match_operand:SI 3 "register_operand" "r,r"))
;; 					  (concat (match_operand:SI 4 "nonmemory_operand" "r,i")
;; 					  	  (match_operand:SI 5 "nonmemory_operand" "r,i"))] UNSPEC_SBMMT8) 0))
;; 	       (set (match_operand:SI 1 "register_operand" "=r,=r")
;;   	     	   (subreg:SI (unspec:DI [(concat (match_dup 2)
;;   		   	      		  	  (match_dup 3))
;; 					  (concat (match_dup 4)
;; 					  	  (match_dup 5))] UNSPEC_SBMMT8) 4))
;;    		])]
;;   ""
;;   "sbmmt8 %0:%1 = %2:%3, %u4:%u5"
;;   [(set_attr "type" "alud_x,alud_z")
;;    (set_attr "length" "8,16")]
;; )

(define_insn "bwluhp"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")
		    (match_operand 3 "immediate_operand" "i")] UNSPEC_BWLUHP))]
  ""
  "bwluhp %0 = %1, %2, %u3"
  [(set_attr "type" "bwluhp")
   (set_attr "length" "8")]
)

(define_insn "bwluwp"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "register_operand" "r")
		    (match_operand 3 "immediate_operand" "i")] UNSPEC_BWLUWP))]
  ""
  "bwluwp %0 = %1, %2, %u3"
  [(set_attr "type" "alud_lite_x")
   (set_attr "length" "8")]
)

(define_insn "bwlu"
  [(set (match_operand:SI 0 "register_operand" "=r")
        (unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")
		    (match_operand:SI 3 "register_operand" "r")
		    (match_operand:SI 4 "register_operand" "r")
		    (match_operand 5 "immediate_operand" "i")] UNSPEC_BWLU))]
  ""
  "bwlu %0 = %1:%2, %3:%4, %u5"
  [(set_attr "type" "alud_y")
   (set_attr "length" "12")]
)

/* Both operand pairs could be markes as commutative, but GCC currently only 
   supports one commutative pair per-instruction. see reload.c:find_reloads */
;; FIXME AUTO: disable bwlu
;; (define_insn "*bwlu"
;;   [(set (match_operand:SI 0 "register_operand" "=r")
;;         (match_operator:SI 7 "bitwise_operator"
;; 	   [(match_operator:SI 5 "bitwise_operator"
;; 		[(match_operand:SI 1 "register_operand" "%r")
;; 		 (match_operand:SI 2 "register_operand" "r")])
;; 	    (match_operator:SI 6 "bitwise_operator"
;; 		[(match_operand:SI 3 "register_operand" "r")
;; 		 (match_operand:SI 4 "register_operand" "r")])]))]
;;   ""
;;   {
;; 	int bw_cst = 0;
;; 	int idx;
;; 
;; 	for (idx = 0; idx < 16; ++idx) {
;; 	    unsigned int val_a = (idx >> 0) & 1;
;; 	    unsigned int val_b = (idx >> 1) & 1;
;; 	    unsigned int val_c = (idx >> 2) & 1;
;; 	    unsigned int val_d = (idx >> 3) & 1;
;; 	    
;; 	    unsigned int val_ab, val_cd, val;
;; 	    switch (GET_CODE (operands[5])) {
;; 	    	   case XOR:
;; 		   	val_ab = val_a ^ val_b;
;; 			break;
;; 		   case IOR:
;; 		   	val_ab = val_a | val_b;
;; 			break;
;; 		   case AND:
;; 		   	val_ab = val_a & val_b;
;; 			break;
;; 		   default:
;; 			gcc_unreachable ();
;; 	    }
;; 	    
;; 	    switch (GET_CODE (operands[6])) {
;; 	    	   case XOR:
;; 		   	val_cd = val_c ^ val_d;
;; 			break;
;; 		   case IOR:
;; 		   	val_cd = val_c | val_d;
;; 			break;
;; 		   case AND:
;; 		   	val_cd = val_c & val_d;
;; 			break;
;; 		   default:
;; 			gcc_unreachable ();
;; 	    }
;; 	    
;; 	    switch (GET_CODE (operands[7])) {
;; 	    	   case XOR:
;; 		   	val = val_ab ^ val_cd;
;; 			break;
;; 		   case IOR:
;; 		   	val = val_ab | val_cd;
;; 			break;
;; 		   case AND:
;; 		   	val = val_ab & val_cd;
;; 			break;
;; 		   default:
;; 			gcc_unreachable ();
;; 	    }
;; 
;; 	    bw_cst |= (val << idx);
;; 	}
;;   	operands[8] = gen_rtx_CONST_INT(SImode, bw_cst);
;;   	return "bwlu %0 = %1:%2, %3:%4, %u8";
;; }
;;   [(set_attr "type" "alud_y")
;;    (set_attr "length" "12")]
;; )

(define_insn "*icall_<mode>"
  [(call (mem:P (match_operand:P 0 "register_operand" "r"))
  	 (match_operand:SI 1 "general_operand" ""))]
  "<MODE>mode != DImode || TARGET_64"
  "icall %0"
[(set_attr "type" "bcu")]
)

(define_insn "real_call"
  [(call (match_operand 0 "jump_operand" "")
         (match_operand 1 "general_operand" ""))]
  "!K1_FARCALL"
  "call %0"
[(set_attr "type" "bcu")]
)

(define_expand "call"
  [(call (match_operand 0 "jump_operand" "")
         (match_operand 1 "general_operand" ""))]                    
  ""
{
        k1_expand_call (operands[0], operands[1], NULL_RTX, false);
        DONE;
})

(define_insn "real_call_value"
  [(set (match_operand       0 "" "")
	(call (match_operand 1 "jump_operand" "")
              (match_operand 2 "general_operand" "")))]
  "!K1_FARCALL"
  "call %1"
[(set_attr "type" "bcu")]
)

(define_expand "call_value"
   [(parallel [(set (match_operand       0 "" "")
	            (call (match_operand 1 "jump_operand" "")
                          (match_operand 2 "general_operand" "")))])]
  ""
{
        k1_expand_call (operands[1], operands[2], operands[0], false);
        DONE;
})

(define_expand "sibcall"
  [(parallel
    [(call (match_operand 0 "jump_operand" "")
	   (match_operand 1 "" ""))
     (return)])]
  ""
  {
        k1_expand_call (operands[0], operands[1], NULL_RTX, true);
        DONE;
  }
)

(define_expand "sibcall_value"
  [(parallel
    [(set (match_operand 0 "" "")
	  (call (match_operand 1 "jump_operand" "")
	  	(match_operand 2 "" "")))
     (return)])]
  ""
  {
        k1_expand_call (operands[1], operands[2], operands[0], true);
        DONE;
  }
)

(define_insn "sibcall_value_real"
    [(set (match_operand 0 "" "")
	  (call (match_operand 1 "jump_operand" "")
	  	(match_operand 2 "" "")))
     (return)]
  "!K1_FARCALL"
  "goto %1"
[(set_attr "type" "bcu")]
)

(define_insn "sibcall_real"
    [(call (match_operand 0 "jump_operand" "")
	   (match_operand 1 "" ""))
     (return)]
  "!K1_FARCALL"
  "goto %0"
[(set_attr "type" "bcu")]
)


;;
;; These pattern were used for indirect sibcall
;; but a bug prevent their correct usage
;; and leads to incorrect code (jump to random address)
;; See T1118

;; (define_insn "*isibcall_value_real_<mode>"
;;     [(set (match_operand 0 "" "")
;; 	  (call (mem:P (match_operand:P 1 "register_operand" "Cs"))
;; 	  	(match_operand 2 "" "")))
;;      (return)]
;;   "<MODE>mode != DImode || (k1_architecture() >= K1B && TARGET_64)"
;;   "igoto<P:suffix> %1"
;; [(set_attr "type" "bcu")]
;; )

;; (define_insn "*isibcall_real_<mode>"
;;     [(call (mem:P (match_operand:P 0 "register_operand" "Cs"))
;; 	   (match_operand 1 "" ""))
;;      (return)]
;;   "<MODE>mode != DImode || (k1_architecture() >= K1B && TARGET_64)"
;;   "igoto<P:suffix> %0"
;; [(set_attr "type" "bcu")]
;; )

(define_insn "*icall_value_<mode>"
  [(set (match_operand       0 "" "")
	(call (mem:P (match_operand:P 1 "register_operand" "r"))
              (match_operand 2 "general_operand" "")))]
  "<MODE>mode != DImode || TARGET_64"
  "icall %1"
[(set_attr "type" "bcu")]
)


;;***************************************************************
;;***************************************************************
;;
;;                    The FDPIC related stuff
;;
;;***************************************************************
;;***************************************************************

;; Initialize the rodata pointer in the prologue of the function.
;; Using unspec_volatile to be sure the optimizer won't decide to
;; delete it.
;; (define_insn "init_fdpic"
;;  [(set (match_operand:SI 0 "register_operand" )
;;   (unspec_volatile:SI [(match_operand:SI 1 "register_operand")]
;;                         UNSPEC_PIC))])

;; (define_insn "*init_fdpic_cached"
;;  [(set (match_operand:SI 0 "register_operand" "=r")
;;   (unspec_volatile:SI [(match_operand:SI 1 "register_operand" "r")]
;;                         UNSPEC_PIC))]
;;  "TARGET_FDPIC && !K1_FORCE_UNCACHED_LSU"
;;  "lw %0 = @got(_gp)[%1]"
;; [(set_attr "type" "lsu_load_x")]
;;)

;; (define_insn "*init_fdpic_uncached"
;;   [(set (match_operand:SI 0 "register_operand" "=r")
;;    (unspec_volatile:SI [(match_operand:SI 1 "register_operand" "r")]
;;                          UNSPEC_PIC))]
;;   "TARGET_FDPIC && K1_FORCE_UNCACHED_LSU"
;;   "lwu %0 = @got(_gp)[%1]"
;; [(set_attr "type" "lsu_load_uncached_x")]
;; )


;; The explicit MEM inside the UNSPEC prevents the compiler from moving
;; the load before a branch after a NULL test, or before a store that
;; initializes a function descriptor.

;; (define_insn_and_split "load_funcdescsi"
;;  [(set (match_operand:SI 0 "register_operand" "=a")
;;        (unspec_volatile:SI [(mem:SI (match_operand:SI 1 "address_operand" "p"))]
;;                            UNSPEC_VOLATILE_LOAD_FUNCDESC))]
;;  "TARGET_FDPIC"
;;  "#"
;;  ""
;;      [(set (match_dup 0) (mem:SI (match_dup 1)))])
;; ***************************************************************

(define_insn "c<SIDI_cond:cbvar>b<code>"
  [(set (pc)
	(if_then_else (cb_cond  
		        (match_operand:SIDI_cond 0 "register_operand" "r")
		        (const_int 0))
		      (match_operand 1 "immediate_operand" "i")
		      (pc)))]
  ""
  "c<SIDI_cond:cbvar>b.<code>z %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "cbeven"
  [(set (pc)
	(if_then_else (eq  
		        (zero_extract (match_operand:SI 0 "register_operand" "r")
			              (const_int 1) (const_int 0))
		        (const_int 0))
		      (match_operand 1 "immediate_operand" "i")
		      (pc)))]
  ""
  "cb.even %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "cbodd"
  [(set (pc)
	(if_then_else (ne  
		        (zero_extract (match_operand:SI 0 "register_operand" "r")
			              (const_int 1) (const_int 0))
		        (const_int 0))
		      (match_operand 1 "immediate_operand" "i")
		      (pc)))]
  ""
  "cb.odd %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "*sd<code>"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 1))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sd.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sd_uncached<code>"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 1))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sdu.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sd_even"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sd.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sd_even_uncached"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sdu.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sd_odd"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sd.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sd_odd_uncached"
   [(set (mem:DI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:DI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:DI 2 "register_operand" "r")
               (mem:DI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sdu.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw<code>"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sw.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw_uncached<code>"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "swu.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw_even"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sw.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw_even_uncached"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "swu.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw_odd"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sw.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sw_odd_uncached"
   [(set (mem:SI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:SI 2 "register_operand" "r")
               (mem:SI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "swu.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh<code>"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sh.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_uncached<code>"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "shu.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_even"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sh.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_even_uncached"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "shu.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_odd"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sh.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_odd"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       ""
       "sh.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sh_odd_uncached"
   [(set (mem:HI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:HI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:HI 2 "register_operand" "r")
               (mem:HI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "shu.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)


(define_insn "*sb<code>"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sb.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sb_uncached<code>"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sbu.<code>z %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sb_even"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sb.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sb_even_uncached"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sbu.even %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sb_odd"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "!K1_FORCE_UNCACHED_LSU"
       "sb.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*sb_odd_uncached"
   [(set (mem:QI (match_operand:SI 1 "register_operand" "r"))
	 (if_then_else:QI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
               (match_operand:QI 2 "register_operand" "r")
               (mem:QI (match_dup 1))))]
       "K1_FORCE_UNCACHED_LSU"
       "sbu.odd %0 ? [%1] = %2"
[(set_attr "type" "lsu_store")]
)

(define_insn "*ld<code>"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "ld.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*ld_uncached<code>"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "ldu.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*ld_even"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "ld.even %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*ld_even_uncached"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "ldu.even %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*ld_odd"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "ld.odd %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*ld_odd_uncached"
   [(set (match_operand:DI 1 "register_operand" "+r")
	 (if_then_else:DI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:DI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "ldu.odd %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lwz<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lwz.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lwz_uncached<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lwuz.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lwz_even"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lwz.even %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lwz_even_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lwuz.even %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lwz_odd"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lwz.odd %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lwz_odd_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (mem:SI (match_operand:SI 2 "register_operand" "r"))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lwuz.odd %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhs<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhs.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lhs_uncached<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhsu.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhs_even"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhs.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lhs_even_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhsu.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhs_odd"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhs.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lhs_odd_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhsu.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhz<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhz.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lhz_uncached<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhzu.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhz_even"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhz.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lhz_even_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhzu.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lhz_odd"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lhz.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lhz_odd_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:HI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lhzu.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbs<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbs.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lbs_uncached<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbsu.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbs_even"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbs.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lbs_even_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbsu.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbs_odd"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbs.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lbs_odd_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (sign_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbsu.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbz<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond  
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbz.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load")]
)

(define_insn "*lbz_uncached<code>"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (cb_cond
		         (match_operand:SI 0 "register_operand" "r")
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbzu.<code>z %0 ? %1 = [%2]"
[(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbz_even"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq  
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbz.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)

(define_insn "*lbz_even_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (eq
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbzu.even %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "*lbz_odd"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "!K1_FORCE_UNCACHED_LSU"
       "lbz.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load")]
)


(define_insn "*lbz_odd_uncached"
   [(set (match_operand:SI 1 "register_operand" "+r")
	 (if_then_else:SI (ne
		         (zero_extract (match_operand:SI 0 "register_operand" "r")
			               (const_int 1) (const_int 0))
		         (const_int 0))
	       (zero_extend:SI (mem:QI (match_operand:SI 2 "register_operand" "r")))
               (match_dup 1)))]
       "K1_FORCE_UNCACHED_LSU"
       "lbzu.odd %0 ? %1 = [%2]"
  [(set_attr "type" "lsu_load_uncached")]
)

(define_insn "cstoredi4"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (match_operator:DI 1 "comparison_operator"
	        [(match_operand:DI 2 "register_operand" "r")
	         (match_operand:DI 3 "register_operand" "r")]))]
""
"compd.%1 %0 = %2, %3"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")])

;; FIXME AUTO: disabled compdl variants until ISA is stable again
;; (define_insn "cstoredi4"
;;   [(set (match_operand:SI 0 "register_operand" "=r,r,r,r,r,r,r")
;;         (match_operator:SI 1 "comparison_operator"
;; 	        [(match_operand:DI 2 "register_operand" "r,r,r,r,r,r,r")
;; 	         (match_operand:DI 3 "nonmemory_operand" "r,r,I10,D37,n,i,i")]))]
;;  ""
;; {
;;     switch (which_alternative) {
;;            case 0: return "compdl.%1 %0 = %2, %3";
;;            case 2: return "compdl.%1 %0 = %d2, %3";
;;            case 1:
;;            case 3:
;;            case 4:
;; 	   case 5:
;; 	   case 6: return "compdl.%1 %0 = %d2, %d3";
;; 
;;            default: gcc_unreachable ();
;;     }
;; }
;; [(set_attr "type" "alud_lite,alud_x,alud_x,alud_y,alud_z,alud_z,alud_z")
;;  (set_attr "length" "4,8,8,12,16,16,16")
;;  (set_attr "only_64b" "*,*,*,*,*,yes,*")])

;; FIXME AUTO: disabled for coolidge, no gen_highpart 
;; PLACEHOLDER for COMPDL K1B
;; (define_split
;;   [(set (match_operand:SI 1 "register_operand" "" )
;;         (match_operator:SI 0 "comparison_operator"
;; 	        [(match_operand:DI 2 "register_operand" "")
;; 	         (match_operand:DI 3 "nonmemory_operand" "")]))]
;;   "operands[3] == const0_rtx && (GET_CODE(operands[0]) == LT
;;                                  || GET_CODE(operands[0]) == GE
;;                                  || GET_CODE(operands[0]) == EQ
;;                                  || GET_CODE(operands[0]) == NE)"
;;   [(set (match_dup 1)
;;         (match_dup 4))]
;; {
;;   if (GET_CODE(operands[0]) == LT || GET_CODE(operands[0]) == GE)
;;      operands[4] = gen_rtx_fmt_ee(GET_CODE(operands[0]), SImode, gen_highpart (SImode, operands[2]), const0_rtx);
;;   else if (GET_CODE(operands[0]) == EQ || GET_CODE(operands[0]) == NE)
;;      operands[4] = gen_rtx_fmt_ee(GET_CODE(operands[0]), SImode,
;;                                   gen_rtx_IOR (SImode, 
;;                                                gen_highpart (SImode, operands[2]),
;;                                                gen_lowpart (SImode, operands[2])),
;;                                   const0_rtx);
;;   else
;;      gcc_unreachable ();
;; }
;; )

(define_insn "cstoresi4" 
  [(set (match_operand:SI 0 "register_operand" "=r,r,r")
        (match_operator:SI 1 "comparison_operator"
	        [(match_operand:SI 2 "register_operand" "r,r,r")
	         (match_operand:SI 3 "nonmemory_operand" "r,I10,D37")]))]
  ""
  "comp.%1 %0 = %2, %3"
[(set_attr "type" "tiny,tiny,tiny_x")
 (set_attr "length" "4,4,8")]
)

(define_code_iterator mask_cond [eq ne])
(define_code_attr mask_name [(eq "all") (ne "nall")])
(define_code_attr mask_name2 [(eq "none") (ne "any")])

(define_insn "*comp_<mask_name>" 
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
        (mask_cond:SI (and:SI (match_operand:SI 1 "register_operand" "r,r,r")
	                      (match_operand:SI 2 "nonmemory_operand" "U10,i,r"))
	              (match_dup 2)))]
  ""
  "comp.<mask_name> %0 = %1, %u2"
[(set_attr "type" "tiny,tiny_x,tiny")
 (set_attr "length" "4,8,4")]
)

(define_insn "*comp_<mask_name>_r" 
  [(set (match_operand:SI 0 "register_operand" "=r")
        (mask_cond:SI (and:SI (match_operand:SI 2 "register_operand" "r")
	                      (match_operand:SI 1 "register_operand" "r"))
	              (match_dup 1)))]
  ""
  "comp.<mask_name> %0 = %1, %2"
[(set_attr "type" "tiny")
 (set_attr "length" "4")]
)

(define_insn "comp_<mask_name2>" 
  [(set (match_operand:SI 0 "register_operand" "=r,=r,=r")
        (mask_cond:SI (and:SI (match_operand:SI 1 "register_operand" "r,r,r")
	                      (match_operand:SI 2 "nonmemory_operand" "U10,i,r"))
	              (const_int 0)))]
  ""
  "comp.<mask_name2> %0 = %1, %u2"
[(set_attr "type" "tiny,tiny_x,tiny")
 (set_attr "length" "4,8,4")]
)

;; FIXME AUTO: disable immediate variant
;; (define_insn "*compdl_<mask_name>" 
;;   [(set (match_operand:SI 0 "register_operand" "=r,=r,=r,=r")
;;         (mask_cond:SI (and:DI (match_operand:DI 1 "register_operand" "r,r,r,r")
;; 	                      (match_operand:DI 2 "nonmemory_operand" "U10,D37,i,r"))
;; 	              (match_dup 2)))]
;;   ""
;;   "compdl.<mask_name> %0 = %d1, %d2"
;; [(set_attr "type" "alud_x,alud_y,alud_z,alud_x")
;;  (set_attr "length" "8,12,16,8")]
;; )

(define_insn "*compd_<mask_name>"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (mask_cond:DI (and:DI (match_operand:DI 1 "register_operand" "r")
	                      (match_operand:DI 2 "register_operand" "r"))
	              (match_dup 2)))]
  ""
  "compd.<mask_name> %0 = %1, %2"
[(set_attr "type" "alud_x")
 (set_attr "length" "8")]
)

(define_insn "*compd_<mask_name>_r"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (mask_cond:DI (and:DI (match_operand:DI 2 "register_operand" "r")
	                      (match_operand:DI 1 "register_operand" "r"))
	              (match_dup 1)))]
  ""
  "compd.<mask_name> %0 = %1, %2"
[(set_attr "type" "alud_x")
 (set_attr "length" "8")]
)

;; FIXME AUTO: disable compdl immediate variants
(define_insn "compd_<mask_name2>"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (mask_cond:DI (and:DI (match_operand:DI 1 "register_operand" "r")
	                      (match_operand:DI 2 "register_operand" "r"))
	              (const_int 0)))]
  ""
  "compd.<mask_name2> %0 = %1, %2"
[(set_attr "type" "alud_x")
 (set_attr "length" "8")]
)

(define_code_iterator gt_comp [gt gtu])
(define_code_iterator lt_comp [lt ltu])
(define_code_iterator ge_comp [ge geu])
(define_code_iterator le_comp [le leu])

(define_insn_and_split "*comp_<code>_incr"
   [(set (match_operand:SI 0 "register_operand" "=r")
         (le_comp:SI (plus:SI (match_operand:SI 1 "register_operand" "r")
                              (const_int 1))
                     (match_operand:SI 2 "register_operand" "r")))
    (set (match_operand:SI 3 "register_operand" "=r")
         (plus:SI (match_dup 1) (const_int 1)))
   ]
   ""
   "comp_<code>_incr not spilt"
   ""
[(set (match_dup 0) (match_op_dup:SI 4 [(match_dup 1) (match_dup 2)]))
 (set (match_dup 3) (plus:SI (match_dup 1) (const_int 1)))]
{
     operands[4] = gen_rtx_fmt_ee(k1_strict_to_nonstrict_comparison_operator (<CODE>),
                                  SImode, operands[1], operands[2]);
}
)

(define_insn_and_split "*comp_<code>_decr"
   [(set (match_operand:SI 0 "register_operand" "=r")
         (lt_comp:SI (plus:SI (match_operand:SI 1 "register_operand" "r")
                              (const_int -1))
                     (match_operand:SI 2 "register_operand" "r")))
    (set (match_operand:SI 3 "register_operand" "=r")
         (plus:SI (match_dup 1) (const_int -1)))
   ]
   ""
   "comp_<code>_decr not spilt"
   ""
[(set (match_dup 0) (match_op_dup:SI 4 [(match_dup 1) (match_dup 2)]))
 (set (match_dup 3) (plus:SI (match_dup 1) (const_int -1)))]
{
     operands[4] = gen_rtx_fmt_ee(k1_strict_to_nonstrict_comparison_operator (<CODE>),
                                  SImode, operands[1], operands[2]);
}
)

(define_insn_and_split "*comp_<code>_decr"
   [(set (match_operand:SI 0 "register_operand" "=r")
         (ge_comp:SI (plus:SI (match_operand:SI 1 "register_operand" "r")
                              (const_int -1))
                     (match_operand:SI 2 "register_operand" "r")))
    (set (match_operand:SI 3 "register_operand" "=r")
         (plus:SI (match_dup 1) (const_int -1)))
   ]
   ""
   "comp_<code>_decr not split"
   ""
[(set (match_dup 0) (match_op_dup:SI 4 [(match_dup 1) (match_dup 2)]))
 (set (match_dup 3) (plus:SI (match_dup 1) (const_int -1)))]
{
     operands[4] = gen_rtx_fmt_ee(k1_strict_to_nonstrict_comparison_operator (<CODE>),
                                  SImode, operands[1], operands[2]);
}
)

(define_insn_and_split "*comp_<code>_incr"
   [(set (match_operand:SI 0 "register_operand" "=r")
         (gt_comp:SI (plus:SI (match_operand:SI 1 "register_operand" "r")
                              (const_int 1))
                     (match_operand:SI 2 "register_operand" "r")))
    (set (match_operand:SI 3 "register_operand" "=r")
         (plus:SI (match_dup 1) (const_int 1)))
   ]
   ""
   "comp_<code>_incr not split"
   ""
[(set (match_dup 0) (match_op_dup:SI 4 [(match_dup 1) (match_dup 2)]))
 (set (match_dup 3) (plus:SI (match_dup 1) (const_int 1)))]
{
     operands[4] = gen_rtx_fmt_ee(k1_strict_to_nonstrict_comparison_operator (<CODE>),
                                  SImode, operands[1], operands[2]);
}
)

(define_expand "cmove<mode>"
  [(set (match_operand:SISIZESCALAR 0 "register_operand" )
	(if_then_else:SISIZESCALAR (match_operator 1 "comparison_operator" 
                          [(match_operand:SI 2 "register_operand")
			   (const_int 0)])
		      (match_operand:SISIZESCALAR 3 "nonmemory_operand")
		      (match_operand:SISIZESCALAR 4 "register_operand" )))])

(define_insn "*cmove<mode>"
  [(set (match_operand:SISIZESCALAR 1 "register_operand" "+r,r,r")
	(if_then_else:SISIZESCALAR (match_operator 0 "comparison_operator" 
                          [(match_operand:SI 2 "register_operand" "r,r,r")
			   (const_int 0)])
		      (match_operand:SISIZESCALAR 3 "nonmemory_operand" "r,I10,i")
		      (match_dup 1)))]
  ""
  "cmove.%0z %1 = %2, %3"
  [(set_attr "type" "cmove,cmove,cmove_x")
   (set_attr "length" "4,4,8")]
)

(define_insn "*cmove_even_eq<mode>"
  [(set (match_operand:SISIZESCALAR 0 "register_operand" "+r,+r,+r")
	(if_then_else:SISIZESCALAR (eq
                          (zero_extract (match_operand:SI 1 "register_operand" "r,r,r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:SISIZESCALAR 2 "nonmemory_operand" "r,I10,i")
		      (match_dup 0)))]
  ""
  "cmove.even %0 = %1, %2"
  [(set_attr "type" "cmove,cmove,cmove_x")
   (set_attr "length" "4,4,8")]
)

(define_insn "*cmove_even_ne<mode>"
  [(set (match_operand:SISIZESCALAR 0 "register_operand" "+r,+r,+r")
	(if_then_else:SISIZESCALAR (ne
                          (zero_extract (match_operand:SI 1 "register_operand" "r,r,r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_dup 0)
		      (match_operand:SISIZESCALAR 2 "nonmemory_operand" "r,I10,i")))]
  ""
  "cmove.even %0 = %1, %2"
  [(set_attr "type" "cmove,cmove,cmove_x")
   (set_attr "length" "4,4,8")]
)

(define_insn "*cmove_odd_eq<mode>"
  [(set (match_operand:SISIZESCALAR 0 "register_operand" "+r,+r,+r")
	(if_then_else:SISIZESCALAR (eq
                          (zero_extract (match_operand:SI 1 "register_operand" "r,r,r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_dup 0)
		      (match_operand:SISIZESCALAR 2 "nonmemory_operand" "r,I10,i")))]
  ""
  "cmove.odd %0 = %1, %2"
  [(set_attr "type" "cmove,cmove,cmove_x")
   (set_attr "length" "4,4,8")]
)

(define_insn "*cmove_odd_ne<mode>"
  [(set (match_operand:SISIZESCALAR 0 "register_operand" "+r,+r,+r")
	(if_then_else:SISIZESCALAR (ne
                          (zero_extract (match_operand:SI 1 "register_operand" "r,r,r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:SISIZESCALAR 2 "nonmemory_operand" "r,I10,i")
		      (match_dup 0)))]
  ""
  "cmove.odd %0 = %1, %2"
  [(set_attr "type" "cmove,cmove,cmove_x")
   (set_attr "length" "4,4,8")]
)

;; PLACEHOLDER for CMOVED K1B



;; Do not allow any immediate, only numerical ones :
;; we don't want to generate opxd + reloc, instead force
;; the compiler to materialise the symbol with maked

;; FIXME AUTO: disable cmoved variants
(define_insn "*cmoved<mode>_k1b"
  [(set (match_operand:DISIZESCALAR 1 "register_operand" "+r")
	(if_then_else:DISIZESCALAR (match_operator 0 "comparison_operator"
                          [(match_operand:SI 2 "register_operand" "r")
			   (const_int 0)])
		      (match_operand:DISIZESCALAR 3 "register_operand" "r")
		      (match_dup 1)))]
  ""
  "cmoved.%0z %1 = %2, %3"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

(define_insn "*cdmoved<mode>_k1b"
  [(set (match_operand:DISIZESCALAR 1 "register_operand" "+r")
	(if_then_else:DISIZESCALAR (match_operator 0 "comparison_operator"
                                      [(match_operand:DI 2 "register_operand" "r")
                                       (const_int 0)])
		      (match_operand:DISIZESCALAR 3 "register_operand" "r")
		      (match_dup 1)))]
  ""
  "cdmoved.%0z %1 = %2, %3"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)


(define_split
  [(set (match_operand:DISIZESCALAR 0 "register_operand" "")
	(if_then_else:DISIZESCALAR (ge
                          (match_operand:DI 1 "register_operand" "")
			  (const_int 0))
		      (match_operand:DISIZESCALAR 2 "register_operand" "")
		      (match_operand:DISIZESCALAR 3 "register_operand" "")))]
  "REGNO(operands[0]) == REGNO(operands[2])"
  [(set (match_dup 0)
	(if_then_else:DI (lt
                          (match_dup 4)
			  (const_int 0))
		      (match_dup 3)
		      (match_dup 2)))]
  "{
        operands[4] = gen_highpart (SImode, operands[1]);
   }"
)

;; FIXME AUTO: disable cmoved3
;; (define_insn_and_split "*cmoved3<mode>"
;;   [(set (match_operand:DISIZESCALAR 0 "register_operand" "")
;; 	(if_then_else:DISIZESCALAR (lt
;;                           (match_operand:DI 1 "register_operand" "")
;; 			  (const_int 0))
;; 		      (match_operand:DISIZESCALAR 2 "register_operand" "")
;; 		      (match_operand:DISIZESCALAR 3 "register_operand" "")))]
;;   "REGNO(operands[0]) == REGNO(operands[3])"
;;   " CMOVED3 not split!"
;;   ""
;;   [(set (match_dup 0)
;; 	(if_then_else:DI (lt
;;                           (match_dup 4)
;; 			  (const_int 0))
;; 		      (match_dup 2)
;; 		      (match_dup 3)))]
;;   "{
;;         operands[4] = gen_highpart (SImode, operands[1]);
;;    }"
;;    []
;; )

;; the define_insn should not be used
;; as it may accept some insn at some point and then
;; not recognise them when new register can't be created, leading to compiler crash
;; (define_insn_and_split "*cmoved4<mode>"
;;   [(set (match_operand:DISIZESCALAR 0 "register_operand" "")
;; 	(if_then_else:DISIZESCALAR (match_operator 4 "comparison_operator"
;;                               [(match_operand:DI 1 "register_operand" "")
;; 			       (const_int 0)])
;; 		      (match_operand:DISIZESCALAR 2 "register_operand" "")
;; 		      (match_operand:DISIZESCALAR 3 "register_operand" "")))]
;;   "k1_architecture() < K1B
;;    && can_create_pseudo_p()
;;    && (GET_CODE (operands[4]) == EQ || GET_CODE (operands[4]) == NE)
;;    && (REGNO(operands[0]) == REGNO(operands[3])
;;        || REGNO(operands[0]) == REGNO(operands[2]))"
;;   " CMOVED4 not split!"
;;   ""
;;   [(set (match_dup 7) (ior:SI (match_dup 5) (match_dup 6)))
;;    (set (match_dup 0)
;; 	(if_then_else:DI (match_op_dup 4
;;                              [(match_dup 7)
;; 			      (const_int 0)])
;; 		      (match_dup 2)
;; 		      (match_dup 3)))]
;;   "{
;;         operands[7] = gen_reg_rtx (SImode);
;;         operands[5] = gen_lowpart (SImode, operands[1]);
;;         operands[6] = gen_highpart (SImode, operands[1]);
;;         
;;         if (REGNO(operands[0]) == REGNO(operands[2])) {
;;             rtx tmp = operands[2]; operands[2] = operands[3]; operands[3] = tmp;
;;             PUT_CODE (operands[4], GET_CODE (operands[4]) == EQ ? NE : EQ);
;;         }
;;    }"
;;    []
;; )

;; Do not allow any immediate, only numerical ones :
;; we don't want to generate opxd + reloc, instead force
;; the compiler to materialise the symbol with maked

;; FIXME AUTO: disable cmoved.even immediate variant
(define_insn "*cmoved_even<mode>"
  [(set (match_operand:DISIZESCALAR 0 "register_operand" "+r")
	(if_then_else:DISIZESCALAR (eq
                          (zero_extract (match_operand:SI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:DISIZESCALAR 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmoved.even %0 = %1, %2"
  [(set_attr "type" "alud_x")
   (set_attr "length" "4")]
)

;; Do not allow any immediate, only numerical ones :
;; we don't want to generate opxd + reloc, instead force
;; the compiler to materialise the symbol with maked
;; FIXME AUTO: disable cmoved.odd immediate variants
(define_insn "*cmoved_odd<mode>"
  [(set (match_operand:DISIZESCALAR 0 "register_operand" "+r")
	(if_then_else:DISIZESCALAR (ne
                          (zero_extract (match_operand:SI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:DISIZESCALAR 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmoved.odd %0 = %1, %2"
  [(set_attr "type" "alud_x")
   (set_attr "length" "4")]
)

(define_expand "cbranch<mode>4"
  [(set (pc)
	(if_then_else (match_operator 0 "comparison_operator"
		       [(match_operand:SIDI_cond 1 "register_operand")
		        (match_operand:SIDI_cond 2 "nonmemory_operand")])
		      (label_ref (match_operand 3 ""))
		      (pc)))]
  ""
{
        /* no cdb.* insn on K1A, so always use a cstore */
        /* Use a simple cbranchdi4 pattern. The generic expand pass could do some optimisations, but we want 
           the DI comparisons to remain true DI comparisons so that the register doesn't get split by lower-subreg.
           The optimizations that can be done are handle by the cstoredi splitters and the bellow cbranchdilt and 
           cbranchdige fake instructions. */
        // if (<MODE>mode == DImode && k1_architecture() < K1B){
	//   rtx reg;

        //   reg = gen_reg_rtx (SImode);
        //   emit_insn (gen_cstoredi4(reg, operands[0], operands[1], operands[2]));
        //   emit_jump_insn (gen_cbne (reg, 
	//                             gen_rtx_LABEL_REF (SImode, 
	//			                        operands[3])));
	//   DONE;
        // }

        /* c*b.* only compare with 0 */
	if (!CONST_INT_P(operands[2]) || INTVAL(operands[2]) != 0) {
	   rtx reg = gen_reg_rtx (<MODE>mode);

	   if (<MODE>mode == DImode)
	      operands[2] = force_reg(DImode, operands[2]);

	   emit_insn (gen_cstore<mode>4(reg, operands[0], operands[1], operands[2]));
	   operands[2] = const0_rtx;
	   operands[1] = reg;
	   operands[0] = gen_rtx_fmt_ee(NE, VOIDmode, reg, operands[2]);
	}
})

(define_insn "*cbranchdilt"
  [(set (pc)
	(if_then_else (lt (match_operand:DI 0 "register_operand" "r")
		          (const_int 0))
		      (label_ref (match_operand 1 ""))
		      (pc)))]
  ""
  "cb.ltz %0, %1"
[(set_attr "type" "bcu")]
)

(define_insn "*cbranchdige"
  [(set (pc)
	(if_then_else (ge (match_operand:DI 0 "register_operand" "r")
		          (const_int 0))
		      (label_ref (match_operand 1 ""))
		      (pc)))]
  ""
  "cb.gez %0, %1"
[(set_attr "type" "bcu")]
)

(define_expand "prologue"
  [(const_int 1)]
  ""
  "
{
  k1_expand_prologue ();
  DONE;
}")

(define_expand "epilogue"
  [(parallel [(return)
              (use (match_dup 0))])] /* LINK_REG */
  ""
  "
{
	operands[0] = k1_link_reg_rtx;
	k1_expand_epilogue ();
}")

(define_expand "sibcall_epilogue"
  [(parallel [(return)
              (use (match_dup 0))])] /* LINK_REG */
  ""
  "
{
  operands[0] = k1_link_reg_rtx;
  k1_expand_epilogue ();
  DONE; /* DO NOT generate the ret in this case! */
}")

(define_insn "ret_<mode>"
  [(return)
   (use (match_operand:P 0 "system_register_operand" "=<P:SRFSIZE>"))] /* LINK_REG */
  ""
  "ret"
[(set_attr "type" "bcu")]
) 

(define_expand "untyped_call"
  [(parallel [(call (match_operand 0 "" "")
		    (const_int 0))
	      (match_operand 1 "" "")
	      (match_operand 2 "" "")])]
  ""
  {
    int i;
    rtx reg = gen_rtx_REG (OImode, K1C_ARGUMENT_POINTER_REGNO);

    /* We need to use call_value so the return value registers don't get
     * clobbered. */
    emit_call_insn (gen_call_value (reg, operands[0], const0_rtx));

    for (i = 0; i < XVECLEN (operands[2], 0); i++)
      {
	rtx set = XVECEXP (operands[2], 0, i);
	emit_move_insn (SET_DEST (set), SET_SRC (set));
      }

    DONE;
  })

;; Do not allow any immediate, only numerical ones.
;; (define_expand "div_srs<I:suffix>"
;;   [(set (match_operand:I 0 "register_operand" )
;; 	(div:I (match_operand:I 1 "register_operand" )
;; 	       (match_operand   2 "poweroftwo_6bits_immediate_operand" )))])

(define_insn "div_srs<I:suffix32b>"
  [(set (match_operand:I 0 "register_operand" "=<I:regclass>")
	(div:I (match_operand:I 1 "register_operand" "<I:regclass>")
	       (match_operand 2 "poweroftwo_6bits_immediate_operand" "n")))]
  ""
  {
  rtx op = operands[2];
  long long div = CONST_INT_P(op) ? INTVAL(op)
            	  : ((long long)CONST_DOUBLE_HIGH(op) << 32
		     | CONST_DOUBLE_LOW (op));
  gcc_assert (__builtin_popcount (div) == 1);
  operands[2] = gen_rtx_CONST_INT(VOIDmode, __builtin_ctzl (div));
  return "srs<I:suffix32b> %0 = %1, %2";
}
[(set_attr "type" "<I:lite_prefix>lite")
 (set_attr "length" "4")]
)

(define_expand "div<mode>3"
  [(set (match_operand:I 0 "register_operand" )
	(div:I (match_operand:I 1 "register_operand" )
	        (match_operand 2 "poweroftwo_6bits_immediate_operand" )))])

(define_expand "mod<mode>3"
  [(set (match_operand:I 0 "register_operand" )
	(mod:I (match_operand:I 1 "register_operand" )
	       (match_operand   2 "poweroftwo_6bits_immediate_operand" )))]
  ""
  {
    rtx op = operands[2];
    long long div;
    rtx q;

    if (!CONST_INT_P (op)
     	&& GET_CODE (op) != CONST_DOUBLE) {
	FAIL;
    }

    div = CONST_INT_P(op) ? INTVAL(op)
      	  : ((long long)CONST_DOUBLE_HIGH(op) << 32
	     | CONST_DOUBLE_LOW (op));
    if (div < 0 || __builtin_popcount (div) != 1) {
      FAIL;
    }

    q = gen_reg_rtx (<MODE>mode);
    emit_insn (gen_div_srs<I:suffix32b> (q, operands[1], operands[2]));
    emit_insn (gen_ashl<mode>3 (operands[0], q, GEN_INT (__builtin_ctz (div))));
    emit_insn (gen_sub<mode>3 (operands[0], operands[1], operands[0]));

    DONE;
  }
)

(define_insn "*land<I:suffix2>" 
  [(set (match_operand:SI 0 "register_operand" "=r")
        (and:SI (ne:SI (match_operand:I 1 "register_operand" "%r") (const_int 0))
	        (ne:SI (match_operand:I 2 "register_operand" "r") (const_int 0))))]
  ""
  "land<I:suffix2> %0 = %1, %2"
[(set_attr "type" "alu<I:suffix_opx>")
 (set_attr "length" "<I:size>")]
)

(define_insn "*lnand<I:suffix2>" 
  [(set (match_operand:SI 0 "register_operand" "=r")
        (ior:SI (eq:SI (match_operand:I 1 "register_operand" "%r") (const_int 0))
	        (eq:SI (match_operand:I 2 "register_operand" "r") (const_int 0))))]
  ""
  "lnand<I:suffix2> %0 = %1, %2"
[(set_attr "type" "alu<I:suffix_opx>")
 (set_attr "length" "<I:size>")]
)

(define_insn "*lor<I:suffix2>" 
  [(set (match_operand:SI 0 "register_operand" "=r")
        (ne:SI (ior:I (match_operand:I 1 "register_operand" "%r")
	              (match_operand:I 2 "register_operand" "r")) 
               (const_int 0)))]
  ""
  "lord %0 = %1, %2"
[(set_attr "type" "alud")
 (set_attr "length" "<I:size>")]
)

(define_insn "*lnor<I:suffix2>" 
  [(set (match_operand:SI 0 "register_operand" "=r")
        (eq:SI (ior:I (match_operand:I 1 "register_operand" "%r")
	              (match_operand:I 2 "register_operand" "r")) 
               (const_int 0)))]
  ""
  "lnord %0 = %1, %2"
[(set_attr "type" "alud")
 (set_attr "length" "<I:size>")]
)

(define_insn "waitclr1"
   [(set (parallel:BLK [(expr_list (reg:SI 32) (const_int 0)) (expr_list (reg:SI 33) (const_int 0))
                        (expr_list (reg:SI 34) (const_int 0)) (expr_list (reg:SI 35) (const_int 0))
                        (expr_list (reg:SI 36) (const_int 0)) (expr_list (reg:SI 37) (const_int 0))
                        (expr_list (reg:SI 38) (const_int 0)) (expr_list (reg:SI 39) (const_int 0))
                        (expr_list (reg:SI 40) (const_int 0)) (expr_list (reg:SI 41) (const_int 0))
                        (expr_list (reg:SI 42) (const_int 0)) (expr_list (reg:SI 43) (const_int 0))
                        (expr_list (reg:SI 44) (const_int 0)) (expr_list (reg:SI 45) (const_int 0))
                        (expr_list (reg:SI 46) (const_int 0)) (expr_list (reg:SI 47) (const_int 0))])
       (unspec_volatile:BLK [(match_operand:SI 0 "register_operand" "r")] UNSPEC_WAITCLR1))
    (set (parallel:BLK [(expr_list (reg:SI 48) (const_int 0)) (expr_list (reg:SI 49) (const_int 0))
                        (expr_list (reg:SI 50) (const_int 0)) (expr_list (reg:SI 51) (const_int 0))
                        (expr_list (reg:SI 52) (const_int 0)) (expr_list (reg:SI 53) (const_int 0))
                        (expr_list (reg:SI 54) (const_int 0)) (expr_list (reg:SI 55) (const_int 0))
                        (expr_list (reg:SI 56) (const_int 0)) (expr_list (reg:SI 57) (const_int 0))
                        (expr_list (reg:SI 58) (const_int 0)) (expr_list (reg:SI 59) (const_int 0))
                        (expr_list (reg:SI 60) (const_int 0)) (expr_list (reg:SI 61) (const_int 0))
                        (expr_list (reg:SI 62) (const_int 0)) (expr_list (reg:SI 63) (const_int 0))])
       (unspec_volatile:BLK [(match_dup 0)] UNSPEC_WAITCLR1))
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
  ""
  "waitclr1 %0"
  [(set_attr "type" "bcu")]
)
;; FIXME should be the same reservation as bcu_get


(define_insn "waitany"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec_volatile:SI [(match_operand:SI 1 "register_operand" "r")
		    	     (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_WAITANY))
    (set (parallel:BLK [(expr_list (reg:SI 32) (const_int 0)) (expr_list (reg:SI 33) (const_int 0))
                        (expr_list (reg:SI 34) (const_int 0)) (expr_list (reg:SI 35) (const_int 0))
                        (expr_list (reg:SI 36) (const_int 0)) (expr_list (reg:SI 37) (const_int 0))
                        (expr_list (reg:SI 38) (const_int 0)) (expr_list (reg:SI 39) (const_int 0))
                        (expr_list (reg:SI 40) (const_int 0)) (expr_list (reg:SI 41) (const_int 0))
                        (expr_list (reg:SI 42) (const_int 0)) (expr_list (reg:SI 43) (const_int 0))
                        (expr_list (reg:SI 44) (const_int 0)) (expr_list (reg:SI 45) (const_int 0))
                        (expr_list (reg:SI 46) (const_int 0)) (expr_list (reg:SI 47) (const_int 0))])
       (unspec_volatile:BLK [(match_dup 1)
                             (match_dup 2)] UNSPEC_WAITANY))
    (set (parallel:BLK [(expr_list (reg:SI 48) (const_int 0)) (expr_list (reg:SI 49) (const_int 0))
                        (expr_list (reg:SI 50) (const_int 0)) (expr_list (reg:SI 51) (const_int 0))
                        (expr_list (reg:SI 52) (const_int 0)) (expr_list (reg:SI 53) (const_int 0))
                        (expr_list (reg:SI 54) (const_int 0)) (expr_list (reg:SI 55) (const_int 0))
                        (expr_list (reg:SI 56) (const_int 0)) (expr_list (reg:SI 57) (const_int 0))
                        (expr_list (reg:SI 58) (const_int 0)) (expr_list (reg:SI 59) (const_int 0))
                        (expr_list (reg:SI 60) (const_int 0)) (expr_list (reg:SI 61) (const_int 0))
                        (expr_list (reg:SI 62) (const_int 0)) (expr_list (reg:SI 63) (const_int 0))])
       (unspec_volatile:BLK [(match_dup 1)
                             (match_dup 2)] UNSPEC_WAITANY))
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 3 "" "") 
         (unspec:SI [(match_dup 3)] UNSPEC_SYNC))]
  ""
  "waitany %0 = %1, %2"
[(set_attr "type" "bcu")]
)

(define_insn "wantany"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec_volatile:SI [(match_operand:SI 1 "register_operand" "r")
		    	     (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_WANTANY))
   (set (parallel:BLK [(expr_list (reg:SI 32) (const_int 0)) (expr_list (reg:SI 33) (const_int 0))
                       (expr_list (reg:SI 34) (const_int 0)) (expr_list (reg:SI 35) (const_int 0))
                       (expr_list (reg:SI 36) (const_int 0)) (expr_list (reg:SI 37) (const_int 0))
                       (expr_list (reg:SI 38) (const_int 0)) (expr_list (reg:SI 39) (const_int 0))
                       (expr_list (reg:SI 40) (const_int 0)) (expr_list (reg:SI 41) (const_int 0))
                       (expr_list (reg:SI 42) (const_int 0)) (expr_list (reg:SI 43) (const_int 0))
                       (expr_list (reg:SI 44) (const_int 0)) (expr_list (reg:SI 45) (const_int 0))
                       (expr_list (reg:SI 46) (const_int 0)) (expr_list (reg:SI 47) (const_int 0))])
       (unspec_volatile:BLK [(match_dup 1)
                             (match_dup 2)] UNSPEC_WANTANY))
    (set (parallel:BLK [(expr_list (reg:SI 48) (const_int 0)) (expr_list (reg:SI 49) (const_int 0))
                        (expr_list (reg:SI 50) (const_int 0)) (expr_list (reg:SI 51) (const_int 0))
                        (expr_list (reg:SI 52) (const_int 0)) (expr_list (reg:SI 53) (const_int 0))
                        (expr_list (reg:SI 54) (const_int 0)) (expr_list (reg:SI 55) (const_int 0))
                        (expr_list (reg:SI 56) (const_int 0)) (expr_list (reg:SI 57) (const_int 0))
                        (expr_list (reg:SI 58) (const_int 0)) (expr_list (reg:SI 59) (const_int 0))
                        (expr_list (reg:SI 60) (const_int 0)) (expr_list (reg:SI 61) (const_int 0))
                        (expr_list (reg:SI 62) (const_int 0)) (expr_list (reg:SI 63) (const_int 0))])
       (unspec_volatile:BLK [(match_dup 1)
                             (match_dup 2)] UNSPEC_WANTANY))
    (clobber (mem:BLK (scratch)))
    (set (match_operand:SI 3 "" "") 
         (unspec:SI [(match_dup 3)] UNSPEC_SYNC))]
  ""
  "wantany %0 = %1, %2"
[(set_attr "type" "bcu")]
)


(define_insn "raise1"
  [(unspec_volatile:SI [(match_operand:SI 0 "register_operand" "r")] UNSPEC_RAISE1)
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
  ""
  "raise1 %0"
  [(set_attr "type" "bcu")]
)

(define_insn "notify1"
  [(unspec_volatile:SI [(match_operand:SI 0 "register_operand" "r")] UNSPEC_NOTIFY1)
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
  ""
  "notify1 %0"
  [(set_attr "type" "bcu")]
)

(define_insn "clear1"
  [(unspec_volatile:SI [(match_operand:SI 0 "register_operand" "r")] UNSPEC_CLEAR1)
    (set (match_operand:SI 1 "" "") 
         (unspec:SI [(match_dup 1)] UNSPEC_SYNC))]
  ""
  "clear1 %0"
  [(set_attr "type" "bcu")]
)

(define_insn "sat"
  [(set (match_operand:SI 0 "register_operand" "=r,=r")
        (unspec:SI [(match_operand:SI 1 "register_operand" "r,r")
                    (match_operand:SI 2 "nonmemory_operand" "r,U06")] UNSPEC_SAT))]
  ""
  "sat %0 = %1, %2"
  [(set_attr "type" "sat,sat")
   (set_attr "length" "4,4")]
)

(define_insn "satd"
  [(set (match_operand:DI 0 "register_operand" "=r,=r")
        (unspec:DI [(match_operand:DI 1 "register_operand" "r,r")
                    (match_operand:SI 2 "nonmemory_operand" "r,U06")] UNSPEC_SAT))]
  ""
  "satd %0 = %1, %2"
  [(set_attr "type" "alud_lite,alud_lite")
   (set_attr "length" "4,4")]
)

(define_insn "ssaddsi3"
  [(set (match_operand:SI 0 "register_operand" "=r")
        (ss_plus:SI (match_operand:SI 1 "register_operand" "r")
                    (match_operand:SI 2 "register_operand" "r")))]
  ""
  "adds %0 = %1, %2"
  [(set_attr "type" "adds")
   (set_attr "length" "4")]
)

(define_insn "ssadddi3"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (ss_plus:DI (match_operand:DI 1 "register_operand" "r")
                    (match_operand:DI 2 "register_operand" "r")))]
  ""
  "addsd %0 = %1, %2"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

;; FIXME AUTO: disable remote xord (no immediate variant)
;; (define_insn "remote_xord"
;;   [(unspec_volatile [(match_operand:DI 0 "sixbits_unsigned_operand" "U06")
;;   		     (match_operand:DI 1 "register_operand" "r")
;; 		     (match_operand:VOID 2 "immediate_operand" "I10")] UNSPEC_RXOR)
;;     (set (match_operand:SI 3 "" "") 
;;          (unspec:SI [(match_dup 3)] UNSPEC_SYNC))]
;;   ""
;;   "xord %r0 = %d1, %2"
;;   [(set_attr "type" "alud_x")
;;    (set_attr "length" "8")])

/*************** FLOATING POINT **************/

;; (define_expand "movdf"
;;    [(set (match_operand:DF 0 "nonimmediate_operand" "")
;;          (match_operand:DF 1 "general_operand" ""))]
;;    ""
;; {
;;         if (MEM_P(operands[0]) && can_create_pseudo_p()) {
;;            rtx reg = gen_reg_rtx(DFmode);
;;            emit_move_insn (reg, operands[1]);
;;            operands[1] = reg;
;;         }
;; }
;; )

;; (define_insn "*movdf_real_imm_k1b"
;;    [(set (match_operand:DF 0 "register_operand"  "=r,r")
;;          (match_operand:DF 1 "immediate_float_43bits_operand" "H16, H43"))]
;;  ""
;;  "@
;;   maked %0 = %1
;;   maked %0 = %1"
;;   [(set_attr "type" "alud_tiny, alud_tiny_x")
;;    (set_attr "length" "4,8")])


;; (define_insn "*movdf_real"
;;    [(set (match_operand:DF 0 "nonimmediate_operand" "=r, r, r, r, a, m")
;;          (match_operand:DF 1 "nonimmediate_operand" " F, r, a, m, r, r"))]
;;    "(!immediate_operand(operands[1], DFmode) || !memory_operand(operands[0], DFmode))
;;     && !(memory_operand(operands[0], DFmode) && memory_operand(operands[1], DFmode))
;;     && !((memory_operand(operands[0], DFmode) || memory_operand(operands[1], DFmode)) && K1_FORCE_UNCACHED_LSU)"
;;    "@
;;    maked %d0 = %d1
;;    ord   %d0 = %d1, 0
;;    ld%m1   %0 = %1
;;    ld%m1   %0 = %1
;;    sd%m0   %0 = %1
;;    sd%m0   %0 = %1"
;; [(set_attr "type" "alud_z,alud_x,lsu_load,lsu_load_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "16,8,4,8,4,8")]
;; )

;; (define_insn "*movdf_uncached"
;;    [(set (match_operand:DF 0 "nonimmediate_operand" "=r,r,a,m")
;;          (match_operand:DF 1 "nonimmediate_operand" " a,m,r,r"))]
;;    "!(memory_operand(operands[0], DFmode) && memory_operand(operands[1], DFmode))
;;     && !(register_operand(operands[0], DFmode) && register_operand(operands[1], DFmode))
;;     && K1_FORCE_UNCACHED_LSU"
;;    "@
;;    ldu%m1   %0 = %1
;;    ldu%m1   %0 = %1
;;    sdu%m0   %0 = %1
;;    sdu%m0   %0 = %1"
;; [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
;;  (set_attr "length" "4,8,4,8")]
;; )

;; (define_split
;;   [(set (match_operand:DF 0 "nonimmediate_operand" )
;;         (match_operand:DF 1 "general_operand" ))]
;;   "(k1_architecture() < K1B)
;;     && (!optimize_size
;;         || (small_operand (gen_lowpart (SImode, operands[1]), SImode)
;;             && small_operand (gen_highpart_mode (SImode, DFmode, operands[1]), SImode)))
;;     && !MEM_P(operands[0]) 
;;     && !MEM_P(operands[1])"
;;   [(set (match_dup 4) (match_dup 2))
;;    (set (match_dup 5) (match_dup 3))]
;; "
;;   if (!reg_mentioned_p (operands[0], operands[1]))
;;           emit_clobber (operands[0]);
;;        operands[4] = gen_lowpart (SImode, operands[0]);
;;        operands[5] = gen_highpart (SImode, operands[0]);
;; 
;;        if (GET_CODE (operands[1]) == CONST_DOUBLE) {
;;                REAL_VALUE_TYPE r;
;;                long l[2];
;;                REAL_VALUE_FROM_CONST_DOUBLE (r, operands[1]);
;;                REAL_VALUE_TO_TARGET_DOUBLE (r, l);
;;                operands[2] = gen_rtx_CONST_INT (VOIDmode, (l[0]));
;;                operands[3] = gen_rtx_CONST_INT (VOIDmode, (l[1]));
;;        } else {
;;        	      operands[2] = gen_lowpart (SImode, operands[1]);
;;        	      operands[3] = gen_highpart (SImode, operands[1]);
;;        }
;; ")


(define_insn "abssf2"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(abs:SF (match_operand:SF 1 "register_operand" "r")))]
  ""
  "fabs %0 = %1"
[(set_attr "type" "alu")]
)

(define_expand "absdf2"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(abs:DF (match_operand:DF 1 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*fabsd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(abs:DF (match_operand:DF 1 "register_operand" "r")))]
  ""
  "fabsd %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "fcomp" 
  [(set (match_operand:DI 0 "register_operand" "=r")
        (match_operator:DI 1 "float_comparison_operator"
	        [(match_operand:SF 2 "register_operand" "r")
	         (match_operand:SF 3 "register_operand" "r")]))]
  ""
  "fcomp.%f1 %0 = %2, %3"
[(set_attr "type" "alu")]
)

(define_insn "fcompd"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (match_operator:DI 1 "float_comparison_operator"
	        [(match_operand:DF 2 "register_operand" "r")
	         (match_operand:DF 3 "register_operand" "r")]))]
  ""
  "fcompd.%f1 %0 = %2, %3"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_mode_iterator SFDF [(SF "") (DF "")])
(define_mode_attr fsuffix [(SF "") (DF "d")])
(define_mode_attr fregclass [(SF "r") (DF "r")])

(define_expand "cstore<mode>4" 
  [(set (match_operand:DI 0 "register_operand" "")
        (match_operator:DI 1 "comparison_operator"
	        [(match_operand:ALLF 2 "register_operand" "")
	         (match_operand:ALLF 3 "register_operand" "")]))]
  ""
{
	int swap = 0;

	if (GET_CODE (operands[1]) == GT) {
	   PUT_CODE (operands[1], LT);
	   swap = 1;
	} else if (GET_CODE (operands[1]) == LE) {
	   PUT_CODE (operands[1], GE);
	   swap = 1;
	} else if (GET_CODE (operands[1]) == UNLE) {
	   PUT_CODE (operands[1], UNGE);
	   swap = 1;
	} else if (GET_CODE (operands[1]) == UNGT) {
	   PUT_CODE (operands[1], UNLT);
	   swap = 1;
	} 

	if (swap) {
	   emit_insn (gen_fcomp<ALLF:fsuffix> (operands[0], operands[1],
	   	     			       operands[3], operands[2]));
	   DONE;
	}

	if (GET_CODE (operands[1]) == UNORDERED) {
	   rtx tmp = gen_reg_rtx (DImode);
	   rtx comp2 = copy_rtx (operands[1]);
	   PUT_CODE (operands[1], UNGE);
	   emit_insn (gen_fcomp<ALLF:fsuffix> (operands[0], operands[1],
	   	     			       operands[2], operands[3]));
	   PUT_CODE (comp2, UNLT);
	   emit_insn (gen_fcomp<ALLF:fsuffix> (tmp, comp2,
	   	     			       operands[2], operands[3]));
	   emit_insn (gen_anddi3 (operands[0], operands[0], tmp));
	   DONE;
	} else if (GET_CODE (operands[1]) == ORDERED) {
	   rtx tmp = gen_reg_rtx (DImode);
	   rtx comp2 = copy_rtx (operands[1]);
	   PUT_CODE (operands[1], GE);
	   emit_insn (gen_fcomp<ALLF:fsuffix> (operands[0], operands[1],
	   	     			       operands[2], operands[3]));
	   PUT_CODE (comp2, LT);
	   emit_insn (gen_fcomp<ALLF:fsuffix> (tmp, comp2,
	   	     			       operands[2], operands[3]));
	   emit_insn (gen_iordi3 (operands[0], operands[0], tmp));
	   DONE;
	} 

	if (!float_comparison_operator (operands[1], VOIDmode)) {
	   print_rtl_single (stdout, operands[1]);
	   FAIL;
	}
}
)

(define_expand "cbranch<mode>4"
  [(set (pc)
	(if_then_else (match_operator 0 "comparison_operator"
		       [(match_operand:SFDF 1 "register_operand")
		        (match_operand:SFDF 2 "nonmemory_operand")])
		      (label_ref (match_operand 3 ""))
		      (pc)))]
  ""
{
	rtx cond = gen_reg_rtx (DImode);
	emit_insn (gen_cstore<mode>4 (cond, operands[0], 
		  		      force_reg (<MODE>mode, operands[1]),
				      force_reg (<MODE>mode, operands[2])));
	PUT_CODE (operands[0], NE);
	operands[1] = cond;
	operands[2] = const0_rtx;
})

(define_insn "negsf2"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(neg:SF (match_operand:SF 1 "register_operand" "r")))]
  ""
  "fneg %0 = %1"
[(set_attr "type" "alu")]
)

(define_expand "negdf2"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(neg:DF (match_operand:DF 1 "register_operand" "r")))]
  ""
  {}
)

(define_insn "fnegd_k1b"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(neg:DF (match_operand:DF 1 "register_operand" "r")))]
  ""
  "fnegd %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "builtin_extendhfsf2"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SI 1 "register_operand" "r")] UNSPEC_FWIDENB))]
  ""
  "fwidenb %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "builtin_extendv2hfv2sf2"
  [(set (match_operand:V2SF 0 "register_operand" "=r")
	(unspec:V2SF [(match_operand:DI 1 "register_operand" "r")] UNSPEC_FWIDENBWP))]
  ""
  "fwidenbwp %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "builtin_extendhfsf2_tophalf"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SI 1 "register_operand" "r")] UNSPEC_FWIDENT))]
  ""
  "fwident %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "builtin_extendv2hfv2sf2_tophalf"
  [(set (match_operand:V2SF 0 "register_operand" "=r")
	(unspec:V2SF [(match_operand:DI 1 "register_operand" "r")] UNSPEC_FWIDENTWP))]
  ""
  "fwidentwp %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "extendsfdf2"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(float_extend:DF (match_operand:SF 1 "register_operand" "r")))]
  ""
  "fwidend %0 = %1"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)


(define_insn "mulsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(mult:SF (match_operand:SF 1 "register_operand" "r")
		 (match_operand:SF 2 "register_operand" "r")))]
  ""
  "fmul %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(mult:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
                 (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fmulrn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
                 (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fmulrnd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "addsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(plus:SF (match_operand:SF 1 "register_operand" "r")
		 (match_operand:SF 2 "register_operand" "r")))]
  ""
  "fadd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "faddrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(plus:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
                 (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "faddrn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "faddrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(plus:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
                 (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "faddrnd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_expand "subsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(minus:SF (match_operand:SF 1 "register_operand" "r")
	          (match_operand:SF 2 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*subsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(minus:SF (match_operand:SF 2 "register_operand" "r")
	          (match_operand:SF 1 "register_operand" "r")))]
  ""
  "fsbf %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fsbfrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(minus:SF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN)
                  (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fsbfrn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fsbfrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(minus:DF (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN)
                  (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fsbfrnd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "muldf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  "fmuld %0 = %1, %2"
[(set_attr "type" "fmuld")
 (set_attr "length" "4")]
)

(define_insn "adddf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(plus:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  "faddd %0 = %1, %2"
[(set_attr "type" "faddd")
 (set_attr "length" "4")]
)

(define_expand "subdf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(minus:DF (match_operand:DF 1 "register_operand" "r")
	          (match_operand:DF 2 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*subdf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(minus:DF (match_operand:DF 2 "register_operand" "r")
	          (match_operand:DF 1 "register_operand" "r")))]
  ""
  "fsbfd %0 = %1, %2"
[(set_attr "type" "fsbfd")
 (set_attr "length" "4")]
)

(define_insn "sminsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(smin:SF (match_operand:SF 1 "register_operand" "r")
		 (match_operand:SF 2 "register_operand" "r")))]
  ""
  "fmin %0 = %1, %2"
[(set_attr "type" "alu")
 (set_attr "length" "4")]
)

(define_expand "smindf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(smin:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*fmind_k1b"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(smin:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  "fmind %0 = %1, %2"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "smaxsf3"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(smax:SF (match_operand:SF 1 "register_operand" "r")
		 (match_operand:SF 2 "register_operand" "r")))]
  ""
  "fmax %0 = %1, %2"
[(set_attr "type" "alu")
 (set_attr "length" "4")]
)

(define_expand "smaxdf3"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(smax:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*fmaxd_k1b"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(smax:DF (match_operand:DF 1 "register_operand" "r")
		 (match_operand:DF 2 "register_operand" "r")))]
  ""
  "fmaxd %0 = %1, %2"
[(set_attr "type" "alud")
 (set_attr "length" "4")]
)

(define_insn "fmasf4"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (plus:SF (mult:SF (match_operand:SF 1 "register_operand" "r")
                          (match_operand:SF 2 "register_operand" "r"))
                 (match_operand:SF 3 "register_operand" "r")))]
  ""
  "ffma %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fmadf4"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (plus:DF (mult:DF (match_operand:DF 1 "register_operand" "r")
                          (match_operand:DF 2 "register_operand" "r"))
                 (match_operand:DF 3 "register_operand" "r")))]
  ""
  "ffmad %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmarnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (plus:DF (mult:DF (unspec:DF [(match_operand:DF 1  "register_operand" "r")] UNSPEC_FPRN)
                          (unspec:DF [(match_operand:DF 2"register_operand" "r")] UNSPEC_FPRN))
                 (unspec:DF [(match_operand:DF 3"register_operand" "0")] UNSPEC_FPRN)))]
  ""
  "ffmadrn %0 = %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmarn"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (plus:SF (mult:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
                          (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                 (unspec:SF [(match_operand:SF 3 "register_operand" "0")] UNSPEC_FPRN)))]
  ""
  "ffmarn %0 = %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fmssf4"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (minus:SF (mult:SF (match_operand:SF 1 "register_operand" "r")
                           (match_operand:SF 2 "register_operand" "r"))
                  (match_operand:SF 3 "register_operand" "r")))]
  ""
  "ffmsn %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmsnrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (minus:SF (mult:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
                           (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                  (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "ffmsnrn %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fmsdf4"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (mult:DF (match_operand:DF 1 "register_operand" "r")
                           (match_operand:DF 2 "register_operand" "r"))
                  (match_operand:DF 3 "register_operand" "r")))]
  ""
  "ffmsnd %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmsnrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (mult:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
                           (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN))
                  (unspec:DF [(match_operand:DF 3 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "ffmsnrnd %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


(define_expand "fnmasf4"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (minus:SF (match_operand:SF 3 "register_operand" "r")
                  (mult:SF (match_operand:SF 1 "register_operand" "r")
		           (match_operand:SF 2 "register_operand" "r"))))]
  ""
  {}
)

(define_insn "*fnmasf4"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (minus:SF (match_operand:SF 3 "register_operand" "r")
                  (mult:SF (match_operand:SF 1 "register_operand" "r")
		           (match_operand:SF 2 "register_operand" "r"))))]
  ""
  "ffms %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmsrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (minus:SF (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN)
                  (mult:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
		           (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "ffmsrn %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fnmadf4"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (match_operand:DF 1 "register_operand" "r")
                  (mult:DF (match_operand:DF 2 "register_operand" "r")
		           (match_operand:DF 3 "register_operand" "r"))))]
  ""
  "ffmsd %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmsrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (unspec:DF [(match_operand:DF 3 "register_operand" "r")] UNSPEC_FPRN)
                  (mult:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
		           (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "ffmsrnd %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fnmssf4"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (neg:SF (plus:SF (mult:SF (match_operand:SF 1 "register_operand" "r")
                                  (match_operand:SF 2 "register_operand" "r"))
                         (match_operand:SF 3 "register_operand" "r"))))]
  ""
  "ffman %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "fnmsdf4"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (neg:DF (plus:DF (mult:DF (match_operand:DF 1 "register_operand" "r")
                                  (match_operand:DF 2 "register_operand" "r"))
                         (match_operand:DF 3 "register_operand" "r"))))]
  ""
  "ffmand %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmanrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (neg:SF (plus:SF (mult:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)
                                  (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "ffmanrn %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmanrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (neg:DF (plus:DF (mult:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
                                  (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN))
                         (unspec:DF [(match_operand:DF 3 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "ffmanrnd %0 = %3, %1, %2"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

/* Extended FMA */

(define_insn "ffmawd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (plus:DF (mult:DF (float_extend:DF (match_operand:SF 2 "register_operand" "r"))
                          (float_extend:DF (match_operand:SF 3 "register_operand" "r")))
                 (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmawd %0 = %1, %2, %3"
[(set_attr "type" "mau_lsu_fpu")
 (set_attr "length" "4")]
)

(define_insn "ffmarnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (plus:DF (mult:DF (float_extend:DF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                          (float_extend:DF (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN)))
                 (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "ffmarnwd %0 = %1, %2, %3"
[(set_attr "type" "mau_lsu_fpu")
 (set_attr "length" "4")]
)

(define_insn "ffmanwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (neg:DF (mult:DF (float_extend:DF (match_operand:SF 2 "register_operand" "r"))
                               	   (float_extend:DF (match_operand:SF 3 "register_operand" "r"))))
                  (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmanwd %0 = %1, %2, %3"
[(set_attr "type" "mau_lsu_fpu")
 (set_attr "length" "4")]
)

(define_insn "ffmanrnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (neg:DF (mult:DF (float_extend:DF (unspec:DF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                               	   (float_extend:DF (unspec:DF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN))))
                  (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "ffmanrnwd %0 = %1, %2, %3"
[(set_attr "type" "mau_lsu_fpu")
 (set_attr "length" "4")]
)

(define_insn "ffmsnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (mult:DF (float_extend:DF (match_operand:SF 2 "register_operand" "r"))
                           (float_extend:DF (match_operand:SF 3 "register_operand" "r")))
                  (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmsnwd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "ffmsnrnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (mult:DF (float_extend:DF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
                           (float_extend:DF (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN)))
                  (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "ffmsnrnwd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


(define_insn "ffmswd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (match_operand:DF 1 "register_operand" "r")
		  (mult:DF (float_extend:DF (match_operand:SF 2 "register_operand" "r"))
		  	   (float_extend:DF (match_operand:SF 3 "register_operand" "r")))))]
  ""
  "ffmswd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


(define_insn "ffmsrnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN)
		  (mult:DF (float_extend:DF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))
		  	   (float_extend:DF (unspec:SF [(match_operand:SF 3 "register_operand" "r")] UNSPEC_FPRN)))))]
  ""
  "ffmsrnwd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


/* Unsafe extended FMA */
/* These variants do not reflect the true semantic of the operation (which is 
   defined above). However, it should be safe to have more precision as a result
   of the mult most of the time, so we allow this variant. */

(define_insn "*ffmawd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (plus:DF (float_extend:DF (mult:SF (match_operand:SF 2 "register_operand" "r")
                                           (match_operand:SF 3 "register_operand" "r")))
                 (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmawd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

(define_insn "*ffmanwd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (neg:DF (float_extend:DF (mult:SF (match_operand:SF 2 "register_operand" "r")
                               	                    (match_operand:SF 3 "register_operand" "r"))))
                   (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmanwd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


(define_insn "*ffmsnwd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (float_extend:DF (mult:SF (match_operand:SF 2 "register_operand" "r")
                                            (match_operand:SF 3 "register_operand" "r")))
                  (match_operand:DF 1 "register_operand" "r")))]
  ""
  "ffmsnwd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)


(define_insn "*ffmswd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (minus:DF (match_operand:DF 1 "register_operand" "r")
		  (float_extend:DF (mult:SF (match_operand:SF 2 "register_operand" "r")
		  	                    (match_operand:SF 3 "register_operand" "r")))))]
  ""
  "ffmswd %0 = %1, %2, %3"
  [(set_attr "type" "mau_lsu_fpu")
   (set_attr "length" "4")]
)

/* Multiplications */
(define_insn "*fmuln"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(mult:SF (neg:SF (match_operand:SF 1 "register_operand" "r"))
			 (match_operand:SF 2 "register_operand" "r")))]
  ""
  "fmuln %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (float_extend:DF (match_operand:SF 1 "register_operand" "r"))
		 (float_extend:DF (match_operand:SF 2 "register_operand" "r"))))]
  ""
  "fmulwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulrnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (float_extend:DF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN))
		 (float_extend:DF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "fmulrnwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (neg:DF (float_extend:DF (match_operand:SF 1 "register_operand" "r")))
		 (float_extend:DF (match_operand:SF 2 "register_operand" "r"))))]
  ""
  "fmulnwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulnrnwd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (neg:DF (float_extend:DF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN)))
		 (float_extend:DF (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN))))]
  ""
  "fmulnrnwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "*fmulwd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(float_extend:DF (mult:SF (match_operand:SF 1 "register_operand" "r")
		                  (match_operand:SF 2 "register_operand" "r"))))]
  ""
  "fmulwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "*fmulnwd2"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(float_extend:DF (mult:SF (neg:SF (match_operand:SF 1 "register_operand" "r"))
		                  (match_operand:SF 2 "register_operand" "r"))))]
  ""
  "fmulnwd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fmulnrn"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(mult:SF (neg:SF (unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FPRN))
                         (unspec:SF [(match_operand:SF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fmulnrn %0 = %1, %2"
[(set_attr "type" "fmulnrn")
 (set_attr "length" "4")]
)

(define_insn "fmulnrnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (neg:DF (unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FPRN))
                         (unspec:DF [(match_operand:DF 2 "register_operand" "r")] UNSPEC_FPRN)))]
  ""
  "fmulnrnd %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "*fmulnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(mult:DF (neg:DF (match_operand:DF 1 "register_operand" "r"))
			 (match_operand:DF 2 "register_operand" "r")))]
  ""
  "fmulnd %0 = %1, %2"
[(set_attr "type" "fmulnd")
 (set_attr "length" "4")]
)

(define_mode_iterator F [(SF "") (DF "")])
(define_mode_attr sfx [(SF "") (DF "d") (SI "") (DI "d")] )
(define_mode_attr sched [(SF "mau_fpu") (DF "mau_lsu_fpu") (SI "mau_fpu") (DI "mau_lsu_fpu")])
(define_mode_attr int_type [(SF "SI") (DF "DI")])
(define_mode_attr float_type [(SI "SF") (DI "DF")])

(define_insn "float<F:sfx>_rn" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 0)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOAT))]
  ""
  "float<F:sfx>.rn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "float<F:sfx>_rp" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 1)
                    (match_operand:<int_type> 1 "register_operand" "r")
                    (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOAT))]
  ""
  "float<F:sfx>.rp %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "float<F:sfx>_rm" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 2)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOAT))]
  ""
  "float<F:sfx>.rm %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "float<F:sfx>_rz" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 3)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOAT))]
  ""
  "float<F:sfx>.rz %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_expand "float<F:sfx>" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(match_operand:SI 1 "twobits_unsigned_operand" "U02")
                   (match_operand:<int_type> 2 "register_operand" "r")
                   (match_operand:SI 3 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOAT))]
  ""
{}
)

(define_insn "floatu<F:sfx>_rn" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 0)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOATU))]
  ""
  "floatu<F:sfx>.rn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "floatu<F:sfx>_rp" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 1)
                    (match_operand:<int_type> 1 "register_operand" "r")
                    (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOATU))]
  ""
  "floatu<F:sfx>.rp %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "floatu<F:sfx>_rm" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 2)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOATU))]
  ""
  "floatu<F:sfx>.rm %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "floatu<F:sfx>_rz" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(const_int 3)
                   (match_operand:<int_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOATU))]
  ""
  "floatu<F:sfx>.rz %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_expand "floatu<F:sfx>" 
  [(set (match_operand:F 0 "register_operand" "=r")
	(unspec:F [(match_operand:SI 1 "twobits_unsigned_operand" "U02")
                   (match_operand:<int_type> 2 "register_operand" "r")
                   (match_operand:SI 3 "sixbits_unsigned_operand" "U06")] UNSPEC_FLOATU))]
  ""
{}
)


(define_insn "fixed<I:sfx>_rn" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 0)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXED))]
  ""
  "fixed<I:sfx>.rn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fixed<I:sfx>_rp" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 1)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXED))]
  ""
  "fixed<I:sfx>.rp %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fixed<I:sfx>_rm" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 2)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXED))]
  ""
  "fixed<I:sfx>.rm %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fixed<I:sfx>_rz" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 3)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXED))]
  ""
  "fixed<I:sfx>.rz %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_expand "fixed<I:sfx>" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(match_operand:SI 1 "twobits_unsigned_operand" "U02")
                   (match_operand:<float_type> 2 "register_operand" "r")
                   (match_operand:SI 3 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXED))]
  ""
{}
)


(define_insn "fixedu<I:sfx>_rn" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 0)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXEDU))]
  ""
  "fixedu<I:sfx>.rn %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fixedu<I:sfx>_rp" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 1)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXEDU))]
  ""
  "fixedu<I:sfx>.rp %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "fixedu<I:sfx>_rm" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 2)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXEDU))]
  ""
  "fixedu<I:sfx>.rm %0 = %1, %2"
[(set_attr "type" "mau_fpu")
  (set_attr "length" "4")]
)

(define_insn "fixedu<I:sfx>_rz" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(const_int 3)
                   (match_operand:<float_type> 1 "register_operand" "r")
                   (match_operand:SI 2 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXEDU))]
  ""
  "fixedu<I:sfx>.rz %0 = %1, %2"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_expand "fixedu<I:sfx>" 
  [(set (match_operand:I 0 "register_operand" "=r")
	(unspec:I [(match_operand:SI 1 "twobits_unsigned_operand" "U02")
                   (match_operand:<float_type> 2 "register_operand" "r")
                   (match_operand:SI 3 "sixbits_unsigned_operand" "U06")] UNSPEC_FIXEDU))]
  ""
{}
)


(define_expand "floatsisf2" 
  [(set (match_operand:SF 0 "register_operand" "=r")
        (float:SF (match_operand:SI 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_float_rn (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)


(define_expand "floatunssisf2" 
  [(set (match_operand:SF 0 "register_operand" "=r")
        (unsigned_float:SF (match_operand:SI 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_floatu_rn (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)


(define_expand "floatdidf2" 
  [(set (match_operand:DF 0 "register_operand" "=r")
        (float:DF (match_operand:DI 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_floatd_rn (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)


(define_expand "floatunsdidf2" 
  [(set (match_operand:DF 0 "register_operand" "=r")
        (unsigned_float:DF (match_operand:DI 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_floatud_rn (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)


(define_expand "fix_truncsfsi2"
  [(set (match_operand:SI 0 "register_operand" "=r")
        (fix:SI (match_operand:SF 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_fixed_rz (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)

(define_expand "fixuns_truncsfsi2"
  [(set (match_operand:SI 0 "register_operand" "=r")
        (unsigned_fix:SI (match_operand:SF 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_fixedu_rz (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)


(define_expand "fix_truncdfdi2"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (fix:DI (match_operand:DF 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_fixedd_rz (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)

(define_expand "fixuns_truncdfdi2"
  [(set (match_operand:DI 0 "register_operand" "=r")
        (unsigned_fix:DI (match_operand:DF 1 "register_operand" "r")))]
  ""
{
        emit_insn (gen_fixedud_rz (operands[0], operands[1], GEN_INT (0)));
        DONE;
}
)

(define_insn "truncdfsf2"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (float_truncate:SF
         (match_operand:DF 1 "register_operand" "r")))]
  ""
  "fnarrow %0 = %1"
[(set_attr "type" "mau_fpu")
 (set_attr "length" "4")]
)

(define_insn "builtin_truncsfhf2"
  [(set (match_operand:HI 0 "register_operand" "=r")
        (unspec [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FNARROWH))]
  ""
  "fnarrowh %0 = %1"
[(set_attr "type" "alu")
 (set_attr "length" "4")]
)

;; Beware that the half float are stored in 2 32bits words. They are /not/ packed.
(define_insn "builtin_truncv2sf_2hf2"
  [(set (match_operand:V2SI 0 "register_operand" "=r")
        (unspec [(match_operand:V2SF 1 "register_operand" "r")] UNSPEC_FNARROWH))]
  ""
  "fnarrowhwp %0 = %1"
[(set_attr "type" "alu")
 (set_attr "length" "4")]
)



(define_insn "fsdiv"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SF 1 "register_operand" "r")
		    (match_operand:SF 2 "register_operand" "r")] UNSPEC_FSDIV))]
  ""
  "fsdiv %0 = %1, %2"
  [(set_attr "type" "alu")
   (set_attr "length" "4")]
)

(define_insn "fcdiv"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SF 1 "register_operand" "r")
		    (match_operand:SF 2 "register_operand" "r")] UNSPEC_FCDIV))]
  ""
  "fcdiv %0 = %1, %2"
  [(set_attr "type" "alu")
   (set_attr "length" "4")]
)

(define_insn "fsinv"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FSINV))]
  ""
  "fsinv %0 = %1"
  [(set_attr "type" "alu")
   (set_attr "length" "4")]
)

(define_insn "fsinvn"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FSINVN))]
  ""
  "fsinvn %0 = %1"
  [(set_attr "type" "alu")
   (set_attr "length" "4")]
)

(define_insn "fsisr"
  [(set (match_operand:SF 0 "register_operand" "=r")
	(unspec:SF [(match_operand:SF 1 "register_operand" "r")] UNSPEC_FSISR))]
  ""
  "fsisr %0 = %1"
  [(set_attr "type" "alu")
   (set_attr "length" "4")]
)

;; PLACEHOLDER for fsdivd Bostan
(define_insn "fsdivd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(unspec:DF [(match_operand:DF 1 "register_operand" "r")
		    (match_operand:DF 2 "register_operand" "r")] UNSPEC_FSDIVD))]
  ""
  "fsdivd %0 = %1, %2"
  [(set_attr "type" "alud_x")
   (set_attr "length" "8")]
)

;; PLACEHOLDER for fcdivd Bostan
(define_insn "fcdivd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(unspec:DF [(match_operand:DF 1 "register_operand" "r")
		    (match_operand:DF 2 "register_operand" "r")] UNSPEC_FCDIVD))]
  ""
  "fcdivd %0 = %1, %2"
  [(set_attr "type" "alud_x")
   (set_attr "length" "8")]
)

;; PLACEHOLDER for fsinvd Bostan
(define_insn "fsinvd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FSINVD))]
  ""
  "fsinvd %0 = %1"
  [(set_attr "type" "alud_x")
   (set_attr "length" "8")]
)

;; PLACEHOLDER for fsinvnd bostan
(define_insn "fsinvnd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FSINVND))]
  ""
  "fsinvnd %d0 = %d1"
  [(set_attr "type" "alud_x")
   (set_attr "length" "8")]
)

;; PLACEHOLDER for fsisrd bostan
(define_insn "fsisrd"
  [(set (match_operand:DF 0 "register_operand" "=r")
	(unspec:DF [(match_operand:DF 1 "register_operand" "r")] UNSPEC_FSISRD))]
  ""
  "fsisrd %0 = %1"
  [(set_attr "type" "alud_x")
   (set_attr "length" "8")]
)

;; FIXME AUTO : Disable use of create_SC_*
;; (define_insn_and_split "*mulsc1"
;;   [(set (match_operand:SF 0 "register_operand" "=r")
;;         (plus:SF (mult:SF (match_operand:SF 1 "register_operand" "r")
;; 		  	  (match_operand:SF 2 "register_operand" "r"))
;; 	         (mult:SF (match_operand:SF 3 "register_operand" "r")
;; 		  	  (match_operand:SF 4 "register_operand" "r"))))]
;;   ""
;;   "mulsc1 not split!"
;;   ""
;;   [(set (match_dup 0) (unspec:SF [(match_dup 5) (match_dup 6)] UNSPEC_FCMA))]
;; {
;; 	operands[5] = k1_find_or_create_SC_register (curr_insn, operands[1], operands[3]);
;; 	operands[6] = k1_find_or_create_SC_register (curr_insn, operands[4], operands[2]);
;; }
;;   [(set_attr "type" "mau_fpu")
;;    (set_attr "length" "4")])
;;
;; (define_insn_and_split "*mulsc2"
;;   [(set (match_operand:SF 0 "register_operand" "=r")
;;         (minus:SF (mult:SF (match_operand:SF 1 "register_operand" "r")
;; 		  	   (match_operand:SF 2 "register_operand" "r"))
;; 	          (mult:SF (match_operand:SF 3 "register_operand" "r")
;; 	                   (match_operand:SF 4 "register_operand" "r"))))]
;;   ""
;;   "mulsc2 not split!"
;;   ""
;;   [(set (match_dup 0) (unspec:SF [(match_dup 5) (match_dup 6)] UNSPEC_FDMS))]
;; {
;; 	operands[5] = k1_find_or_create_SC_register (curr_insn, operands[1], operands[3]);
;; 	operands[6] = k1_find_or_create_SC_register (curr_insn, operands[2], operands[4]);
;; }
;;   [(set_attr "type" "mau_fpu")
;;    (set_attr "length" "4")])

(define_insn "fdma"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (unspec:SF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FDMA))]
  ""
  "fdma %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)

(define_insn "fdmawd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (unspec:DF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FDMAWD))]
  ""
  "fdmawd %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)

(define_insn "fcmawd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (unspec:DF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FCMAWD))]
  ""
  "fcmawd %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)

(define_insn "fcma"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (unspec:SF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FCMA))]
  ""
  "fcma %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)


(define_insn "fdms"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (unspec:SF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FDMS))]
  ""
  "fdms %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)


(define_insn "fdmswd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (unspec:DF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FDMSWD))]
  ""
  "fdmswd %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)

(define_insn "fcms"
  [(set (match_operand:SF 0 "register_operand" "=r")
        (unspec:SF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FCMS))]
  ""
  "fcms %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")]
)


(define_insn "fcmswd"
  [(set (match_operand:DF 0 "register_operand" "=r")
        (unspec:DF [(match_operand:SC 1 "register_operand" "r")
		    (match_operand:SC 2 "register_operand" "r")] UNSPEC_FCMSWD))]
  ""
  "fcmswd %0 = %1, %2"
  [(set_attr "type" "mau_fpu")
   (set_attr "length" "4")])

/*******************************************************************************
 Partially Rewrite commutative expression trees in smaller parallel expressions
********************************************************************************/

/* PLUS intentionally left out. PLUS chains often compose the result of
   another (serial) computation and doing the addition in parallel just
   adds latency at the output of the chain.  This argument is true for 
   all other commutative operators also, but experimental evidence shows 
   that it is more true for addition chains.*/
(define_code_iterator comm [ior xor mult and smax umax smin umin])

(define_insn_and_split "*<code>_tree4"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                   (match_operand:SI 2 "register_operand" "r"))
                         (match_operand:SI 3 "register_operand" "r"))
                (match_operand:SI 4 "register_operand" "r")))]
  ""
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 5) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 6) (comm:SI (match_dup 3) (match_dup 4)))
   (set (match_dup 0) (comm:SI (match_dup 5) (match_dup 6)))]
{
        operands[5] = gen_reg_rtx (SImode);
        operands[6] = gen_reg_rtx (SImode);
})

(define_insn_and_split "*<code>_tree5"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                            (match_operand:SI 2 "register_operand" "r"))
                                  (match_operand:SI 3 "register_operand" "r"))
                         (match_operand:SI 4 "register_operand" "r"))
                (match_operand:SI 5 "register_operand" "r")))]
  ""
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 6) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 7) (comm:SI (match_dup 3) (match_dup 4)))
   (set (match_dup 8) (comm:SI (match_dup 6) (match_dup 7)))
   (set (match_dup 0) (comm:SI (match_dup 8) (match_dup 5)))]
{
        operands[6] = gen_reg_rtx (SImode);
        operands[7] = gen_reg_rtx (SImode);
        operands[8] = gen_reg_rtx (SImode);
})

(define_insn_and_split "*<code>_tree6"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                                     (match_operand:SI 2 "register_operand" "r"))
                                           (match_operand:SI 3 "register_operand" "r"))
                                  (match_operand:SI 4 "register_operand" "r"))
                         (match_operand:SI 5 "register_operand" "r"))
                (match_operand:SI 6 "register_operand" "r")))]
  "0"
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 7) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 8) (comm:SI (match_dup 3) (match_dup 4)))
   (set (match_dup 9) (comm:SI (match_dup 7) (match_dup 8)))
   (set (match_dup 10) (comm:SI (match_dup 5) (match_dup 6)))
   (set (match_dup 0) (comm:SI (match_dup 9) (match_dup 10)))]
{
        operands[7] = gen_reg_rtx (SImode);
        operands[8] = gen_reg_rtx (SImode);
        operands[9] = gen_reg_rtx (SImode);
        operands[10] = gen_reg_rtx (SImode);
})

(define_insn_and_split "*<code>_tree7"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                                              (match_operand:SI 2 "register_operand" "r"))
                                                    (match_operand:SI 3 "register_operand" "r"))
                                           (match_operand:SI 4 "register_operand" "r"))
                                  (match_operand:SI 5 "register_operand" "r"))
                         (match_operand:SI 6 "register_operand" "r"))
                (match_operand:SI 7 "register_operand" "r")))]
  ""
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 8) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 9) (comm:SI (match_dup 3) (match_dup 4)))
   (set (match_dup 10) (comm:SI (match_dup 5) (match_dup 6)))
   (set (match_dup 11) (comm:SI (match_dup 8) (match_dup 9)))
   (set (match_dup 12) (comm:SI (match_dup 10) (match_dup 11)))
   (set (match_dup 0) (comm:SI (match_dup 12) (match_dup 7)))]
{
        operands[8] = gen_reg_rtx (SImode);
        operands[9] = gen_reg_rtx (SImode);
        operands[10] = gen_reg_rtx (SImode);
        operands[11] = gen_reg_rtx (SImode);
        operands[12] = gen_reg_rtx (SImode);
})

(define_insn_and_split "*<code>_tree8"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                                                       (match_operand:SI 2 "register_operand" "r"))
                                                             (match_operand:SI 3 "register_operand" "r"))
                                                    (match_operand:SI 4 "register_operand" "r"))
                                           (match_operand:SI 5 "register_operand" "r"))
                                  (match_operand:SI 6 "register_operand" "r"))
                         (match_operand:SI 7 "register_operand" "r"))
                (match_operand:SI 8 "register_operand" "r")))]
  ""
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 9) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 10) (comm:SI (match_dup 3) (match_dup 4)))
   (set (match_dup 11) (comm:SI (match_dup 5) (match_dup 6)))
   (set (match_dup 12) (comm:SI (match_dup 7) (match_dup 8)))
   (set (match_dup 13) (comm:SI (match_dup 9) (match_dup 10)))
   (set (match_dup 14) (comm:SI (match_dup 11) (match_dup 12)))
   (set (match_dup 0) (comm:SI (match_dup 13) (match_dup 14)))]
{
        operands[9] = gen_reg_rtx (SImode);
        operands[10] = gen_reg_rtx (SImode);
        operands[11] = gen_reg_rtx (SImode);
        operands[12] = gen_reg_rtx (SImode);
        operands[13] = gen_reg_rtx (SImode);
        operands[14] = gen_reg_rtx (SImode);
})

(define_insn_and_split "*<code>_tree9"
 [(set (match_operand:SI 0 "register_operand" "=r")
       (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI (comm:SI  (match_operand:SI 1 "register_operand" "r")
                                                                                (match_operand:SI 2 "register_operand" "r"))
                                                                      (match_operand:SI 3 "register_operand" "r"))
                                                             (match_operand:SI 4 "register_operand" "r"))
                                                    (match_operand:SI 5 "register_operand" "r"))
                                           (match_operand:SI 6 "register_operand" "r"))
                                  (match_operand:SI 7 "register_operand" "r"))
                         (match_operand:SI 8 "register_operand" "r"))
                (match_operand:SI 9 "register_operand" "r")))]
  ""
  "<code>_tree not split"
  "can_create_pseudo_p ()"
  [(set (match_dup 17) (comm:SI (match_dup 1) (match_dup 2)))
   (set (match_dup 10) (comm:SI (match_dup 17) (match_dup 3)))
   (set (match_dup 11) (comm:SI (match_dup 4) (match_dup 5)))
   (set (match_dup 12) (comm:SI (match_dup 10) (match_dup 6)))
   (set (match_dup 13) (comm:SI (match_dup 11) (match_dup 7)))
   (set (match_dup 14) (comm:SI (match_dup 12) (match_dup 8)))
   (set (match_dup 15) (comm:SI (match_dup 13) (match_dup 9)))
   (set (match_dup 0) (comm:SI (match_dup 14) (match_dup 15)))]
{
        operands[10] = gen_reg_rtx (SImode);
        operands[11] = gen_reg_rtx (SImode);
        operands[12] = gen_reg_rtx (SImode);
        operands[13] = gen_reg_rtx (SImode);
        operands[14] = gen_reg_rtx (SImode);
        operands[15] = gen_reg_rtx (SImode);
        operands[16] = gen_reg_rtx (SImode);
        operands[17] = gen_reg_rtx (SImode);
})



/******* Vector instructions **********/


(define_insn "addhp"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_ADDHP))]
  ""
  "addhp %0 = %1, %2"
  [(set_attr "type" "addhp")
   (set_attr "length" "4")]
)


;; (define_expand "abd"
;;   [(set (match_operand:SI 0 "register_operand" )
;;    (abs:SI (minus:SI (match_operand:SI 1 "nonmemory_operand" )
;;            (match_operand:SI 2 "register_operand" ))))]
;;   ""
;;   {}
;; )

(define_insn "abd"
  [(set (match_operand:SI 0 "register_operand" "=r,r,r")
	(abs:SI (minus:SI  (match_operand:SI 2 "nonmemory_operand" "r,I10,i")
	                   (match_operand:SI 1 "register_operand" "r,r,r"))))]
  ""
  "abd %0 = %1, %2"
  [(set_attr "type" "abd,abd,abd_x")
   (set_attr "length" "4,4,8")]
)

;; (define_insn "*abd_k1b"
;;   [(set (match_operand:SI 0 "register_operand" "=r")
;; 	(abs:SI (minus:SI  (match_operand:SI 2 "register_operand" "r")
;; 	                   (match_operand:SI 1 "register_operand" "r"))))]
;;   "k1_architecture () >= K1B"
;;   "abd %0 = %1, %2"
;;   [(set_attr "type" "alu")
;;    (set_attr "length" "4")]
;; )

;; (define_expand "abdd"
;;   [(set (match_operand:DI 0 "register_operand" )
;;    (abs:DI (minus:DI  (match_operand:DI 1 "nonmemory_operand" )
;;                       (match_operand:DI 2 "register_operand" ))))]
;;   ""
;;   {}
;; )


(define_insn "*abdd_k1b"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(abs:DI (minus:DI  (match_operand:DI 2 "register_operand" "r")
		           (match_operand:DI 1 "register_operand" "r"))))]
  ""
  "abdd %0 = %1, %2"
[(set_attr "type" "alud_lite")
 (set_attr "length" "4")]
)

;; Do not allow any immediate, only numerical ones :
;; we don't want to generate opxd + reloc, instead force
;; the compiler to materialise the symbol with maked
;; (define_insn "*abdd_k1a"
;;  [(set (match_operand:DI 0 "register_operand" "=r,r,r,r")
;; 	(abs:DI (minus:DI  (match_operand:DI 2 "nonmemory_operand" "r,I10,D37,n")
;; 		           (match_operand:DI 1 "register_operand" "r,r,r,r"))))]
;;   ""
;;   "abdd %d0 = %d1, %d2"
;; [(set_attr "type" "alud_x,alud_x,alud_y,alud_z")
;;  (set_attr "length" "8,8,12,16")]
;; )

(define_insn "abdhp"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_ABDHP))]
  ""
  "abdhp %0 = %1, %2"
  [(set_attr "type" "abdhp")
   (set_attr "length" "4")]
)

(define_insn "abdhq"
  [(set (match_operand:DI 0 "register_operand" "=r")
	(unspec:DI [(match_operand:DI 1 "register_operand" "r")
		    (match_operand:DI 2 "register_operand" "r")] UNSPEC_ABDHQ))]
  ""
  "abdhq %0 = %1, %2"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

(define_insn "sbfhp"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_SBFHP))]
  ""
  "sbfhp %0 = %1, %2"
  [(set_attr "type" "sbfhp")
   (set_attr "length" "4")]
)

(define_insn "sllhps"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_SLLHPS))]
  ""
  "sllhps %0 = %1, %2"
  [(set_attr "type" "shift32")
   (set_attr "length" "4")]
)

(define_insn "srahps"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_SRAHPS))]
  ""
  "srahps %0 = %1, %2"
  [(set_attr "type" "shift32")
   (set_attr "length" "4")]
)

(define_insn "landhp"
  [(set (match_operand:SI 0 "register_operand" "=r")
	(unspec:SI [(match_operand:SI 1 "register_operand" "r")
		    (match_operand:SI 2 "register_operand" "r")] UNSPEC_LANDHP))]
  ""
  "landhp %0 = %1, %2"
  [(set_attr "type" "landhp")
   (set_attr "length" "4")]
)

/********** Hardware loops **************/

 (define_expand "doloop_end"
   [(use (match_operand 0 "" ""))      ; loop pseudo
    (use (match_operand 1 "" ""))]     ; label
   "TARGET_HWLOOP && optimize >= 2"
   "
 {
   /* Currently SMS relies on the do-loop pattern to recognize loops
      where (1) the control part comprises of all insns defining and/or
      using a certain 'count' register and (2) the loop count can be
      adjusted by modifying this register prior to the loop.
.     ??? The possible introduction of a new block to initialize the
      new IV can potentially effects branch optimizations.  */
   if (optimize > 0)
   {
     rtx s0;
     rtx bcomp;
     rtx loc_ref;

     if (GET_MODE (operands[0]) != SImode)
       FAIL;

     s0 = operands [0];
     emit_move_insn (s0, gen_rtx_PLUS (SImode, s0, GEN_INT (-1)));
     bcomp = gen_rtx_NE(SImode, s0, const0_rtx);
     loc_ref = gen_rtx_LABEL_REF (VOIDmode, operands [1]);
     emit_jump_insn (gen_rtx_SET (VOIDmode, pc_rtx,
                                  gen_rtx_IF_THEN_ELSE (VOIDmode, bcomp,
                                                        loc_ref, pc_rtx)));

     DONE;
   }else
      FAIL;
 }")

(define_expand "doloop_begin"
   [(use (match_operand 0 "" ""))      ; loop pseudo
    (use (match_operand 1 "" ""))]     ; iterations; zero if unknown
   
   ""
{
   /* Pass a CONST_INT for now, we'll put the label in the end */
   emit_insn (gen_loopdo (operands[0], const0_rtx, k1_sync_reg_rtx, operands[0]));
   DONE;
}
)

;; Here, we let a symbol even if there are only 17bits of immediate value.
(define_insn "loopdo"
     [(set (match_operand:SI 0 "register_operand" "=r")
     	   (unspec_volatile:SI [(match_operand 1 "immediate_operand" "i")
			        (match_operand:SI 2 "system_register32_operand" "R32")
				(match_operand:SI 3 "register_operand" "0")] UNSPEC_LOOPDO))]
  ""
  "loopgtz %0, %1"
  [(set_attr "type" "all")
   (set_attr "length" "4")])

(define_insn "loopdo_end"
    [(set (pc)
          (if_then_else (unspec:SI [(const_int 0)] UNSPEC_LOOPDO_END)
            (match_operand 0 "immediate_operand" "i")
            (pc)))]
  ""
  "# HW loop end"
  [(set_attr "length" "0")])

/*********************************************************************************/
/********************************** SIMD *****************************************/
/*********************************************************************************/


/********************************** V2HI *****************************************/

(define_expand "movv2hi"
  [(set (match_operand:V2HI 0 "nonimmediate_operand" "")
	(match_operand 1 "general_operand" ""))]
""
{
        if (MEM_P(operands[0]) && can_create_pseudo_p()) {
           operands[1] = force_reg (V2HImode, operands[1]);
        }
})

(define_insn "*movv2hi_real"
  [(set (match_operand:V2HI 0 "nonimmediate_operand" "=r,r,r,a,m,r")
	(match_operand:V2HI 1 "general_operand"      " r,a,m,r,r,i"))]
  "(!immediate_operand(operands[1], V2HImode) || !memory_operand(operands[0], V2HImode))
    && !(memory_operand(operands[0], V2HImode) && memory_operand(operands[1], V2HImode))
    && !((memory_operand(operands[0], V2HImode) || memory_operand(operands[1], V2HImode)) && K1_FORCE_UNCACHED_LSU)"
{
    switch (which_alternative) {
    	   case 0: return "copyd %0 = %1";
	   case 1:
    	   case 2: return "lw%m1  %0 = %1";
	   case 3:
    	   case 4: return "sw%m0  %0 = %1";
	   case 5: return "make %0 = %1";
	   default: gcc_unreachable ();
    }
}
  [(set_attr "type" "tiny,lsu_load,lsu_load_x,lsu_store,lsu_store_x,tiny_x")
   (set_attr "length" "4,4,8,4,8,8")]
)

(define_insn "*movv2hi_uncached"
  [(set (match_operand:V2HI 0 "nonimmediate_operand" "=r,r,a,m")
	(match_operand:V2HI 1 "nonimmediate_operand" " a,m,r,r"))]
  "!(memory_operand(operands[0], V2HImode) && memory_operand(operands[1], V2HImode))
   && !(register_operand(operands[0], V2HImode) && register_operand(operands[1], V2HImode))
   && K1_FORCE_UNCACHED_LSU"
{
    switch (which_alternative) {
    	   case 0:
	   case 1:return "lwu%m1  %0 = %1";
    	   case 2:
	   case 3:return "swu%m0  %0 = %1";
	   default: gcc_unreachable ();
    }
}
  [(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
   (set_attr "length" "4,8,4,8")]
)

(define_expand "movmisalignv2hi"
  [(set (match_operand:V2HI 0 "nonimmediate_operand" "")
	(match_operand:V2HI 1 "general_operand" ""))]
  "!TARGET_STRICT_ALIGN"
{
	emit_move_insn (operands[0], operands[1]);
	DONE;
})

(define_insn "abdhp2"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(abs:V2HI (minus:V2HI (match_operand:V2HI 1 "register_operand" "r")
                              (match_operand:V2HI 2 "register_operand" "r"))))]
  ""
  "abdhp %0 = %1"
[(set_attr "type" "abdhp")]
)

(define_expand "absv2hi2"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(abs:SI (match_operand:V2HI 1 "register_operand" "r")))]
  ""
{
	rtx reg = gen_reg_rtx (V2HImode);
	rtvec v = rtvec_alloc (2);
        RTVEC_ELT (v, 0) = GEN_INT(0);	
        RTVEC_ELT (v, 1) = GEN_INT(0);	
	emit_move_insn (reg,
		        gen_rtx_CONST_VECTOR (V2HImode, v));
	emit_insn (gen_abdhp2 (operands[0], operands[1], reg));
	DONE;
}
)

(define_insn "addv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(plus:V2HI (match_operand:V2HI 1 "register_operand" "r")
		   (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "addhp %0 = %1, %2"
  [(set_attr "type" "abdhp")
   (set_attr "length" "4")]
)


(define_insn "ssaddv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
        (ss_plus:V2HI (match_operand:V2HI 1 "register_operand" "r")
                      (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "addshp %0 = %1, %2"
  [(set_attr "type" "addshp")
   (set_attr "length" "4")]
)


(define_insn "*cmovehp_even"
  [(set (match_operand:V2HI 0 "register_operand" "+r")
	(if_then_else:V2HI (eq
                          (zero_extract (match_operand:V2HI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:V2HI 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmovehp.even %0 = %1, %2"
  [(set_attr "type" "cmovehp")
   (set_attr "length" "4")]
)

(define_insn "*cmovehp_odd"
  [(set (match_operand:V2HI 0 "register_operand" "+r")
	(if_then_else:V2HI (ne
                          (zero_extract (match_operand:V2HI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_int 0))
		      (match_operand:V2HI 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmovehp.odd %0 = %1, %2"
  [(set_attr "type" "cmovehp")
   (set_attr "length" "4")]
)


(define_expand "cstorev2hi4" 
  [(set (match_operand:V2HI 0 "register_operand" "=r")
        (match_operator:V2HI 1 "comparison_operator"
	        [(match_operand:V2HI 2 "register_operand" "r")
	         (match_operand:V2HI 3 "register_operand" "r")]))]
  ""
  {}
)

(define_insn "*cstorev2hi4" 
  [(set (match_operand:V2HI 1 "register_operand" "=r")
        (match_operator:V2HI 0 "comparison_operator"
	        [(match_operand:V2HI 2 "register_operand" "r")
	         (match_operand:V2HI 3 "register_operand" "r")]))]
  ""
  "comphp.%0 %1 = %2, %3"
[(set_attr "type" "comphp")
 (set_attr "length" "4")]
)


(define_insn "*comphp_<mask_name>" 
  [(set (match_operand:V2HI 0 "register_operand" "=r")
        (mask_cond:V2HI (and:V2HI (match_operand:V2HI 1 "register_operand" "r")
	                          (match_operand:V2HI 2 "register_operand" "r"))
	              (match_dup 2)))]
  ""
  "comphp.<mask_name> %0 = %1, %u2"
[(set_attr "type" "comphp")
 (set_attr "length" "4")]
)

(define_insn "*comphp_<mask_name>_r" 
  [(set (match_operand:V2HI 0 "register_operand" "=r")
        (mask_cond:V2HI (and:V2HI (match_operand:V2HI 2 "register_operand" "r")
	                          (match_operand:V2HI 1 "register_operand" "r"))
	              (match_dup 1)))]
  ""
  "comphp.<mask_name> %0 = %1, %2"
[(set_attr "type" "comphp")
 (set_attr "length" "4")]
)

(define_insn "comphp_<mask_name2>" 
  [(set (match_operand:V2HI 0 "register_operand" "=r")
        (mask_cond:V2HI (and:V2HI (match_operand:SI 1 "register_operand" "r")
	                          (match_operand:SI 2 "register_operand" "r"))
	              (const_int 0)))]
  ""
  "comphp.<mask_name2> %0 = %1, %u2"
[(set_attr "type" "comphp")
 (set_attr "length" "4")]
)

(define_insn "uminv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(umin:V2HI (match_operand:V2HI 1 "register_operand" "r")
		   (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "minuhp %0 = %1, %2"
[(set_attr "type" "minuhp")
 (set_attr "length" "4")]
)

(define_insn "umaxv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(umax:V2HI (match_operand:V2HI 1 "register_operand" "r")
		   (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "maxuhp %0 = %1, %2"
[(set_attr "type" "maxuhp")
 (set_attr "length" "4")]
)

(define_insn "sminv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(smin:V2HI (match_operand:V2HI 1 "register_operand" "r")
		   (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "minhp %0 = %1, %2"
[(set_attr "type" "minhp")
 (set_attr "length" "4")]
)

(define_insn "smaxv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(smax:V2HI (match_operand:V2HI 1 "register_operand" "r")
		   (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  "maxhp %0 = %1, %2"
[(set_attr "type" "maxhp")
 (set_attr "length" "4")]
)


(define_expand "subv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(minus:V2HI (match_operand:V2HI 1 "register_operand" "r")
	            (match_operand:V2HI 2 "register_operand" "r")))]
  ""
  {}
)

(define_insn "*subv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(minus:V2HI (match_operand:V2HI 2 "register_operand" "r")
	            (match_operand:V2HI 1 "register_operand" "r")))]
  ""
  "sbfhp %0 = %1, %2"
[(set_attr "type" "sbfhp")
 (set_attr "length" "4")]
)

(define_insn "ashlv2hi3"
  [(set (match_operand:V2HI            0 "register_operand" "=r,=r")
	(ashift:V2HI (match_operand:V2HI 1 "register_operand" "r,r")
                     (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "sllhps %0 = %1, %2"
[(set_attr "type" "shift32,shift32")]
)


(define_insn "ashrv2hi3"
  [(set (match_operand:V2HI            0 "register_operand" "=r,=r")
	(ashiftrt:V2HI (match_operand:V2HI 1 "register_operand" "r,r")
                       (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "srahps %0 = %1, %2"
[(set_attr "type" "shift32,shift32")]
)

(define_insn "lshrv2hi3"
  [(set (match_operand:V2HI            0 "register_operand" "=r,=r")
	(lshiftrt:V2HI (match_operand:V2HI 1 "register_operand" "r,r")
                       (match_operand:SI 2 "shift_operand" "r,U06")))]
  ""
  "srlhps %0 = %1, %2"
[(set_attr "type" "shift32,shift32")]
)


(define_expand "andv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "")
	(and:V2HI (match_operand:V2HI 1 "register_operand" "")
		  (match_operand:V2HI 2 "register_operand" "")))]
  ""
{
	emit_insn (gen_andsi3 (simplify_gen_subreg (SImode, operands[0], V2HImode, 0),
                               simplify_gen_subreg (SImode, operands[1], V2HImode, 0),
		  	       simplify_gen_subreg (SImode, operands[2], V2HImode, 0)));
	DONE;
}
)

(define_expand "iorv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "")
	(ior:V2HI (match_operand:V2HI 1 "register_operand" "")
		  (match_operand:V2HI 2 "register_operand" "")))]
  ""
{
	emit_insn (gen_iorsi3 (simplify_gen_subreg (SImode, operands[0], V2HImode, 0),
                               simplify_gen_subreg (SImode, operands[1], V2HImode, 0),
		  	       simplify_gen_subreg (SImode, operands[2], V2HImode, 0)));
	DONE;
}
)


(define_expand "xorv2hi3"
  [(set (match_operand:V2HI 0 "register_operand" "")
	(xor:V2HI (match_operand:V2HI 1 "register_operand" "")
		  (match_operand:V2HI 2 "register_operand" "")))]
  ""
{
	emit_insn (gen_xorsi3 (simplify_gen_subreg (SImode, operands[0], V2HImode, 0),
                               simplify_gen_subreg (SImode, operands[1], V2HImode, 0),
		  	       simplify_gen_subreg (SImode, operands[2], V2HImode, 0)));
	DONE;
}
)

(define_expand "one_cmplv2hi2"
  [(set (match_operand:V2HI           0 "register_operand" "=r")
	(not:V2HI (match_operand:V2HI 1 "register_operand" "r")))]
  ""
{
	emit_insn (gen_one_cmplsi2 (simplify_gen_subreg (SImode, operands[0], V2HImode, 0),
                                    simplify_gen_subreg (SImode, operands[1], V2HImode, 0)));
	DONE;
});


(define_expand "cmovev2hi"
  [(set (match_operand:V2HI 0 "register_operand" "=r")
	(if_then_else:V2HI (match_operator 1 "comparison_operator" 
                          [(match_operand:V2HI 2 "register_operand" "r")
			   (const_int 0)])
		      (match_operand:V2HI 3 "register_operand" "r")
		      (match_operand:V2HI 4 "register_operand" "0")))]
  ""
  {}
)

(define_insn "*cmovev2hi"
  [(set (match_operand:V2HI 1 "register_operand" "+r")
	(if_then_else:V2HI (match_operator 0 "comparison_operator" 
                          [(match_operand:V2HI 2 "register_operand" "r")
			   (const_int 0)])
		      (match_operand:V2HI 3 "register_operand" "r")
		      (match_dup 1)))]
  ""
  "cmovehp.%0z %1 = %2, %3"
  [(set_attr "type" "cmovehp")
   (set_attr "length" "4")]
)

(define_insn "*cmove_evenv2hi"
  [(set (match_operand:V2HI 0 "register_operand" "+r")
	(if_then_else:V2HI (eq
                          (zero_extract (match_operand:V2HI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_vector:V2HI [(const_int 0)(const_int 0)]))
		      (match_operand:V2HI 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmovehp.even %0 = %1, %2"
  [(set_attr "type" "cmovehp")
   (set_attr "length" "4")]
)

(define_insn "*cmove_oddv2hi"
  [(set (match_operand:V2HI 0 "register_operand" "+r")
	(if_then_else:V2HI (ne
                          (zero_extract (match_operand:V2HI 1 "register_operand" "r")
			  		(const_int 1) (const_int 0))
			  (const_vector:V2HI [(const_int 0)(const_int 0)]))
		      (match_operand:V2HI 2 "register_operand" "r")
		      (match_dup 0)))]
  ""
  "cmovehp.odd %0 = %1, %2"
  [(set_attr "type" "cmovehp")
   (set_attr "length" "4")]
)



/********************************** V4HI *****************************************/

(define_expand "movv4hi"
   [(set (match_operand:V4HI 0 "nonimmediate_operand" "=r,=r,=r,=r,=r,=r,=a,=m")
         (match_operand:V4HI 1 "general_operand" " I16, D37, i, r, a, m, r, r"))]
   ""
{
        if (MEM_P(operands[0]) && can_create_pseudo_p()) {
           operands[1] = force_reg (V4HImode, operands[1]);
        }
})

;;PLACEHOLDER MAKED ORD K1B

;; FIXME AUTO: disable immediate variants for vector move
(define_insn "movv4hi_real"
   [(set (match_operand:V4HI 0 "nonimmediate_operand" "=r,r,r,a,m")
         (match_operand:V4HI 1 "general_operand"      " r,a,m,r,r"))]
   "(!immediate_operand(operands[1], V4HImode) || !memory_operand(operands[0], V4HImode))
    && !(memory_operand(operands[0], V4HImode) && memory_operand(operands[1], V4HImode))
    && !((memory_operand(operands[0], V4HImode) || memory_operand(operands[1], V4HImode)) && K1_FORCE_UNCACHED_LSU)"
{
    switch (which_alternative) {
    	   case 3: return "ord   %0 = %1, 0";
	   case 4:
	   case 5: return "ld%m1   %0 = %1";
	   case 6:
	   case 7: return "sd%m0   %0 = %1";
	   default: gcc_unreachable ();
    }
}
[(set_attr "type" "alud_x,lsu_load,lsu_load_x,lsu_store,lsu_store_x")
 (set_attr "length" "4,4,8,4,8")])

(define_insn "movv4hi_uncached"
   [(set (match_operand:V4HI 0 "nonimmediate_operand" "=r,r,a,m")
         (match_operand:V4HI 1 "nonimmediate_operand" " a,m,r,r"))]
   "!(memory_operand(operands[0], V4HImode) && memory_operand(operands[1], V4HImode))
    && !(register_operand(operands[0], V4HImode) && register_operand(operands[1], V4HImode))
    && K1_FORCE_UNCACHED_LSU"
{
    switch (which_alternative) {
	   case 0:
	   case 1: return "ldu%m1   %0 = %1";
	   case 2:
	   case 3: return "sdu%m0   %0 = %1";
	   default: gcc_unreachable ();
    }
}
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
 (set_attr "length" "4,8,4,8")])

(define_split
   [(set (match_operand:V4HI 0 "nonimmediate_operand" )
         (match_operand:V4HI 1 "general_operand" ))]
 "(!optimize_size
   || (small_operand (gen_lowpart (SImode, operands[1]), SImode)
       && small_operand (gen_highpart_mode (SImode, V4HImode, operands[1]), SImode)))
  && !MEM_P(operands[0]) && !MEM_P(operands[1])"
   [(set (match_dup 4) (match_dup 2))
    (set (match_dup 5) (match_dup 3))]
"
        if (!reload_completed && REG_P (operands[0]) && !reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	operands[4] = gen_lowpart (V2HImode, operands[0]);
	operands[2] = gen_lowpart (V2HImode, operands[1]);
	operands[5] = gen_highpart (V2HImode, operands[0]);
	operands[3] = gen_highpart (V2HImode, operands[1]);
")

(define_expand "movmisalignv4hi"
  [(set (match_operand:V4HI 0 "nonimmediate_operand" "")
	(match_operand:V4HI 1 "general_operand" ""))]
  "!TARGET_STRICT_ALIGN"
{
	emit_move_insn (operands[0], operands[1]);
	DONE;
})

(define_expand "absv4hi2"
  [(set (match_operand:V4HI            0 "register_operand" "=r")
	(abs:SI (match_operand:V4HI 1 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_absv2hi2 (gen_lowpart (V2HImode, operands[0]),
 			         gen_lowpart (V2HImode, operands[1])));
	emit_insn (gen_absv2hi2 (gen_highpart (V2HImode, operands[0]),
		     	         gen_highpart (V2HImode, operands[1])));
	DONE;
}
)

;; FIXME AUTO: disable move optim as it relies on high/low operations
;; (define_expand "cmovev4hi"
;;   [(set (match_operand:V4HI 0 "register_operand" "=r")
;; 	(if_then_else:V4HI (match_operator 1 "comparison_operator" 
;;                           [(match_operand:V4HI 2 "register_operand" "r")
;; 			   (const_int 0)])
;; 		      (match_operand:V4HI 3 "register_operand" "r")
;; 		      (match_operand:V4HI 4 "register_operand" "0")))]
;;   ""
;; {
;; 
;;         if (!reg_mentioned_p (operands[0], operands[1])
;;             && !reg_mentioned_p (operands[0], operands[2])
;;             && !reg_mentioned_p (operands[0], operands[3])
;;             && !reg_mentioned_p (operands[0], operands[4]))
;;                 emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));
;; 
;; 	emit_insn (gen_cmovev2hi (gen_lowpart (V2HImode, operands[0]),
;;                     	          operands[1],
;;                                   gen_lowpart (V2HImode, operands[2]),
;;                     	          gen_lowpart (V2HImode, operands[3]),
;;                     	          gen_lowpart (V2HImode, operands[4])));
;; 	emit_insn (gen_cmovev2hi (gen_highpart (V2HImode, operands[0]),
;;                     	          operands[1],
;;                                   gen_highpart (V2HImode, operands[2]),
;;                     	          gen_highpart (V2HImode, operands[3]),
;;                     	          gen_highpart (V2HImode, operands[4])));
;; }
;; )


(define_insn "addv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(plus:V4HI (match_operand:V4HI 1 "register_operand" "r")
		   (match_operand:V4HI 2 "register_operand" "r")))]
  ""
  "addhq %0 = %1, %2"
  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

(define_insn "ssaddv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
        (ss_plus:V4HI (match_operand:V4HI 1 "register_operand" "r")
                      (match_operand:V4HI 2 "register_operand" "r")))]
""
"addshq %0 = %1, %2"

  [(set_attr "type" "alud_lite")
   (set_attr "length" "4")]
)

(define_expand "cstorev4hi4" 
  [(set (match_operand:V4HI 0 "register_operand" "=r")
        (match_operator:V4HI 1 "comparison_operator"
	        [(match_operand:V4HI 2 "register_operand" "r")
	         (match_operand:V4HI 3 "register_operand" "r")]))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

        operands[1] = copy_rtx(operands[1]);
        PUT_MODE(operands[1], V2HImode);
	emit_insn (gen_cstorev2hi4 (gen_lowpart (V2HImode, operands[0]),
 			            operands[1],
 			            gen_lowpart (V2HImode, operands[2]),
 			            gen_lowpart (V2HImode, operands[3])));
	emit_insn (gen_cstorev2hi4 (gen_highpart (V2HImode, operands[0]),
		     	            operands[1],
 			            gen_highpart (V2HImode, operands[2]),
 			            gen_highpart (V2HImode, operands[3])));
	DONE;
})

(define_expand "uminv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(umin:V4HI (match_operand:V4HI 1 "register_operand" "r")
		   (match_operand:V4HI 2 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_uminv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			          gen_lowpart (V2HImode, operands[1]),
 			          gen_lowpart (V2HImode, operands[2])));
	emit_insn (gen_uminv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          gen_highpart (V2HImode, operands[2])));
	DONE;
})

(define_expand "umaxv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(umax:V4HI (match_operand:V4HI 1 "register_operand" "r")
		   (match_operand:V4HI 2 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_umaxv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			          gen_lowpart (V2HImode, operands[1]),
 			          gen_lowpart (V2HImode, operands[2])));
	emit_insn (gen_umaxv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          gen_highpart (V2HImode, operands[2])));
	DONE;
})

(define_expand "sminv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(smin:V4HI (match_operand:V4HI 1 "register_operand" "r")
		   (match_operand:V4HI 2 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_sminv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			          gen_lowpart (V2HImode, operands[1]),
 			          gen_lowpart (V2HImode, operands[2])));
	emit_insn (gen_sminv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          gen_highpart (V2HImode, operands[2])));
	DONE;
})

(define_expand "smaxv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(smax:V4HI (match_operand:V4HI 1 "register_operand" "r")
		   (match_operand:V4HI 2 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_smaxv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			          gen_lowpart (V2HImode, operands[1]),
 			          gen_lowpart (V2HImode, operands[2])));
	emit_insn (gen_smaxv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          gen_highpart (V2HImode, operands[2])));
	DONE;
})


(define_expand "subv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "=r")
	(minus:V4HI (match_operand:V4HI 1 "register_operand" "r")
	            (match_operand:V4HI 2 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_subv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			         gen_lowpart (V2HImode, operands[1]),
 			         gen_lowpart (V2HImode, operands[2])));
	emit_insn (gen_subv2hi3 (gen_highpart (V2HImode, operands[0]),
                                 gen_highpart (V2HImode, operands[1]),
 			         gen_highpart (V2HImode, operands[2])));
	DONE;
})

(define_expand "ashlv4hi3"
  [(set (match_operand:V4HI            0 "register_operand" "=r")
	(ashift:V4HI (match_operand:V4HI 1 "register_operand" "r")
                     (match_operand:SI 2 "shift_operand" "ri")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_ashlv2hi3 (gen_lowpart (V2HImode, operands[0]),
 		                  gen_lowpart (V2HImode, operands[1]),
 			          operands[2]));
	emit_insn (gen_ashlv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          operands[2]));
	DONE;
})


(define_expand "ashrv4hi3"
  [(set (match_operand:V4HI            0 "register_operand" "=r")
	(ashiftrt:V4HI (match_operand:V4HI 1 "register_operand" "r")
                       (match_operand:SI 2 "shift_operand" "ri")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_ashrv2hi3 (gen_lowpart (V2HImode, operands[0]),
 		                  gen_lowpart (V2HImode, operands[1]),
 			          operands[2]));
	emit_insn (gen_ashrv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          operands[2]));
	DONE;
})

(define_expand "lshrv4hi3"
  [(set (match_operand:V4HI            0 "register_operand" "=r")
	(lshiftrt:V4HI (match_operand:V4HI 1 "register_operand" "r")
                       (match_operand:SI 2 "shift_operand" "ri")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_lshrv2hi3 (gen_lowpart (V2HImode, operands[0]),
 			          gen_lowpart (V2HImode, operands[1]),
 			          operands[2]));
	emit_insn (gen_lshrv2hi3 (gen_highpart (V2HImode, operands[0]),
                                  gen_highpart (V2HImode, operands[1]),
 			          operands[2]));
	DONE;
})


(define_expand "andv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "")
	(and:V4HI (match_operand:V4HI 1 "register_operand" "")
		  (match_operand:V4HI 2 "register_operand" "")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_andsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_andsi3 (gen_highpart (SImode, operands[0]),
                               gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)

(define_expand "iorv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "")
	(ior:V4HI (match_operand:V4HI 1 "register_operand" "")
		  (match_operand:V4HI 2 "register_operand" "")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_iorsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_iorsi3 (gen_highpart (SImode, operands[0]),
                               gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)


(define_expand "xorv4hi3"
  [(set (match_operand:V4HI 0 "register_operand" "")
	(xor:V4HI (match_operand:V4HI 1 "register_operand" "")
		  (match_operand:V4HI 2 "register_operand" "")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_xorsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_xorsi3 (gen_highpart (SImode, operands[0]),
                               gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)

(define_expand "one_cmplv4hi2"
  [(set (match_operand:V4HI           0 "register_operand" "=r")
	(not:V4HI (match_operand:V4HI 1 "register_operand" "r")))]
  ""
{
        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	emit_insn (gen_one_cmplsi2 (gen_lowpart (SImode, operands[0]),
                                    gen_lowpart (SImode, operands[1])));
	emit_insn (gen_one_cmplsi2 (gen_highpart (SImode, operands[0]),
                                    gen_highpart (SImode, operands[1])));
	DONE;
});

(define_expand "vcondv4hiv4hi"
  [(set (match_operand:V4HI 0 "register_operand" "")
        (if_then_else:V4HI
          (match_operator 3 ""
            [(match_operand:V4HI 4 "nonimmediate_operand" "")
             (match_operand:V4HI 5 "nonimmediate_operand" "")])
          (match_operand:V4HI 1 "general_operand" "")
          (match_operand:V4HI 2 "general_operand" "")))]
  ""
{
	operands[0] = force_reg (V4HImode, operands[0]);
	operands[1] = force_reg (V4HImode, operands[1]);
	operands[2] = force_reg (V4HImode, operands[2]);
	operands[4] = force_reg (V4HImode, operands[4]);
	operands[5] = force_reg (V4HImode, operands[5]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3])
            && !reg_mentioned_p (operands[0], operands[4])
            && !reg_mentioned_p (operands[0], operands[5]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	k1_expand_vcondv4hi (operands);
	DONE;
})

(define_expand "vconduv4hiv4hi"
  [(set (match_operand:V4HI 0 "register_operand" "")
        (if_then_else:V4HI
          (match_operator 3 ""
            [(match_operand:V4HI 4 "nonimmediate_operand" "")
             (match_operand:V4HI 5 "nonimmediate_operand" "")])
          (match_operand:V4HI 1 "general_operand" "")
          (match_operand:V4HI 2 "general_operand" "")))]
  ""
{
	operands[0] = force_reg (V4HImode, operands[0]);
	operands[1] = force_reg (V4HImode, operands[1]);
	operands[2] = force_reg (V4HImode, operands[2]);
	operands[4] = force_reg (V4HImode, operands[4]);
	operands[5] = force_reg (V4HImode, operands[5]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3])
            && !reg_mentioned_p (operands[0], operands[4])
            && !reg_mentioned_p (operands[0], operands[5]))
                emit_insn (gen_rtx_CLOBBER (V4HImode, operands[0]));

	k1_expand_vcondv4hi (operands);
	DONE;
})

/********************************** V2SI *****************************************/

(define_expand "movv2si"
   [(set (match_operand:V2SI 0 "nonimmediate_operand" "")
         (match_operand:V2SI 1 "general_operand" " "))]
   ""
{
        if (MEM_P(operands[0]) && can_create_pseudo_p()) {
           operands[1] = force_reg (V2SImode, operands[1]);
        }
}
)

;; FIXME AUTO: disable immediate variant of movv2si
(define_insn "movv2si_k1b"
   [(set (match_operand:V2SI 0 "nonimmediate_operand" "=r, r, r, a, m")
         (match_operand:V2SI 1 "nonimmediate_operand" " r, a, m, r, r"))]
   "(!immediate_operand(operands[1], V2SImode) || !memory_operand(operands[0], V2SImode))
    && !(memory_operand(operands[0], V2SImode) && memory_operand(operands[1], V2SImode))
    && !((memory_operand(operands[0], V2SImode) || memory_operand(operands[1], V2SImode)) && K1_FORCE_UNCACHED_LSU)"
{
    switch (which_alternative) {
    	   case 0: return "copyd   %0 = %1";
	   case 1:
	   case 2: return "ld%m1   %0 = %1";
	   case 3:
	   case 4: return "sd%m0   %0 = %1";
	   default: gcc_unreachable ();
    }
}
[(set_attr "type" "alud_lite,lsu_load,lsu_load_x,lsu_store,lsu_store_x")
 (set_attr "length" "4,4,8,4,8")]
)

(define_insn "movv2si__uncachedk1b"
   [(set (match_operand:V2SI 0 "nonimmediate_operand" "=r,r,a,m")
         (match_operand:V2SI 1 "nonimmediate_operand" " a,m,r,r"))]
   "!(memory_operand(operands[0], V2SImode) && memory_operand(operands[1], V2SImode))
    && !(register_operand(operands[0], V2SImode) && register_operand(operands[1], V2SImode))
    && K1_FORCE_UNCACHED_LSU"

{
    switch (which_alternative) {
    	   case 0:
	   case 1:return "ldu%m1   %0 = %1";
	   case 2:
	   case 3:return "sdu%m0   %0 = %1";
	   default: gcc_unreachable ();
    }
}
[(set_attr "type" "lsu_load_uncached,lsu_load_uncached_x,lsu_store,lsu_store_x")
 (set_attr "length" "4,8,4,8")]
)

(define_expand "movmisalignv2si"
  [(set (match_operand:V2SI 0 "nonimmediate_operand" "")
	(match_operand:V2SI 1 "general_operand" ""))]
  "!TARGET_STRICT_ALIGN"
{
	emit_move_insn (operands[0], operands[1]);
	DONE;
})


(define_insn "addv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "=r")
	(plus:V2SI (match_operand:V2SI 1 "register_operand" "r")
		   (match_operand:V2SI 2 "register_operand" "r")))]
  ""
  "addwp %0 = %1, %2"
[(set_attr "type" "alud_lite")
(set_attr "length" "4")])

(define_expand "subv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(minus:V2SI (match_operand:V2SI 1 "register_operand" "")
                    (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	if (MEM_P (operands[2]))
		operands[1] = force_reg (V2SImode, operands[1]);
	operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_subsi3 (gen_lowpart (SImode, operands[0]),
		  	       gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_subsi3 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
})


(define_expand "mulv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(mult:V2SI (match_operand:V2SI 1 "register_operand" "")
		   (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_mulsi3 (gen_lowpart (SImode, operands[0]),
		  	       gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_mulsi3 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
})

(define_expand "uminv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(umin:V2SI (match_operand:V2SI 1 "register_operand" "")
		   (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_uminsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	       	gen_lowpart (SImode, operands[2])));
	emit_insn (gen_uminsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        gen_highpart (SImode, operands[2])));
	DONE;
})

(define_expand "umaxv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(umax:V2SI (match_operand:V2SI 1 "register_operand" "")
		   (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_umaxsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	       	gen_lowpart (SImode, operands[2])));
	emit_insn (gen_umaxsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        gen_highpart (SImode, operands[2])));
	DONE;
})


(define_expand "sminv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(smin:V2SI (match_operand:V2SI 1 "register_operand" "")
		   (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_sminsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	       	gen_lowpart (SImode, operands[2])));
	emit_insn (gen_sminsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        gen_highpart (SImode, operands[2])));
	DONE;
})

(define_expand "smaxv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(smax:V2SI (match_operand:V2SI 1 "register_operand" "")
		   (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_smaxsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	       	gen_lowpart (SImode, operands[2])));
	emit_insn (gen_smaxsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        gen_highpart (SImode, operands[2])));
	DONE;
})


(define_expand "andv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(and:V2SI (match_operand:V2SI 1 "register_operand" "")
		  (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_andsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	      	gen_lowpart (SImode, operands[2])));
	emit_insn (gen_andsi3 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)

(define_expand "iorv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(ior:V2SI (match_operand:V2SI 1 "register_operand" "")
		  (match_operand:V2SI 2 "nonmemory_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_iorsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_iorsi3 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)


(define_expand "xorv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "")
	(xor:V2SI (match_operand:V2SI 1 "register_operand" "")
		  (match_operand:V2SI 2 "register_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_xorsi3 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1]),
		  	       gen_lowpart (SImode, operands[2])));
	emit_insn (gen_xorsi3 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1]),
		  	       gen_highpart (SImode, operands[2])));
	DONE;
}
)


(define_expand "ashlv2si3"
  [(set (match_operand:V2SI            0 "register_operand" "")
	(ashift:V2SI (match_operand:V2SI 1 "register_operand" "")
                     (match_operand:SI 2 "shift_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_ashlsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	        operands[2]));
	emit_insn (gen_ashlsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        operands[2]));
	DONE;
}
)

(define_expand "ashrv2si3"
  [(set (match_operand:V2SI            0 "register_operand" "")
	(ashiftrt:V2SI (match_operand:V2SI 1 "register_operand" "")
		       (match_operand:SI 2 "shift_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_ashrsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	        operands[2]));
	emit_insn (gen_ashrsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        operands[2]));
	DONE;
}
)

(define_expand "lshrv2si3"
  [(set (match_operand:V2SI            0 "register_operand" "=r")
	(lshiftrt:V2SI (match_operand:V2SI 1 "register_operand" "r")
		       (match_operand:SI 2 "shift_operand" "ri")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_lshrsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	        operands[2]));
	emit_insn (gen_lshrsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        operands[2]));
	DONE;
}
)


(define_expand "rotrv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "=r")
	(rotatert:SI (match_operand:V2SI 1 "register_operand" "r")
	  	     (match_operand:SI 2 "rotate_operand" "rU05")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_rotrsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	        operands[2]));
	emit_insn (gen_rotrsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        operands[2]));
	DONE;
}
)


(define_expand "rotlv2si3"
  [(set (match_operand:V2SI 0 "register_operand" "=r")
	(rotate:V2SI (match_operand:V2SI 1 "register_operand" "r")
	             (match_operand:SI 2 "rotate_operand" "rU05")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	if (MEM_P (operands[2]))
		operands[2] = force_reg (V2SImode, operands[2]);

        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_rotlsi3 (gen_lowpart (SImode, operands[0]),
                                gen_lowpart (SImode, operands[1]),
		  	        operands[2]));
	emit_insn (gen_rotlsi3 (gen_highpart (SImode, operands[0]),
		  	        gen_highpart (SImode, operands[1]),
		  	        operands[2]));
	DONE;
}
)



(define_expand "absv2si2"
  [(set (match_operand:V2SI            0 "register_operand" "=r")
	(abs:V2SI (match_operand:V2SI 1 "register_operand" "r")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);

        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_abssi2 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1])));
	emit_insn (gen_abssi2 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1])));
	DONE;
}
)

(define_expand "clzv2si2"
  [(set (match_operand:V2SI            0 "register_operand" "=r")
	(clz:V2SI (match_operand:V2SI 1 "register_operand" "r")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);

        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_clzsi2 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1])));
	emit_insn (gen_clzsi2 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1])));
	DONE;
}
)

(define_expand "ctzv2si2"
  [(set (match_operand:SI         0 "register_operand" "=r")
	(ctz:SI (match_operand:SI 1 "register_operand" "r")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);

        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_ctzsi2 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1])));
	emit_insn (gen_ctzsi2 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1])));
	DONE;
}
)

(define_expand "one_cmplv2si2"
  [(set (match_operand:V2SI           0 "register_operand" "=r")
	(not:V2SI (match_operand:V2SI 1 "register_operand" "r")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);

        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_one_cmplsi2 (gen_lowpart (SImode, operands[0]),
                                    gen_lowpart (SImode, operands[1])));
	emit_insn (gen_one_cmplsi2 (gen_highpart (SImode, operands[0]),
		  	            gen_highpart (SImode, operands[1])));
	DONE;
}
)

(define_expand "negv2si2"
  [(set (match_operand:V2SI           0 "register_operand" "=r")
	(neg:V2SI (match_operand:V2SI 1 "register_operand" "r")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);

        if (!reg_mentioned_p (operands[0], operands[1]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));
	emit_insn (gen_negsi2 (gen_lowpart (SImode, operands[0]),
                               gen_lowpart (SImode, operands[1])));
	emit_insn (gen_negsi2 (gen_highpart (SImode, operands[0]),
		  	       gen_highpart (SImode, operands[1])));
	DONE;
}
)


(define_expand "cstorev2si4" 
  [(set (match_operand:V2SI 0 "register_operand" "")
        (match_operator:V2SI 1 "comparison_operator"
	        [(match_operand:V2SI 2 "register_operand" "")
	         (match_operand:V2SI 3 "register_operand" "")]))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[2] = force_reg (V2SImode, operands[2]);
	operands[3] = force_reg (V2SImode, operands[3]);

        if (!reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3]))
                emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));

        operands[1] = copy_rtx (operands[1]);
        PUT_MODE (operands[1], SImode);

	emit_insn (gen_cstoresi4 (gen_lowpart (SImode, operands[0]),
                                  operands[1],
                                  gen_lowpart (SImode, operands[2]),
                                  gen_lowpart (SImode, operands[3])));
	emit_insn (gen_cstoresi4 (gen_highpart (SImode, operands[0]),
		  	          operands[1],
                                  gen_highpart (SImode, operands[2]),
                                  gen_highpart (SImode, operands[3])));
	DONE;
}
)


(define_expand "vcondv2siv2si"
  [(set (match_operand:V2SI 0 "register_operand" "")
        (if_then_else:V2SI
          (match_operator 3 ""
            [(match_operand:V2SI 4 "nonimmediate_operand" "")
             (match_operand:V2SI 5 "nonimmediate_operand" "")])
          (match_operand:V2SI 1 "general_operand" "")
          (match_operand:V2SI 2 "general_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	operands[2] = force_reg (V2SImode, operands[2]);
	operands[4] = force_reg (V2SImode, operands[4]);
	operands[5] = force_reg (V2SImode, operands[5]);
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3])
            && !reg_mentioned_p (operands[0], operands[4])
            && !reg_mentioned_p (operands[0], operands[5]))
            emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));

      	k1_expand_vcondv2si (operands);
	DONE;
})

(define_expand "vconduv2siv2si"
  [(set (match_operand:V2SI 0 "register_operand" "")
        (if_then_else:V2SI
          (match_operator 3 ""
            [(match_operand:V2SI 4 "nonimmediate_operand" "")
             (match_operand:V2SI 5 "nonimmediate_operand" "")])
          (match_operand:V2SI 1 "general_operand" "")
          (match_operand:V2SI 2 "general_operand" "")))]
  ""
{
	operands[0] = force_reg (V2SImode, operands[0]);
	operands[1] = force_reg (V2SImode, operands[1]);
	operands[2] = force_reg (V2SImode, operands[2]);
	operands[4] = force_reg (V2SImode, operands[4]);
	operands[5] = force_reg (V2SImode, operands[5]);
        if (!reg_mentioned_p (operands[0], operands[1])
            && !reg_mentioned_p (operands[0], operands[2])
            && !reg_mentioned_p (operands[0], operands[3])
            && !reg_mentioned_p (operands[0], operands[4])
            && !reg_mentioned_p (operands[0], operands[5]))
            emit_insn (gen_rtx_CLOBBER (V2SImode, operands[0]));

      	k1_expand_vcondv2si (operands);
	DONE;
})

/* ====================================================================== */
/*                            Reload stuff                                */

(define_expand "reload_in_gotoff_<mode>"
  [(parallel [(set (match_operand:P 0 "register_operand" "=&r")
                   (match_operand:P 1 "immediate_operand" "i"))
              (clobber (match_operand:P 2 "register_operand" "=&r"))])]
  "flag_pic"
    {
    tree gpdisp = get_identifier ("_gp_disp");
        
        rtx gp_disp = gen_rtx_SYMBOL_REF (<MODE>mode, IDENTIFIER_POINTER (gpdisp));

        emit_insn (gen_set_gotp_<mode>(operands[0], gen_rtx_REG(<MODE>mode, PC_REGNUM),
                                       operands[2], gp_disp));
        emit_insn (gen_add<mode>3 (operands[0], operands[2], operands[0]));
        emit_insn (gen_add<mode>3 (operands[0], operands[0], gen_rtx_CONST (<MODE>mode,gen_rtx_UNSPEC (<MODE>mode, gen_rtvec (1, operands[1]), UNSPEC_GOTOFF))));
  DONE;
})

(include "simd.md")
